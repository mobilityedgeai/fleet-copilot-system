<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Copilot BI - Dashboard Corporativo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #14b8a6;
            --primary-dark: #0f766e;
            --background: #14181B;
            --surface: #3c444c;
            --surface-dark: #21262b;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --border: #374151;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --table-header: #21262b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Cards de Navegação */
        .nav-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(20, 184, 166, 0.15);
        }

        .nav-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--surface) 0%, rgba(20, 184, 166, 0.1) 100%);
        }

        .nav-card-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            fill: var(--primary);
        }

        .nav-card h3 {
            font-size: 1.25rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        .nav-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Seção de Filtros */
        .filters-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            display: none;
        }

        .filters-section.active {
            display: block;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .filter-group select,
        .filter-group input {
            background: var(--surface-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--surface-dark);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Abas */
        .tabs {
            display: flex;
            background: var(--surface);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 16px 20px;
            background: var(--surface-dark);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--border);
            color: var(--text);
        }

        /* Conteúdo das Abas */
        .tab-content {
            background: var(--surface);
            border-radius: 0 0 12px 12px;
            padding: 24px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tabelas */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--table-header);
            color: var(--text);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(20, 184, 166, 0.05);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-conforme {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-pendente {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-nao-conforme {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Paginação */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--surface-dark);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: var(--primary);
            border-color: var(--primary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .nav-cards {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                flex-direction: column;
            }

            .filter-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cards de Navegação -->
        <div class="nav-cards">
            <div class="nav-card active" data-collection="checklist">
                <svg class="nav-card-icon" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h3>Checklist</h3>
                <p>Inspeções e verificações de conformidade</p>
            </div>
            <div class="nav-card" data-collection="trips">
                <svg class="nav-card-icon" viewBox="0 0 24 24">
                    <path d="M8 17l4 4 4-4m-4-5v9m-6-9a9 9 0 1118 0"/>
                </svg>
                <h3>Viagens</h3>
                <p>Rotas e deslocamentos da frota</p>
            </div>
            <div class="nav-card" data-collection="alerts">
                <svg class="nav-card-icon" viewBox="0 0 24 24">
                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h3>Alertas</h3>
                <p>Notificações e eventos importantes</p>
            </div>
            <div class="nav-card" data-collection="maintenance">
                <svg class="nav-card-icon" viewBox="0 0 24 24">
                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <h3>Manutenção</h3>
                <p>Serviços e reparos da frota</p>
            </div>
        </div>

        <!-- Seção de Filtros -->
        <div class="filters-section active" id="filtersSection">
            <h3 style="margin-bottom: 20px; color: var(--text);">Filtros</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="dateStart">Data Inicial</label>
                    <input type="date" id="dateStart">
                </div>
                <div class="filter-group">
                    <label for="dateEnd">Data Final</label>
                    <input type="date" id="dateEnd">
                </div>
                <div class="filter-group">
                    <label for="responsibleFilter">Responsável</label>
                    <select id="responsibleFilter">
                        <option value="">Todos os responsáveis</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="plateFilter">Placa</label>
                    <select id="plateFilter">
                        <option value="">Todas as placas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="assetTypeFilter">Tipo de Ativo</label>
                    <select id="assetTypeFilter">
                        <option value="">Todos os tipos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="driverFilter">Motorista</label>
                    <select id="driverFilter">
                        <option value="">Todos os motoristas</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Aplicar Filtros
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4 4h16v2.586a1 1 0 01-.293.707L14 13v6l-4-4V13L4.293 7.293A1 1 0 014 6.586V4z"/>
                    </svg>
                    Limpar
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    Excel
                </button>
                <button class="btn btn-secondary" onclick="exportToPDF()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                        <path d="M14 2v6h6"/>
                    </svg>
                    PDF
                </button>
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="compliantCount">-</div>
                <div class="stat-label">Conformes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingCount">-</div>
                <div class="stat-label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="complianceRate">-</div>
                <div class="stat-label">% Conformidade</div>
            </div>
        </div>

        <!-- Abas -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Visão Geral</button>
            <button class="tab" data-tab="status">Por Status</button>
            <button class="tab" data-tab="non-compliant">Não Conformes</button>
        </div>

        <!-- Conteúdo das Abas -->
        <div class="tab-content active" id="overview">
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Placa</th>
                            <th>Tipo de Ativo</th>
                            <th>Item</th>
                            <th>Responsável</th>
                            <th>Motorista</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="loading-spinner"></div>
                                Carregando dados...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <div class="tab-content" id="status">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
                <div>
                    <canvas id="statusChart" width="400" height="400"></canvas>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Quantidade</th>
                                <th>Percentual</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-content" id="non-compliant">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Placa</th>
                            <th>Item</th>
                            <th>Responsável</th>
                            <th>Comentários</th>
                        </tr>
                    </thead>
                    <tbody id="nonCompliantTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuração
        const CONFIG = {
            API_BASE_URL: 'https://firebase-bi-api.onrender.com',
            ENTERPRISE_ID: getUrlParameter('enterpriseId') || 'sA9EmrE3ymtnBqJKcYn7',
            DAYS: parseInt(getUrlParameter('days')) || 30,
            ITEMS_PER_PAGE: 50
        };

        // Estado global
        let currentData = [];
        let filteredData = [];
        let currentPage = 1;
        let currentCollection = 'checklist';

        // Função para obter parâmetros da URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📊 Fleet Copilot BI carregado');
            console.log('🎨 Tema: Escuro com cores teal/turquesa');
            console.log('🔧 Configurações:', CONFIG);
            
            initializeEventListeners();
            loadCollectionData('checklist');
        });

        // Event Listeners
        function initializeEventListeners() {
            // Cards de navegação
            document.querySelectorAll('.nav-card').forEach(card => {
                card.addEventListener('click', function() {
                    const collection = this.dataset.collection;
                    selectCollection(collection);
                });
            });

            // Abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // Configurar datas padrão
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (CONFIG.DAYS * 24 * 60 * 60 * 1000));
            
            document.getElementById('dateEnd').value = today.toISOString().split('T')[0];
            document.getElementById('dateStart').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Seleção de collection
        function selectCollection(collection) {
            console.log('📊 Selecionando collection:', collection);
            
            // Atualizar cards ativos
            document.querySelectorAll('.nav-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-collection="${collection}"]`).classList.add('active');
            
            currentCollection = collection;
            loadCollectionData(collection);
        }

        // Carregar dados da collection
        async function loadCollectionData(collection) {
            console.log('📡 Carregando dados para:', collection);
            
            try {
                showLoading();
                const data = await fetchCollectionData(collection);
                
                currentData = data;
                await populateFilters(data);
                applyFilters();
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                showError('Erro ao carregar dados: ' + error.message);
            }
        }

        // Buscar dados da API
        async function fetchCollectionData(collection) {
            const endpoint = getEndpointForCollection(collection);
            const url = `${CONFIG.API_BASE_URL}${endpoint}?enterpriseId=${CONFIG.ENTERPRISE_ID}&days=${CONFIG.DAYS}`;
            
            console.log('🔗 Fazendo requisição para:', url);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // A API Firebase BI retorna dados diretamente em array
            if (Array.isArray(result)) {
                return result;
            } else if (result && typeof result === 'object') {
                return result.data || result;
            } else {
                throw new Error('Formato de dados inválido da API');
            }
        }

        // Mapear collection para endpoint
        function getEndpointForCollection(collection) {
            const endpoints = {
                'checklist': '/checklist',
                'trips': '/driver-trips',
                'alerts': '/alerts-checkin',
                'maintenance': '/incidents'
            };
            return endpoints[collection] || '/checklist';
        }

        // Popular filtros com dados únicos
        async function populateFilters(data) {
            if (!data || data.length === 0) return;

            // Responsáveis únicos
            const responsibles = [...new Set(data.map(item => item.userRespForRegistration).filter(Boolean))].sort();
            populateSelect('responsibleFilter', responsibles);

            // Placas únicas
            const plates = [...new Set(data.map(item => item.vehiclePlate).filter(Boolean))].sort();
            populateSelect('plateFilter', plates);

            // Tipos de ativo únicos
            const assetTypes = [...new Set(data.map(item => item.planName).filter(Boolean))].sort();
            populateSelect('assetTypeFilter', assetTypes);

            // Motoristas únicos
            const drivers = [...new Set(data.map(item => item.driverName).filter(Boolean))].sort();
            populateSelect('driverFilter', drivers);
        }

        // Popular select com opções
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Manter primeira opção (Todos)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Adicionar opções
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restaurar valor se ainda existir
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Aplicar filtros
        function applyFilters() {
            const filters = {
                dateStart: document.getElementById('dateStart').value,
                dateEnd: document.getElementById('dateEnd').value,
                responsible: document.getElementById('responsibleFilter').value,
                plate: document.getElementById('plateFilter').value,
                assetType: document.getElementById('assetTypeFilter').value,
                driver: document.getElementById('driverFilter').value
            };

            filteredData = currentData.filter(item => {
                // Filtro de data
                if (filters.dateStart || filters.dateEnd) {
                    const itemDate = new Date(item.timestamp || item.issueOpenDate);
                    if (filters.dateStart && itemDate < new Date(filters.dateStart)) return false;
                    if (filters.dateEnd && itemDate > new Date(filters.dateEnd + 'T23:59:59')) return false;
                }

                // Filtro de responsável
                if (filters.responsible && item.userRespForRegistration !== filters.responsible) return false;

                // Filtro de placa
                if (filters.plate && item.vehiclePlate !== filters.plate) return false;

                // Filtro de tipo de ativo
                if (filters.assetType && item.planName !== filters.assetType) return false;

                // Filtro de motorista
                if (filters.driver && item.driverName !== filters.driver) return false;

                return true;
            });

            currentPage = 1;
            updateStatistics();
            renderCurrentTab();
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            document.getElementById('responsibleFilter').value = '';
            document.getElementById('plateFilter').value = '';
            document.getElementById('assetTypeFilter').value = '';
            document.getElementById('driverFilter').value = '';
            
            applyFilters();
        }

        // Atualizar estatísticas
        function updateStatistics() {
            const total = filteredData.length;
            const compliant = filteredData.filter(item => item.compliant === true).length;
            const nonCompliant = filteredData.filter(item => item.noCompliant === true || item.compliant === false).length;
            const pending = total - compliant - nonCompliant;
            const complianceRate = total > 0 ? ((compliant / total) * 100).toFixed(1) : 0;

            document.getElementById('totalCount').textContent = total.toLocaleString();
            document.getElementById('compliantCount').textContent = compliant.toLocaleString();
            document.getElementById('pendingCount').textContent = pending.toLocaleString();
            document.getElementById('complianceRate').textContent = complianceRate + '%';
        }

        // Trocar aba
        function switchTab(tabName) {
            // Atualizar abas ativas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Atualizar conteúdo ativo
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            renderCurrentTab();
        }

        // Renderizar aba atual
        function renderCurrentTab() {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            switch (activeTab) {
                case 'overview':
                    renderOverviewTable();
                    break;
                case 'status':
                    renderStatusTab();
                    break;
                case 'non-compliant':
                    renderNonCompliantTable();
                    break;
            }
        }

        // Renderizar tabela geral
        function renderOverviewTable() {
            const startIndex = (currentPage - 1) * CONFIG.ITEMS_PER_PAGE;
            const endIndex = startIndex + CONFIG.ITEMS_PER_PAGE;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">Nenhum dado encontrado</td></tr>';
                renderPagination();
                return;
            }

            pageData.forEach(item => {
                const row = document.createElement('tr');
                const date = new Date(item.timestamp || item.issueOpenDate).toLocaleDateString('pt-BR');
                const status = getStatusBadge(item);

                row.innerHTML = `
                    <td>${date}</td>
                    <td>${item.vehiclePlate || '-'}</td>
                    <td>${item.planName || '-'}</td>
                    <td>${item.itemName || '-'}</td>
                    <td>${item.userRespForRegistration || '-'}</td>
                    <td>${item.driverName || '-'}</td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });

            renderPagination();
        }

        // Renderizar aba de status
        function renderStatusTab() {
            const compliant = filteredData.filter(item => item.compliant === true).length;
            const nonCompliant = filteredData.filter(item => item.noCompliant === true || item.compliant === false).length;
            const pending = filteredData.length - compliant - nonCompliant;

            // Gráfico
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }

            window.statusChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Conformes', 'Não Conformes', 'Pendentes'],
                    datasets: [{
                        data: [compliant, nonCompliant, pending],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });

            // Tabela de status
            const tbody = document.getElementById('statusTableBody');
            tbody.innerHTML = '';

            const statusData = [
                { name: 'Conformes', count: compliant, color: '#10b981' },
                { name: 'Não Conformes', count: nonCompliant, color: '#ef4444' },
                { name: 'Pendentes', count: pending, color: '#f59e0b' }
            ];

            statusData.forEach(status => {
                const percentage = filteredData.length > 0 ? ((status.count / filteredData.length) * 100).toFixed(1) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span style="color: ${status.color};">●</span> ${status.name}</td>
                    <td>${status.count.toLocaleString()}</td>
                    <td>${percentage}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Renderizar tabela de não conformes
        function renderNonCompliantTable() {
            const nonCompliantData = filteredData.filter(item => 
                item.noCompliant === true || item.compliant === false
            );

            const tbody = document.getElementById('nonCompliantTableBody');
            tbody.innerHTML = '';

            if (nonCompliantData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">Nenhuma não conformidade encontrada</td></tr>';
                return;
            }

            nonCompliantData.forEach(item => {
                const row = document.createElement('tr');
                const date = new Date(item.timestamp || item.issueOpenDate).toLocaleDateString('pt-BR');

                row.innerHTML = `
                    <td>${date}</td>
                    <td>${item.vehiclePlate || '-'}</td>
                    <td>${item.itemName || '-'}</td>
                    <td>${item.userRespForRegistration || '-'}</td>
                    <td>${item.comments || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Renderizar paginação
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / CONFIG.ITEMS_PER_PAGE);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Botão anterior
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Anterior</button>`;

            // Páginas
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) html += '<span>...</span>';
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="${i === currentPage ? 'current-page' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span>...</span>';
                html += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            // Botão próximo
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Próximo</button>`;

            pagination.innerHTML = html;
        }

        // Mudar página
        function changePage(page) {
            currentPage = page;
            renderCurrentTab();
        }

        // Obter badge de status
        function getStatusBadge(item) {
            if (item.compliant === true) {
                return '<span class="status-badge status-conforme">Conforme</span>';
            } else if (item.noCompliant === true || item.compliant === false) {
                return '<span class="status-badge status-nao-conforme">Não Conforme</span>';
            } else {
                return '<span class="status-badge status-pendente">Pendente</span>';
            }
        }

        // Mostrar loading
        function showLoading() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="loading">
                        <div class="loading-spinner"></div>
                        Carregando dados...
                    </td>
                </tr>
            `;
        }

        // Mostrar erro
        function showError(message) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--error); padding: 40px;">
                        ❌ ${message}
                    </td>
                </tr>
            `;
        }

        // Exportar para Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(filteredData.map(item => ({
                'Data': new Date(item.timestamp || item.issueOpenDate).toLocaleDateString('pt-BR'),
                'Placa': item.vehiclePlate || '',
                'Tipo de Ativo': item.planName || '',
                'Item': item.itemName || '',
                'Responsável': item.userRespForRegistration || '',
                'Motorista': item.driverName || '',
                'Status': item.compliant === true ? 'Conforme' : (item.noCompliant === true || item.compliant === false) ? 'Não Conforme' : 'Pendente',
                'Comentários': item.comments || ''
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dados');
            
            const fileName = `fleet_copilot_${currentCollection}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Exportar para PDF
        function exportToPDF() {
            if (filteredData.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text('Fleet Copilot BI - Relatório', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Collection: ${currentCollection}`, 20, 35);
            doc.text(`Total de registros: ${filteredData.length}`, 20, 45);
            doc.text(`Data de geração: ${new Date().toLocaleDateString('pt-BR')}`, 20, 55);

            // Adicionar dados (primeiros 50 registros)
            let y = 75;
            const maxRecords = Math.min(50, filteredData.length);
            
            doc.setFontSize(10);
            for (let i = 0; i < maxRecords; i++) {
                const item = filteredData[i];
                const date = new Date(item.timestamp || item.issueOpenDate).toLocaleDateString('pt-BR');
                const text = `${date} - ${item.vehiclePlate || ''} - ${item.itemName || ''}`;
                
                doc.text(text, 20, y);
                y += 10;
                
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
            }

            if (filteredData.length > 50) {
                doc.text(`... e mais ${filteredData.length - 50} registros`, 20, y + 10);
            }

            const fileName = `fleet_copilot_${currentCollection}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>

