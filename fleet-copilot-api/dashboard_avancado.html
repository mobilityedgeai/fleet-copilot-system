<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Copilot BI - Dashboard Avançado</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Variáveis CSS - Padrão Teal/Turquesa */
        :root {
            --primary: #1abc9c;
            --primary-dark: #16a085;
            --primary-light: #48c9b0;
            --background: #2c3e50;
            --surface: #34495e;
            --surface-light: #3d566e;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #95a5a6;
            --border: #4a5568;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --shadow: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout Principal */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--surface);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: var(--primary);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Container Principal */
        .main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Navigation Grid */
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .nav-item {
            background: var(--surface);
            border: 2px solid transparent;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .nav-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(26, 188, 156, 0.2);
        }

        .nav-item.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--surface), var(--surface-light));
        }

        .nav-icon {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
        }

        .nav-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .nav-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Content Area */
        .content {
            background: var(--surface);
            border-radius: 1rem;
            min-height: 600px;
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .content-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .content-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .content-icon {
            font-size: 1.5rem;
        }

        .content-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .content-body {
            padding: 2rem;
        }

        /* Filters Section */
        .filters-section {
            background: var(--background);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .filters-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-input {
            padding: 0.75rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
        }

        .filter-button {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-button:hover {
            background: var(--primary-dark);
        }

        .clear-filters {
            background: var(--danger);
        }

        .clear-filters:hover {
            background: #c0392b;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 2rem;
        }

        .tabs-nav {
            display: flex;
            background: var(--background);
            border-radius: 0.75rem;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Data Table */
        .data-table {
            background: var(--background);
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-header {
            background: var(--surface-light);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .export-btn {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .export-btn:hover {
            background: var(--primary-dark);
        }

        .export-btn.excel {
            background: var(--success);
        }

        .export-btn.excel:hover {
            background: #229954;
        }

        .export-btn.pdf {
            background: var(--danger);
        }

        .export-btn.pdf:hover {
            background: #c0392b;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--surface);
            color: var(--text-primary);
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .table tr:hover {
            background: rgba(26, 188, 156, 0.05);
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success { background: var(--success); color: white; }
        .badge-warning { background: var(--warning); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-info { background: var(--info); color: white; }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Welcome State */
        .welcome {
            text-align: center;
            padding: 4rem 2rem;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .welcome-description {
            color: var(--text-secondary);
            font-size: 1.125rem;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .main {
                padding: 1rem;
            }

            .nav-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .content-body {
                padding: 1rem;
            }

            .tabs-nav {
                flex-direction: column;
            }

            .export-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">🚛</div>
                    <span>Fleet Copilot BI</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Sistema Online</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Navigation Grid -->
            <section class="nav-grid">
                <div class="nav-item" data-collection="checklist">
                    <div class="nav-icon">📋</div>
                    <div class="nav-title">Checklist</div>
                    <div class="nav-description">Inspeções e Conformidade</div>
                </div>
                <div class="nav-item" data-collection="trips">
                    <div class="nav-icon">🛣️</div>
                    <div class="nav-title">Viagens</div>
                    <div class="nav-description">Rotas e Desempenho</div>
                </div>
                <div class="nav-item" data-collection="alerts">
                    <div class="nav-icon">⚠️</div>
                    <div class="nav-title">Alertas</div>
                    <div class="nav-description">Notificações e Eventos</div>
                </div>
                <div class="nav-item" data-collection="maintenance">
                    <div class="nav-icon">🔧</div>
                    <div class="nav-title">Manutenção</div>
                    <div class="nav-description">Serviços e Custos</div>
                </div>
            </section>

            <!-- Content Area -->
            <section class="content">
                <div id="app-content">
                    <div class="welcome">
                        <div class="welcome-icon">🚛</div>
                        <h1 class="welcome-title">Fleet Copilot BI</h1>
                        <p class="welcome-description">
                            Dashboard avançado com filtros, múltiplas visualizações e exportação. 
                            Selecione uma categoria acima para começar.
                        </p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Configuração Global
        const CONFIG = {
            API_BASE_URL: 'https://firebase-bi-api.onrender.com',
            ENTERPRISE_ID: new URLSearchParams(window.location.search).get('enterpriseId') || 'sA9EmrE3ymtnBqJKcYn7',
            DAYS: parseInt(new URLSearchParams(window.location.search).get('days')) || 30
        };

        // Mapeamento de Rotas da API
        const API_ROUTES = {
            checklist: 'checklist',
            trips: 'driver-trips',
            alerts: 'alerts-checkin',
            maintenance: 'incidents'
        };

        // Estado da Aplicação
        let currentCollection = null;
        let currentData = null;
        let filteredData = null;
        let currentFilters = {};
        let charts = {};

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Fleet Copilot BI Avançado - Inicializando');
            console.log('🔧 Configurações:', CONFIG);
            
            initializeApp();
        });

        // Inicializar Aplicação
        function initializeApp() {
            // Event listeners para navegação
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const collection = this.dataset.collection;
                    selectCollection(collection);
                });
            });

            console.log('✅ Aplicação inicializada com sucesso');
        }

        // Selecionar Collection
        function selectCollection(collection) {
            console.log(`📊 Selecionando collection: ${collection}`);
            
            // Atualizar estado visual
            updateNavigationState(collection);
            
            // Carregar dados
            loadCollectionData(collection);
        }

        // Atualizar Estado da Navegação
        function updateNavigationState(collection) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-collection="${collection}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        // Carregar Dados da Collection
        async function loadCollectionData(collection) {
            currentCollection = collection;
            
            try {
                // Mostrar loading
                showLoading(collection);
                
                // Buscar dados
                const data = await fetchData(collection);
                currentData = data;
                filteredData = data;
                currentFilters = {};
                
                // Renderizar interface específica
                if (collection === 'checklist') {
                    renderChecklistInterface(data);
                } else {
                    renderBasicInterface(collection, data);
                }
                
                console.log(`✅ Dados de ${collection} carregados: ${data.length} registros`);
                
            } catch (error) {
                console.error(`❌ Erro ao carregar ${collection}:`, error);
                showError(error.message);
            }
        }

        // Buscar Dados da API
        async function fetchData(collection) {
            const route = API_ROUTES[collection];
            const url = `${CONFIG.API_BASE_URL}/${route}?enterpriseId=${CONFIG.ENTERPRISE_ID}&days=${CONFIG.DAYS}`;
            
            console.log(`🔗 Requisição: ${url}`);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Normalizar resposta
            if (Array.isArray(result)) {
                return result;
            } else if (result && result.data) {
                return Array.isArray(result.data) ? result.data : [result.data];
            } else if (result && typeof result === 'object') {
                return [result];
            } else {
                throw new Error('Formato de dados inválido');
            }
        }

        // Mostrar Loading
        function showLoading(collection) {
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="content-header">
                    <div class="content-header-left">
                        <div class="content-icon">📋</div>
                        <div class="content-title">Carregando ${collection}...</div>
                    </div>
                </div>
                <div class="content-body">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Buscando dados reais da API...</div>
                    </div>
                </div>
            `;
        }

        // Mostrar Erro
        function showError(message) {
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="content-body">
                    <div class="error">
                        <div class="error-icon">⚠️</div>
                        <div class="error-title">Erro ao Carregar Dados</div>
                        <div class="error-message">${message}</div>
                        <button class="btn" onclick="location.reload()">
                            🔄 Tentar Novamente
                        </button>
                    </div>
                </div>
            `;
        }

        // Renderizar Interface do Checklist (Avançada)
        function renderChecklistInterface(data) {
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="content-header">
                    <div class="content-header-left">
                        <div class="content-icon">📋</div>
                        <div class="content-title">Checklist de Conformidade</div>
                    </div>
                </div>
                <div class="content-body">
                    ${renderFiltersSection()}
                    ${renderStatsGrid(data)}
                    ${renderTabsContainer()}
                </div>
            `;

            // Inicializar funcionalidades
            initializeFilters();
            initializeTabs();
            updateTabsContent(data);
        }

        // Renderizar Seção de Filtros
        function renderFiltersSection() {
            return `
                <div class="filters-section">
                    <div class="filters-title">
                        🔍 Filtros de Pesquisa
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Data Inicial</label>
                            <input type="date" class="filter-input" id="filter-date-start">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Data Final</label>
                            <input type="date" class="filter-input" id="filter-date-end">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Garagem</label>
                            <select class="filter-input" id="filter-garage">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Filial</label>
                            <select class="filter-input" id="filter-branch">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Motorista</label>
                            <select class="filter-input" id="filter-driver">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Placa</label>
                            <input type="text" class="filter-input" id="filter-plate" placeholder="Digite a placa">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Tipo de Ativo</label>
                            <select class="filter-input" id="filter-asset-type">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="filter-button" onclick="applyFilters()">
                                🔍 Aplicar Filtros
                            </button>
                        </div>
                        <div class="filter-group">
                            <button class="filter-button clear-filters" onclick="clearFilters()">
                                🗑️ Limpar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderizar Grid de Estatísticas
        function renderStatsGrid(data) {
            const stats = calculateChecklistStats(data);
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.conforme}</div>
                        <div class="stat-label">Conformes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.pendente}</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.percentual}%</div>
                        <div class="stat-label">Conformidade</div>
                    </div>
                </div>
            `;
        }

        // Renderizar Container de Abas
        function renderTabsContainer() {
            return `
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-button active" data-tab="assets">Lista de Ativos</button>
                        <button class="tab-button" data-tab="status">Inspeções por Status</button>
                        <button class="tab-button" data-tab="non-compliant">Inspeções Não Conformes</button>
                    </div>
                    
                    <div class="tab-content active" id="tab-assets">
                        <div id="assets-content"></div>
                    </div>
                    
                    <div class="tab-content" id="tab-status">
                        <div id="status-content"></div>
                    </div>
                    
                    <div class="tab-content" id="tab-non-compliant">
                        <div id="non-compliant-content"></div>
                    </div>
                </div>
            `;
        }

        // Calcular Estatísticas do Checklist
        function calculateChecklistStats(data) {
            const total = data.length;
            const conforme = data.filter(item => 
                item.noCompliant === true || 
                item.statusOs === 'Finalizado' ||
                item.statusOs === 'Conforme'
            ).length;
            const pendente = total - conforme;
            const percentual = total > 0 ? Math.round((conforme / total) * 100) : 0;
            
            return { total, conforme, pendente, percentual };
        }

        // Inicializar Filtros
        function initializeFilters() {
            if (!currentData) return;
            
            // Popular dropdowns com valores únicos dos dados
            populateFilterOptions('filter-garage', 'garage');
            populateFilterOptions('filter-branch', 'branch');
            populateFilterOptions('filter-driver', 'assignedTo');
            populateFilterOptions('filter-asset-type', 'planName');
            
            // Definir datas padrão
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('filter-date-start').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('filter-date-end').value = today.toISOString().split('T')[0];
        }

        // Popular Opções dos Filtros
        function populateFilterOptions(selectId, field) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const uniqueValues = [...new Set(currentData
                .map(item => item[field])
                .filter(value => value && value !== '')
            )].sort();
            
            uniqueValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        }

        // Aplicar Filtros
        function applyFilters() {
            if (!currentData) return;
            
            // Coletar valores dos filtros
            currentFilters = {
                dateStart: document.getElementById('filter-date-start').value,
                dateEnd: document.getElementById('filter-date-end').value,
                garage: document.getElementById('filter-garage').value,
                branch: document.getElementById('filter-branch').value,
                driver: document.getElementById('filter-driver').value,
                plate: document.getElementById('filter-plate').value.toLowerCase(),
                assetType: document.getElementById('filter-asset-type').value
            };
            
            // Aplicar filtros aos dados
            filteredData = currentData.filter(item => {
                // Filtro de data (se disponível)
                if (currentFilters.dateStart && item.issueOpenDate) {
                    const itemDate = new Date(item.issueOpenDate);
                    const startDate = new Date(currentFilters.dateStart);
                    if (itemDate < startDate) return false;
                }
                
                if (currentFilters.dateEnd && item.issueOpenDate) {
                    const itemDate = new Date(item.issueOpenDate);
                    const endDate = new Date(currentFilters.dateEnd);
                    if (itemDate > endDate) return false;
                }
                
                // Outros filtros
                if (currentFilters.garage && item.garage !== currentFilters.garage) return false;
                if (currentFilters.branch && item.branch !== currentFilters.branch) return false;
                if (currentFilters.driver && item.assignedTo !== currentFilters.driver) return false;
                if (currentFilters.assetType && item.planName !== currentFilters.assetType) return false;
                
                // Filtro de placa (busca parcial)
                if (currentFilters.plate && !item.vehiclePlate?.toLowerCase().includes(currentFilters.plate)) return false;
                
                return true;
            });
            
            console.log(`🔍 Filtros aplicados: ${filteredData.length} de ${currentData.length} registros`);
            
            // Atualizar interface
            updateStatsGrid();
            updateTabsContent(filteredData);
        }

        // Limpar Filtros
        function clearFilters() {
            // Limpar campos
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-garage').value = '';
            document.getElementById('filter-branch').value = '';
            document.getElementById('filter-driver').value = '';
            document.getElementById('filter-plate').value = '';
            document.getElementById('filter-asset-type').value = '';
            
            // Resetar dados
            filteredData = currentData;
            currentFilters = {};
            
            // Atualizar interface
            updateStatsGrid();
            updateTabsContent(filteredData);
            
            console.log('🗑️ Filtros limpos');
        }

        // Atualizar Grid de Estatísticas
        function updateStatsGrid() {
            const stats = calculateChecklistStats(filteredData);
            
            const statCards = document.querySelectorAll('.stat-card .stat-value');
            if (statCards.length >= 4) {
                statCards[0].textContent = stats.total;
                statCards[1].textContent = stats.conforme;
                statCards[2].textContent = stats.pendente;
                statCards[3].textContent = stats.percentual + '%';
            }
        }

        // Inicializar Abas
        function initializeTabs() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
        }

        // Trocar Aba
        function switchTab(tabId) {
            // Atualizar botões
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Atualizar conteúdo
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Atualizar conteúdo da aba
            updateTabContent(tabId);
        }

        // Atualizar Conteúdo das Abas
        function updateTabsContent(data) {
            updateTabContent('assets', data);
        }

        // Atualizar Conteúdo de uma Aba
        function updateTabContent(tabId, data = null) {
            if (!data) data = filteredData;
            
            switch (tabId) {
                case 'assets':
                    updateAssetsTab(data);
                    break;
                case 'status':
                    updateStatusTab(data);
                    break;
                case 'non-compliant':
                    updateNonCompliantTab(data);
                    break;
            }
        }

        // Atualizar Aba Lista de Ativos
        function updateAssetsTab(data) {
            const container = document.getElementById('assets-content');
            container.innerHTML = renderDataTable(data, 'Lista de Ativos', [
                { field: 'planName', label: 'Tipo de Ativo' },
                { field: 'vehiclePlate', label: 'Placa' },
                { field: 'costCenter', label: 'Centro de Custo' },
                { field: 'branch', label: 'Filial' },
                { field: 'garage', label: 'Garagem' }
            ]);
        }

        // Atualizar Aba Inspeções por Status
        function updateStatusTab(data) {
            const container = document.getElementById('status-content');
            
            // Adicionar gráfico de status
            const chartHtml = `
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Distribuição por Status</div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            const tableHtml = renderDataTable(data, 'Inspeções por Status', [
                { field: 'planName', label: 'Tipo de Ativo' },
                { field: 'vehiclePlate', label: 'Placa' },
                { field: 'costCenter', label: 'Centro de Custo' },
                { field: 'statusOs', label: 'Status' },
                { field: 'assignedTo', label: 'Responsável' }
            ]);
            
            container.innerHTML = chartHtml + tableHtml;
            
            // Criar gráfico
            setTimeout(() => createStatusChart(data), 100);
        }

        // Atualizar Aba Inspeções Não Conformes
        function updateNonCompliantTab(data) {
            const nonCompliantData = data.filter(item => 
                item.noCompliant === false || 
                item.statusOs === 'Pendente' ||
                item.priority === 'Emergência'
            );
            
            const container = document.getElementById('non-compliant-content');
            container.innerHTML = renderDataTable(nonCompliantData, 'Inspeções Não Conformes', [
                { field: 'planName', label: 'Tipo de Ativo' },
                { field: 'vehiclePlate', label: 'Placa' },
                { field: 'priority', label: 'Prioridade' },
                { field: 'statusOs', label: 'Status' },
                { field: 'assignedTo', label: 'Responsável' }
            ]);
        }

        // Renderizar Tabela de Dados
        function renderDataTable(data, title, columns) {
            if (data.length === 0) {
                return `
                    <div class="data-table">
                        <div class="table-header">
                            <div class="table-title">${title} - Nenhum registro encontrado</div>
                        </div>
                        <div class="content-body">
                            <div class="text-center text-muted">
                                Nenhum registro encontrado com os filtros aplicados.
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const tableHeaders = columns.map(col => `<th>${col.label}</th>`).join('');
            const tableRows = data.slice(0, 100).map(item => {
                const cells = columns.map(col => {
                    const value = item[col.field];
                    const formattedValue = formatCellValue(col.field, value);
                    return `<td>${formattedValue}</td>`;
                }).join('');
                
                return `<tr>${cells}</tr>`;
            }).join('');
            
            const showingText = data.length > 100 ? 
                `${title} - Mostrando 100 de ${data.length} registros` : 
                `${title} - ${data.length} registros`;
            
            return `
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-title">${showingText}</div>
                        <div class="export-buttons">
                            <button class="export-btn excel" onclick="exportToExcel('${title}')">
                                📊 Excel
                            </button>
                            <button class="export-btn pdf" onclick="exportToPDF('${title}')">
                                📄 PDF
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>${tableHeaders}</tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Formatar Valor da Célula
        function formatCellValue(field, value) {
            if (value === null || value === undefined || value === '') {
                return '<span class="text-muted">-</span>';
            }
            
            switch (field) {
                case 'priority':
                    if (value === 'Emergência' || value === 'Alta') {
                        return `<span class="badge badge-danger">${value}</span>`;
                    } else if (value === 'Média') {
                        return `<span class="badge badge-warning">${value}</span>`;
                    } else {
                        return `<span class="badge badge-info">${value}</span>`;
                    }
                    
                case 'statusOs':
                    if (value === 'Finalizado' || value === 'Conforme') {
                        return `<span class="badge badge-success">${value}</span>`;
                    } else if (value === 'Pendente') {
                        return `<span class="badge badge-warning">${value}</span>`;
                    } else {
                        return `<span class="badge badge-info">${value}</span>`;
                    }
                    
                default:
                    if (typeof value === 'string' && value.length > 30) {
                        return `<span title="${value}">${value.substring(0, 30)}...</span>`;
                    }
                    return value;
            }
        }

        // Criar Gráfico de Status
        function createStatusChart(data) {
            const canvas = document.getElementById('statusChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Contar status
            const statusCounts = {};
            data.forEach(item => {
                const status = item.statusOs || 'Indefinido';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const labels = Object.keys(statusCounts);
            const values = Object.values(statusCounts);
            const colors = labels.map(label => {
                switch (label) {
                    case 'Finalizado':
                    case 'Conforme':
                        return '#27ae60';
                    case 'Pendente':
                        return '#f39c12';
                    default:
                        return '#3498db';
                }
            });
            
            if (charts.statusChart) {
                charts.statusChart.destroy();
            }
            
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#34495e'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ecf0f1',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Exportar para Excel
        function exportToExcel(title) {
            if (!filteredData || filteredData.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }
            
            // Preparar dados para exportação
            const exportData = filteredData.map(item => ({
                'Tipo de Ativo': item.planName || '',
                'Placa': item.vehiclePlate || '',
                'Centro de Custo': item.costCenter || '',
                'Filial': item.branch || '',
                'Garagem': item.garage || '',
                'Status': item.statusOs || '',
                'Prioridade': item.priority || '',
                'Responsável': item.assignedTo || '',
                'Número OS': item.osNumber || ''
            }));
            
            // Criar workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // Adicionar worksheet
            XLSX.utils.book_append_sheet(wb, ws, title);
            
            // Gerar nome do arquivo
            const fileName = `${title}_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Fazer download
            XLSX.writeFile(wb, fileName);
            
            console.log(`📊 Exportado para Excel: ${fileName}`);
        }

        // Exportar para PDF
        function exportToPDF(title) {
            if (!filteredData || filteredData.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(16);
            doc.text(title, 20, 20);
            
            // Data
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
            
            // Filtros aplicados
            if (Object.keys(currentFilters).length > 0) {
                doc.text('Filtros aplicados:', 20, 40);
                let yPos = 45;
                Object.entries(currentFilters).forEach(([key, value]) => {
                    if (value) {
                        doc.text(`${key}: ${value}`, 25, yPos);
                        yPos += 5;
                    }
                });
            }
            
            // Preparar dados da tabela
            const tableData = filteredData.slice(0, 50).map(item => [
                item.planName || '',
                item.vehiclePlate || '',
                item.costCenter || '',
                item.statusOs || '',
                item.priority || ''
            ]);
            
            // Adicionar tabela
            doc.autoTable({
                head: [['Tipo de Ativo', 'Placa', 'Centro de Custo', 'Status', 'Prioridade']],
                body: tableData,
                startY: 60,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [26, 188, 156],
                    textColor: [255, 255, 255]
                }
            });
            
            // Nota sobre limitação
            if (filteredData.length > 50) {
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(8);
                doc.text(`Nota: Mostrando primeiros 50 registros de ${filteredData.length} total`, 20, finalY);
            }
            
            // Gerar nome do arquivo
            const fileName = `${title}_${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Fazer download
            doc.save(fileName);
            
            console.log(`📄 Exportado para PDF: ${fileName}`);
        }

        // Renderizar Interface Básica (para outras collections)
        function renderBasicInterface(collection, data) {
            const stats = calculateBasicStats(collection, data);
            
            const content = document.getElementById('app-content');
            content.innerHTML = `
                <div class="content-header">
                    <div class="content-header-left">
                        <div class="content-icon">${getCollectionIcon(collection)}</div>
                        <div class="content-title">${getCollectionTitle(collection)}</div>
                    </div>
                </div>
                <div class="content-body">
                    ${renderBasicStatsGrid(stats)}
                    ${renderBasicDataTable(collection, data)}
                </div>
            `;
        }

        // Calcular Estatísticas Básicas
        function calculateBasicStats(collection, data) {
            return {
                total: data.length
            };
        }

        // Renderizar Grid de Estatísticas Básicas
        function renderBasicStatsGrid(stats) {
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total de Registros</div>
                    </div>
                </div>
            `;
        }

        // Renderizar Tabela Básica
        function renderBasicDataTable(collection, data) {
            const columns = getBasicColumns(collection);
            return renderDataTable(data, getCollectionTitle(collection), columns);
        }

        // Obter Colunas Básicas por Collection
        function getBasicColumns(collection) {
            switch (collection) {
                case 'trips':
                    return [
                        { field: 'vehiclePlate', label: 'Placa' },
                        { field: 'driverName', label: 'Motorista' },
                        { field: 'startTime', label: 'Início' },
                        { field: 'distance', label: 'Distância' }
                    ];
                case 'alerts':
                    return [
                        { field: 'type', label: 'Tipo' },
                        { field: 'vehiclePlate', label: 'Placa' },
                        { field: 'severity', label: 'Severidade' },
                        { field: 'timestamp', label: 'Data/Hora' }
                    ];
                case 'maintenance':
                    return [
                        { field: 'vehiclePlate', label: 'Placa' },
                        { field: 'serviceType', label: 'Tipo de Serviço' },
                        { field: 'cost', label: 'Custo' },
                        { field: 'date', label: 'Data' }
                    ];
                default:
                    return [
                        { field: 'id', label: 'ID' },
                        { field: 'name', label: 'Nome' }
                    ];
            }
        }

        // Obter Ícone da Collection
        function getCollectionIcon(collection) {
            const icons = {
                checklist: '📋',
                trips: '🛣️',
                alerts: '⚠️',
                maintenance: '🔧'
            };
            return icons[collection] || '📊';
        }

        // Obter Título da Collection
        function getCollectionTitle(collection) {
            const titles = {
                checklist: 'Checklist de Conformidade',
                trips: 'Dados de Viagens',
                alerts: 'Alertas e Notificações',
                maintenance: 'Dados de Manutenção'
            };
            return titles[collection] || collection;
        }

        // Log de inicialização
        console.log('🚛 Fleet Copilot BI - Dashboard Avançado');
        console.log('🎨 Design: Moderno com funcionalidades avançadas');
        console.log('🔍 Filtros: Múltiplos filtros dinâmicos');
        console.log('📊 Visualizações: Múltiplas abas e gráficos');
        console.log('📤 Exportação: Excel e PDF');
    </script>
</body>
</html>

