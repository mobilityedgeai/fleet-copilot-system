<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Copilot - BI Inteligente</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        /* Padr√£o de Cores Correto - Baseado na Imagem BI Safety */
        :root {
            --primary-teal: #1abc9c;
            --primary-teal-dark: #16a085;
            --background-dark: #2c3e50;
            --card-dark: #34495e;
            --text-light: #ecf0f1;
            --text-muted: #bdc3c7;
            --border-subtle: #4a5568;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        /* Layout Base */
        body {
            background: var(--background-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Container Principal - Sem Menu Superior */
        .main-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Cards de Sele√ß√£o de BI */
        .bi-selector {
            margin-bottom: 30px;
        }

        .bi-card {
            background: var(--card-dark);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .bi-card:hover {
            border-color: var(--primary-teal);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(26, 188, 156, 0.2);
        }

        .bi-card.active {
            border-color: var(--primary-teal);
            background: linear-gradient(135deg, var(--card-dark) 0%, rgba(26, 188, 156, 0.1) 100%);
        }

        .bi-card i {
            font-size: 2.5rem;
            color: var(--primary-teal);
            margin-bottom: 10px;
        }

        .bi-card h5 {
            color: var(--text-light);
            margin: 0;
            font-weight: 600;
        }

        .bi-card p {
            color: var(--text-muted);
            margin: 5px 0 0 0;
            font-size: 0.9rem;
        }

        /* Se√ß√£o de Filtros */
        .filters-section {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-subtle);
        }

        .filters-title {
            color: var(--primary-teal);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-control, .form-select {
            background: var(--background-dark);
            border: 1px solid var(--border-subtle);
            color: var(--text-light);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .form-control:focus, .form-select:focus {
            background: var(--background-dark);
            border-color: var(--primary-teal);
            color: var(--text-light);
            box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-muted);
        }

        .btn-primary {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--primary-teal-dark);
            border-color: var(--primary-teal-dark);
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            color: var(--primary-teal);
            border-color: var(--primary-teal);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
            color: white;
        }

        /* Cards de M√©tricas */
        .metrics-section {
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
            height: 100%;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-teal);
            margin-bottom: 10px;
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--primary-teal);
            margin-bottom: 15px;
        }

        /* Se√ß√£o de Gr√°ficos */
        .charts-section {
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-subtle);
            height: 400px;
        }

        .chart-title {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Insights de IA */
        .insights-section {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-subtle);
        }

        .insights-title {
            color: var(--primary-teal);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-item {
            background: var(--background-dark);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-teal);
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-type {
            font-size: 0.8rem;
            color: var(--primary-teal);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .insight-text {
            color: var(--text-light);
            margin: 0;
        }

        /* DataTables */
        .dataTables_wrapper {
            color: var(--text-light);
        }

        .table-dark {
            --bs-table-bg: var(--card-dark);
            --bs-table-border-color: var(--border-subtle);
        }

        .table-dark th {
            background: var(--background-dark);
            color: var(--primary-teal);
            border-color: var(--border-subtle);
            font-weight: 600;
        }

        .table-dark td {
            border-color: var(--border-subtle);
            color: var(--text-light);
        }

        .dataTables_info,
        .dataTables_length label,
        .dataTables_filter label {
            color: var(--text-muted) !important;
        }

        .dataTables_length select,
        .dataTables_filter input {
            background: var(--background-dark) !important;
            border: 1px solid var(--border-subtle) !important;
            color: var(--text-light) !important;
            border-radius: 6px !important;
        }

        .page-link {
            background: var(--card-dark);
            border-color: var(--border-subtle);
            color: var(--text-light);
        }

        .page-link:hover {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
            color: white;
        }

        .page-item.active .page-link {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary-teal);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .chart-card {
                height: 300px;
            }
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-conforme {
            background: rgba(39, 174, 96, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-nao-conforme {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .status-pendente {
            background: rgba(243, 156, 18, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sele√ß√£o de BI -->
        <div class="bi-selector">
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="bi-card" data-collection="checklist">
                        <i class="fas fa-clipboard-check"></i>
                        <h5>Checklist</h5>
                        <p>Inspe√ß√µes e Conformidade</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="bi-card" data-collection="trips">
                        <i class="fas fa-route"></i>
                        <h5>Viagens</h5>
                        <p>Rotas e Desempenho</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="bi-card" data-collection="alerts">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h5>Alertas</h5>
                        <p>Notifica√ß√µes e Eventos</p>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="bi-card" data-collection="maintenance">
                        <i class="fas fa-tools"></i>
                        <h5>Manuten√ß√£o</h5>
                        <p>Servi√ßos e Custos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o de Filtros (Din√¢mica por Collection) -->
        <div class="filters-section" id="filtersSection" style="display: none;">
            <div class="filters-title">
                <i class="fas fa-filter"></i>
                <span id="filtersTitle">Filtros</span>
            </div>
            <div class="row g-3" id="filtersContainer">
                <!-- Filtros ser√£o inseridos dinamicamente -->
            </div>
        </div>

        <!-- M√©tricas Principais -->
        <div class="metrics-section" id="metricsSection" style="display: none;">
            <div class="row g-3" id="metricsContainer">
                <!-- M√©tricas ser√£o inseridas dinamicamente -->
            </div>
        </div>

        <!-- Insights de IA -->
        <div class="insights-section" id="insightsSection" style="display: none;">
            <div class="insights-title">
                <i class="fas fa-brain"></i>
                <span>Insights de IA</span>
            </div>
            <div id="insightsContainer">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Analisando dados com IA...</p>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <div class="row g-3" id="chartsContainer">
                <!-- Gr√°ficos ser√£o inseridos dinamicamente -->
            </div>
        </div>

        <!-- DataTable -->
        <div class="table-section" id="tableSection" style="display: none;">
            <div class="card" style="background: var(--card-dark); border: 1px solid var(--border-subtle);">
                <div class="card-header" style="background: var(--background-dark); border-bottom: 1px solid var(--border-subtle);">
                    <h5 class="mb-0" style="color: var(--primary-teal);">
                        <i class="fas fa-table"></i>
                        <span id="tableTitle">Dados Detalhados</span>
                    </h5>
                </div>
                <div class="card-body">
                    <table id="dataTable" class="table table-dark table-striped table-hover">
                        <thead id="tableHead">
                            <!-- Cabe√ßalho ser√° inserido dinamicamente -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Dados ser√£o inseridos dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <script>
        // Configura√ß√£o Global
        const CONFIG = {
            API_BASE_URL: 'https://firebase-bi-api.onrender.com',
            ENTERPRISE_ID: new URLSearchParams(window.location.search).get('enterpriseId') || 'sA9EmrE3ymtnBqJKcYn7',
            DAYS: parseInt(new URLSearchParams(window.location.search).get('days')) || 30
        };

        // Estado Global
        let currentCollection = null;
        let currentData = null;
        let currentChart = null;
        let currentTable = null;

        // Configura√ß√µes por Collection
        const COLLECTION_CONFIGS = {
            checklist: {
                title: 'Checklist de Conformidade',
                icon: 'fas fa-clipboard-check',
                color: '#1abc9c',
                filters: [
                    { type: 'daterange', label: 'Per√≠odo' },
                    { type: 'select', label: 'Placa do Ve√≠culo', field: 'vehiclePlate' },
                    { type: 'select', label: 'Motorista', field: 'driverName' },
                    { type: 'select', label: 'Tipo de Item', field: 'itemName' },
                    { type: 'select', label: 'Status', options: ['Todos', 'Conforme', 'N√£o Conforme'] }
                ],
                metrics: [
                    { label: 'Total de Verifica√ß√µes', field: 'total', icon: 'fas fa-clipboard-list' },
                    { label: 'Taxa de Conformidade', field: 'compliance_rate', icon: 'fas fa-check-circle', suffix: '%' },
                    { label: 'Ve√≠culos Verificados', field: 'vehicles', icon: 'fas fa-truck' },
                    { label: 'Motoristas Ativos', field: 'drivers', icon: 'fas fa-user-tie' }
                ],
                charts: [
                    { type: 'doughnut', title: 'Distribui√ß√£o de Conformidade', field: 'compliance' },
                    { type: 'bar', title: 'Verifica√ß√µes por Ve√≠culo', field: 'vehicles' },
                    { type: 'line', title: 'Evolu√ß√£o da Conformidade', field: 'timeline' }
                ],
                tableColumns: [
                    { title: 'Data', field: 'timestamp' },
                    { title: 'Ve√≠culo', field: 'vehiclePlate' },
                    { title: 'Motorista', field: 'driverName' },
                    { title: 'Item', field: 'itemName' },
                    { title: 'Status', field: 'noCompliant' }
                ]
            },
            trips: {
                title: 'An√°lise de Viagens',
                icon: 'fas fa-route',
                color: '#3498db',
                filters: [
                    { type: 'daterange', label: 'Per√≠odo' },
                    { type: 'select', label: 'Motorista', field: 'driverName' },
                    { type: 'select', label: 'Ve√≠culo', field: 'vehiclePlate' },
                    { type: 'select', label: 'Rota', field: 'route' },
                    { type: 'range', label: 'Dist√¢ncia (km)', field: 'distance' }
                ],
                metrics: [
                    { label: 'Total de Viagens', field: 'total_trips', icon: 'fas fa-road' },
                    { label: 'Dist√¢ncia Total (km)', field: 'total_distance', icon: 'fas fa-route' },
                    { label: 'Tempo Total (h)', field: 'total_time', icon: 'fas fa-clock' },
                    { label: 'Velocidade M√©dia', field: 'avg_speed', icon: 'fas fa-tachometer-alt', suffix: ' km/h' }
                ],
                charts: [
                    { type: 'bar', title: 'Viagens por Motorista', field: 'drivers' },
                    { type: 'line', title: 'Dist√¢ncia Di√°ria', field: 'daily_distance' },
                    { type: 'scatter', title: 'Tempo vs Dist√¢ncia', field: 'time_distance' }
                ],
                tableColumns: [
                    { title: 'Data', field: 'date' },
                    { title: 'Motorista', field: 'driverName' },
                    { title: 'Ve√≠culo', field: 'vehiclePlate' },
                    { title: 'Origem', field: 'origin' },
                    { title: 'Destino', field: 'destination' },
                    { title: 'Dist√¢ncia (km)', field: 'distance' },
                    { title: 'Tempo (h)', field: 'duration' }
                ]
            },
            alerts: {
                title: 'Gest√£o de Alertas',
                icon: 'fas fa-exclamation-triangle',
                color: '#e74c3c',
                filters: [
                    { type: 'daterange', label: 'Per√≠odo' },
                    { type: 'select', label: 'Tipo de Alerta', field: 'alertType' },
                    { type: 'select', label: 'Prioridade', options: ['Todas', 'Alta', 'M√©dia', 'Baixa'] },
                    { type: 'select', label: 'Status', options: ['Todos', 'Ativo', 'Resolvido', 'Pendente'] },
                    { type: 'select', label: 'Ve√≠culo', field: 'vehiclePlate' }
                ],
                metrics: [
                    { label: 'Alertas Ativos', field: 'active_alerts', icon: 'fas fa-exclamation-circle' },
                    { label: 'Alertas Cr√≠ticos', field: 'critical_alerts', icon: 'fas fa-exclamation-triangle' },
                    { label: 'Taxa de Resolu√ß√£o', field: 'resolution_rate', icon: 'fas fa-check-circle', suffix: '%' },
                    { label: 'Tempo M√©dio Resolu√ß√£o', field: 'avg_resolution_time', icon: 'fas fa-clock', suffix: 'h' }
                ],
                charts: [
                    { type: 'doughnut', title: 'Alertas por Prioridade', field: 'priority' },
                    { type: 'bar', title: 'Alertas por Tipo', field: 'types' },
                    { type: 'line', title: 'Timeline de Alertas', field: 'timeline' }
                ],
                tableColumns: [
                    { title: 'Data/Hora', field: 'timestamp' },
                    { title: 'Tipo', field: 'alertType' },
                    { title: 'Prioridade', field: 'priority' },
                    { title: 'Ve√≠culo', field: 'vehiclePlate' },
                    { title: 'Descri√ß√£o', field: 'description' },
                    { title: 'Status', field: 'status' }
                ]
            },
            maintenance: {
                title: 'Controle de Manuten√ß√£o',
                icon: 'fas fa-tools',
                color: '#f39c12',
                filters: [
                    { type: 'daterange', label: 'Per√≠odo' },
                    { type: 'select', label: 'Ve√≠culo', field: 'vehiclePlate' },
                    { type: 'select', label: 'Tipo de Servi√ßo', field: 'serviceType' },
                    { type: 'select', label: 'Status', options: ['Todos', 'Agendado', 'Em Andamento', 'Conclu√≠do', 'Cancelado'] },
                    { type: 'range', label: 'Custo (R$)', field: 'cost' }
                ],
                metrics: [
                    { label: 'Servi√ßos Realizados', field: 'total_services', icon: 'fas fa-wrench' },
                    { label: 'Custo Total (R$)', field: 'total_cost', icon: 'fas fa-dollar-sign' },
                    { label: 'Servi√ßos Pendentes', field: 'pending_services', icon: 'fas fa-clock' },
                    { label: 'Tempo M√©dio Servi√ßo', field: 'avg_service_time', icon: 'fas fa-stopwatch', suffix: 'h' }
                ],
                charts: [
                    { type: 'bar', title: 'Custos por Ve√≠culo', field: 'vehicle_costs' },
                    { type: 'doughnut', title: 'Tipos de Servi√ßo', field: 'service_types' },
                    { type: 'line', title: 'Evolu√ß√£o de Custos', field: 'cost_timeline' }
                ],
                tableColumns: [
                    { title: 'Data', field: 'date' },
                    { title: 'Ve√≠culo', field: 'vehiclePlate' },
                    { title: 'Tipo de Servi√ßo', field: 'serviceType' },
                    { title: 'Descri√ß√£o', field: 'description' },
                    { title: 'Custo (R$)', field: 'cost' },
                    { title: 'Status', field: 'status' }
                ]
            }
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Fleet Copilot BI');
            console.log('üìä Enterprise ID:', CONFIG.ENTERPRISE_ID);
            console.log('üìÖ Per√≠odo:', CONFIG.DAYS, 'dias');
            
            setupEventListeners();
        });

        // Event Listeners
        function setupEventListeners() {
            // Sele√ß√£o de BI
            document.querySelectorAll('.bi-card').forEach(card => {
                card.addEventListener('click', function() {
                    const collection = this.dataset.collection;
                    selectCollection(collection);
                });
            });
        }

        // Sele√ß√£o de Collection
        function selectCollection(collection) {
            console.log('üìä Selecionando collection:', collection);
            
            // Atualizar visual
            document.querySelectorAll('.bi-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-collection="${collection}"]`).classList.add('active');
            
            // Atualizar estado
            currentCollection = collection;
            
            // Carregar dados e interface
            loadCollectionData(collection);
        }

        // Carregar dados da collection
        async function loadCollectionData(collection) {
            try {
                console.log('üì° Carregando dados para:', collection);
                
                // Mostrar loading
                showLoading();
                
                // Configurar interface
                setupCollectionInterface(collection);
                
                // Carregar dados
                const data = await fetchCollectionData(collection);
                currentData = data;
                
                // Renderizar componentes
                renderMetrics(collection, data);
                renderInsights(collection, data);
                renderCharts(collection, data);
                renderTable(collection, data);
                
                console.log('‚úÖ Dados carregados com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                showError('Erro ao carregar dados: ' + error.message);
            }
        }

        // Configurar interface da collection
        function setupCollectionInterface(collection) {
            const config = COLLECTION_CONFIGS[collection];
            
            // Configurar filtros
            setupFilters(collection, config.filters);
            
            // Mostrar se√ß√µes com verifica√ß√£o de exist√™ncia
            const sections = ['filtersSection', 'metricsSection', 'insightsSection', 'chartsSection', 'tableSection'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'block';
                }
            });
            
            // Atualizar t√≠tulos com verifica√ß√£o de exist√™ncia
            const filtersTitle = document.getElementById('filtersTitle');
            if (filtersTitle) {
                filtersTitle.textContent = `Filtros - ${config.title}`;
            }
            
            const tableTitle = document.getElementById('tableTitle');
            if (tableTitle) {
                tableTitle.textContent = `Dados - ${config.title}`;
            }
        }

        // Configurar filtros
        function setupFilters(collection, filters) {
            const container = document.getElementById('filtersContainer');
            if (!container) {
                console.error('‚ùå Container de filtros n√£o encontrado');
                return;
            }
            
            container.innerHTML = '';
            
            filters.forEach(filter => {
                const col = document.createElement('div');
                col.className = 'col-md-2 col-sm-4 col-6';
                
                let filterHTML = '';
                
                switch (filter.type) {
                    case 'daterange':
                        filterHTML = `
                            <label class="form-label">${filter.label}</label>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="date" class="form-control form-control-sm" id="startDate">
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-control form-control-sm" id="endDate">
                                </div>
                            </div>
                        `;
                        break;
                    case 'select':
                        filterHTML = `
                            <label class="form-label">${filter.label}</label>
                            <select class="form-select form-select-sm" id="${filter.field || filter.label.toLowerCase().replace(/\s+/g, '')}">
                                <option value="">Todos</option>
                            </select>
                        `;
                        break;
                    case 'range':
                        filterHTML = `
                            <label class="form-label">${filter.label}</label>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" placeholder="Min">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" placeholder="Max">
                                </div>
                            </div>
                        `;
                        break;
                }
                
                col.innerHTML = filterHTML;
                container.appendChild(col);
            });
            
            // Adicionar bot√µes de a√ß√£o
            const actionsCol = document.createElement('div');
            actionsCol.className = 'col-md-2 col-sm-4 col-6 d-flex align-items-end';
            actionsCol.innerHTML = `
                <div class="w-100">
                    <button class="btn btn-primary btn-sm w-100 mb-1" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                    <button class="btn btn-outline-primary btn-sm w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                </div>
            `;
            container.appendChild(actionsCol);
        }

        // Mapeamento de collections para rotas da API Firebase BI
        const API_ROUTES = {
            'checklist': 'checklist',
            'trips': 'driver-trips', 
            'alerts': 'alerts-checkin',
            'maintenance': 'incidents'
        };

        // Buscar dados da collection
        async function fetchCollectionData(collection) {
            const apiRoute = API_ROUTES[collection] || collection;
            const url = `${CONFIG.API_BASE_URL}/${apiRoute}?enterpriseId=${CONFIG.ENTERPRISE_ID}&days=${CONFIG.DAYS}`;
            
            console.log('üîó Fazendo requisi√ß√£o para:', url);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // API Firebase BI retorna dados diretamente (array ou objeto)
            // N√£o tem wrapper com success/data
            if (Array.isArray(result)) {
                return result; // Dados diretos em array
            } else if (result && typeof result === 'object') {
                // Se tem propriedade data, usar ela, sen√£o usar o objeto todo
                return result.data || result;
            } else {
                throw new Error('Formato de dados inv√°lido da API');
            }
        }

        // Renderizar m√©tricas
        function renderMetrics(collection, data) {
            const config = COLLECTION_CONFIGS[collection];
            const container = document.getElementById('metricsContainer');
            container.innerHTML = '';
            
            config.metrics.forEach(metric => {
                const value = data[metric.field] || 0;
                const formattedValue = typeof value === 'number' ? 
                    (metric.suffix === '%' ? value.toFixed(1) : value.toLocaleString()) : value;
                
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6';
                col.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-icon">
                            <i class="${metric.icon}"></i>
                        </div>
                        <div class="metric-value">${formattedValue}${metric.suffix || ''}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // Renderizar insights de IA
        async function renderInsights(collection, data) {
            const container = document.getElementById('insightsContainer');
            
            try {
                // Gerar insights baseados nos dados
                const insights = generateAIInsights(collection, data);
                
                container.innerHTML = '';
                
                if (insights.length === 0) {
                    container.innerHTML = `
                        <div class="insight-item">
                            <div class="insight-type">Informa√ß√£o</div>
                            <p class="insight-text">Dados insuficientes para gerar insights. Aguarde mais dados serem coletados.</p>
                        </div>
                    `;
                    return;
                }
                
                insights.forEach(insight => {
                    const item = document.createElement('div');
                    item.className = 'insight-item';
                    item.innerHTML = `
                        <div class="insight-type">${insight.type}</div>
                        <p class="insight-text">${insight.message}</p>
                    `;
                    container.appendChild(item);
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar insights:', error);
                container.innerHTML = `
                    <div class="insight-item">
                        <div class="insight-type">Erro</div>
                        <p class="insight-text">N√£o foi poss√≠vel gerar insights no momento.</p>
                    </div>
                `;
            }
        }

        // Gerar insights de IA
        function generateAIInsights(collection, data) {
            const insights = [];
            
            switch (collection) {
                case 'checklist':
                    if (data.compliance_rate !== undefined) {
                        if (data.compliance_rate < 80) {
                            insights.push({
                                type: 'Alerta',
                                message: `Taxa de conformidade de ${data.compliance_rate.toFixed(1)}% est√° abaixo do ideal (80%). Recomenda-se revisar os processos de inspe√ß√£o.`
                            });
                        } else if (data.compliance_rate >= 95) {
                            insights.push({
                                type: 'Sucesso',
                                message: `Excelente taxa de conformidade de ${data.compliance_rate.toFixed(1)}%. A equipe est√° seguindo bem os protocolos.`
                            });
                        }
                    }
                    
                    if (data.total > 0 && data.vehicles > 0) {
                        const checksPerVehicle = data.total / data.vehicles;
                        if (checksPerVehicle < 2) {
                            insights.push({
                                type: 'Recomenda√ß√£o',
                                message: `M√©dia de ${checksPerVehicle.toFixed(1)} verifica√ß√µes por ve√≠culo. Considere aumentar a frequ√™ncia de inspe√ß√µes.`
                            });
                        }
                    }
                    break;
                    
                case 'trips':
                    if (data.total_distance && data.total_trips) {
                        const avgDistance = data.total_distance / data.total_trips;
                        if (avgDistance > 200) {
                            insights.push({
                                type: 'An√°lise',
                                message: `Dist√¢ncia m√©dia por viagem de ${avgDistance.toFixed(1)}km indica rotas longas. Avalie oportunidades de otimiza√ß√£o.`
                            });
                        }
                    }
                    
                    if (data.avg_speed) {
                        if (data.avg_speed > 80) {
                            insights.push({
                                type: 'Alerta',
                                message: `Velocidade m√©dia de ${data.avg_speed.toFixed(1)}km/h pode indicar excesso de velocidade. Monitore a condu√ß√£o.`
                            });
                        }
                    }
                    break;
                    
                case 'alerts':
                    if (data.active_alerts > 10) {
                        insights.push({
                            type: 'Urgente',
                            message: `${data.active_alerts} alertas ativos requerem aten√ß√£o imediata. Priorize a resolu√ß√£o dos alertas cr√≠ticos.`
                        });
                    }
                    
                    if (data.resolution_rate < 70) {
                        insights.push({
                            type: 'Melhoria',
                            message: `Taxa de resolu√ß√£o de ${data.resolution_rate}% pode ser melhorada. Revise os processos de atendimento.`
                        });
                    }
                    break;
                    
                case 'maintenance':
                    if (data.pending_services > 5) {
                        insights.push({
                            type: 'Aten√ß√£o',
                            message: `${data.pending_services} servi√ßos pendentes podem afetar a disponibilidade da frota. Agende as manuten√ß√µes.`
                        });
                    }
                    
                    if (data.total_cost && data.total_services) {
                        const avgCost = data.total_cost / data.total_services;
                        if (avgCost > 1000) {
                            insights.push({
                                type: 'Custo',
                                message: `Custo m√©dio por servi√ßo de R$ ${avgCost.toFixed(2)} est√° elevado. Analise fornecedores e processos.`
                            });
                        }
                    }
                    break;
            }
            
            return insights;
        }

        // Renderizar gr√°ficos
        function renderCharts(collection, data) {
            const config = COLLECTION_CONFIGS[collection];
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';
            
            config.charts.forEach((chartConfig, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
                    <div class="chart-card">
                        <div class="chart-title">${chartConfig.title}</div>
                        <canvas id="chart${index}" width="400" height="300"></canvas>
                    </div>
                `;
                container.appendChild(col);
                
                // Criar gr√°fico
                setTimeout(() => {
                    createChart(`chart${index}`, chartConfig, data);
                }, 100);
            });
        }

        // Criar gr√°fico
        function createChart(canvasId, chartConfig, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            let chartData = generateChartData(chartConfig, data);
            
            const chart = new Chart(ctx, {
                type: chartConfig.type,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: chartConfig.type !== 'doughnut' && chartConfig.type !== 'pie' ? {
                        x: {
                            ticks: { color: '#bdc3c7' },
                            grid: { color: '#4a5568' }
                        },
                        y: {
                            ticks: { color: '#bdc3c7' },
                            grid: { color: '#4a5568' }
                        }
                    } : {}
                }
            });
        }

        // Gerar dados do gr√°fico
        function generateChartData(chartConfig, data) {
            const colors = ['#1abc9c', '#3498db', '#e74c3c', '#f39c12', '#9b59b6', '#2ecc71'];
            
            // Dados de exemplo baseados na collection
            switch (chartConfig.field) {
                case 'compliance':
                    return {
                        labels: ['Conforme', 'N√£o Conforme'],
                        datasets: [{
                            data: [data.compliant || 70, data.non_compliant || 30],
                            backgroundColor: ['#1abc9c', '#e74c3c']
                        }]
                    };
                    
                case 'vehicles':
                    return {
                        labels: ['Ve√≠culo A', 'Ve√≠culo B', 'Ve√≠culo C', 'Ve√≠culo D'],
                        datasets: [{
                            label: 'Verifica√ß√µes',
                            data: [12, 8, 15, 6],
                            backgroundColor: colors[0]
                        }]
                    };
                    
                case 'timeline':
                    return {
                        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'Conformidade (%)',
                            data: [85, 92, 78, 88, 95, 82, 90],
                            borderColor: colors[0],
                            backgroundColor: colors[0] + '20',
                            fill: true
                        }]
                    };
                    
                default:
                    return {
                        labels: ['Item 1', 'Item 2', 'Item 3'],
                        datasets: [{
                            data: [30, 45, 25],
                            backgroundColor: colors.slice(0, 3)
                        }]
                    };
            }
        }

        // Renderizar tabela
        function renderTable(collection, data) {
            const config = COLLECTION_CONFIGS[collection];
            
            // Configurar cabe√ßalho
            const thead = document.getElementById('tableHead');
            thead.innerHTML = `
                <tr>
                    ${config.tableColumns.map(col => `<th>${col.title}</th>`).join('')}
                </tr>
            `;
            
            // Configurar dados (exemplo)
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Dados de exemplo baseados na collection
            const sampleData = generateSampleTableData(collection, config.tableColumns);
            
            sampleData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = config.tableColumns.map(col => {
                    let value = row[col.field] || '-';
                    
                    // Formata√ß√£o especial para alguns campos
                    if (col.field === 'noCompliant') {
                        value = value ? '<span class="status-badge status-nao-conforme">N√£o Conforme</span>' : '<span class="status-badge status-conforme">Conforme</span>';
                    } else if (col.field === 'status') {
                        const statusClass = value === 'Ativo' ? 'status-nao-conforme' : 
                                          value === 'Resolvido' ? 'status-conforme' : 'status-pendente';
                        value = `<span class="status-badge ${statusClass}">${value}</span>`;
                    }
                    
                    return `<td>${value}</td>`;
                }).join('');
                tbody.appendChild(tr);
            });
            
            // Inicializar DataTable
            setTimeout(() => {
                if (currentTable) {
                    currentTable.destroy();
                }
                
                currentTable = $('#dataTable').DataTable({
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: '<i class="fas fa-file-excel"></i> Excel',
                            className: 'btn btn-success btn-sm'
                        },
                        {
                            extend: 'pdfHtml5',
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            className: 'btn btn-danger btn-sm'
                        },
                        {
                            extend: 'csvHtml5',
                            text: '<i class="fas fa-file-csv"></i> CSV',
                            className: 'btn btn-info btn-sm'
                        }
                    ],
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
                    },
                    pageLength: 10,
                    responsive: true
                });
            }, 200);
        }

        // Gerar dados de exemplo para tabela
        function generateSampleTableData(collection, columns) {
            const data = [];
            const sampleCount = 15;
            
            for (let i = 0; i < sampleCount; i++) {
                const row = {};
                
                columns.forEach(col => {
                    switch (col.field) {
                        case 'timestamp':
                        case 'date':
                            row[col.field] = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR');
                            break;
                        case 'vehiclePlate':
                            row[col.field] = `ABC-${Math.floor(Math.random() * 9000) + 1000}`;
                            break;
                        case 'driverName':
                            const drivers = ['Jo√£o Silva', 'Maria Santos', 'Pedro Oliveira', 'Ana Costa', 'Carlos Lima'];
                            row[col.field] = drivers[Math.floor(Math.random() * drivers.length)];
                            break;
                        case 'itemName':
                            const items = ['Farol', 'Freios', 'Pneus', '√ìleo', 'Bateria'];
                            row[col.field] = items[Math.floor(Math.random() * items.length)];
                            break;
                        case 'noCompliant':
                            row[col.field] = Math.random() > 0.7;
                            break;
                        case 'status':
                            const statuses = ['Ativo', 'Resolvido', 'Pendente'];
                            row[col.field] = statuses[Math.floor(Math.random() * statuses.length)];
                            break;
                        case 'distance':
                            row[col.field] = Math.floor(Math.random() * 500) + 50;
                            break;
                        case 'cost':
                            row[col.field] = 'R$ ' + (Math.random() * 2000 + 100).toFixed(2);
                            break;
                        default:
                            row[col.field] = `Dados ${i + 1}`;
                    }
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Aplicar filtros
        function applyFilters() {
            console.log('üîç Aplicando filtros...');
            // Recarregar dados com filtros aplicados
            if (currentCollection) {
                loadCollectionData(currentCollection);
            }
        }

        // Limpar filtros
        function clearFilters() {
            console.log('üßπ Limpando filtros...');
            document.querySelectorAll('#filtersContainer input, #filtersContainer select').forEach(input => {
                input.value = '';
            });
            applyFilters();
        }

        // Mostrar loading
        function showLoading() {
            const sections = ['metricsSection', 'insightsSection', 'chartsSection', 'tableSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando dados...</p>
                        </div>
                    `;
                }
            });
        }

        // Mostrar erro
        function showError(message) {
            const sections = ['metricsSection', 'insightsSection', 'chartsSection', 'tableSection'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.innerHTML = `
                        <div class="loading">
                            <i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i>
                            <p>${message}</p>
                        </div>
                    `;
                }
            });
        }

        // Log de debug
        console.log('üìä Fleet Copilot BI carregado');
        console.log('üé® Tema: Escuro com cores teal/turquesa');
        console.log('üîß Configura√ß√µes:', CONFIG);
    </script>
</body>
</html>

