<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Manutenção</title>
    <!-- Importar Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Importar SheetJS para exportação Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Importar jsPDF e AutoTable para exportação PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Cores principais */
            --background: #1a1e23;
            --card-bg: #2a2e33;
            --primary: #14d8b4;
            --primary-dark: #0fb8a0;
            --secondary: #8a56e2;
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --border: rgba(255, 255, 255, 0.1);
            
            /* Cores de status */
            --success: #14d8b4;
            --warning: #f0b429;
            --error: #e74c3c;
            
            /* Cores de gráficos */
            --chart-purple: #8a56e2;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .header-icon {
            width: 32px;
            height: 32px;
            fill: var(--primary);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }
        
        /* Filtros */
        .filters {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .filters-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .filters-title svg {
            width: 20px;
            height: 20px;
            fill: var(--primary);
        }
        
        .filters-title h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            font-size: 14px;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(20, 216, 180, 0.2);
        }
        
        .filters-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: #000;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--card-bg);
            color: var(--text);
        }
        
        /* Cards de métricas */
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .metric-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .metric-icon {
            width: 24px;
            height: 24px;
            fill: var(--primary);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .metric-change {
            font-size: 14px;
            font-weight: 500;
        }
        
        .metric-change.positive {
            color: var(--success);
        }
        
        .metric-change.negative {
            color: var(--error);
        }
        
        /* Alertas */
        .alerts-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .section-title svg {
            width: 20px;
            height: 20px;
            fill: var(--warning);
        }
        
        .section-title h3 {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Gráficos */
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Tabelas */
        .tables-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
        }
        
        .table-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            background: var(--background);
            border-radius: 8px;
            padding: 4px;
        }
        
        .table-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .table-tab.active {
            background: var(--primary);
            color: #000;
        }
        
        .table-content {
            display: none;
        }
        
        .table-content.active {
            display: block;
        }
        
        .table-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-export {
            padding: 8px 16px;
            background: var(--secondary);
            color: var(--text);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-export:hover {
            background: #7c4ddb;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--background);
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--card-bg);
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        
        td {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-normal {
            background: rgba(20, 216, 180, 0.2);
            color: var(--success);
        }
        
        .status-alert {
            background: rgba(240, 180, 41, 0.2);
            color: var(--warning);
        }
        
        .status-critical {
            background: rgba(231, 76, 60, 0.2);
            color: var(--error);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 30, 35, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
            color: var(--text);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics {
                grid-template-columns: 1fr;
            }
            
            .charts {
                grid-template-columns: 1fr;
            }
            
            .filters-actions {
                flex-direction: column;
            }
            
            .table-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Carregando dados...</h3>
            <p>Conectando com as APIs do Firebase</p>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <svg class="header-icon" viewBox="0 0 24 24">
                <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
            </svg>
            <h1>BI Manutenção</h1>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <div class="filters-title">
                <svg viewBox="0 0 24 24">
                    <path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/>
                </svg>
                <h3>Filtros</h3>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="startDate">Data Início</label>
                    <input type="date" id="startDate" name="startDate">
                </div>
                <div class="filter-group">
                    <label for="endDate">Data Fim</label>
                    <input type="date" id="endDate" name="endDate">
                </div>
                <div class="filter-group">
                    <label for="serviceType">Tipo de Serviço</label>
                    <select id="serviceType" name="serviceType">
                        <option value="">Todos</option>
                        <option value="Preventiva">Preventiva</option>
                        <option value="Corretiva">Corretiva</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="assetType">Tipo de Ativo</label>
                    <select id="assetType" name="assetType">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="vehiclePlate">Placa</label>
                    <select id="vehiclePlate" name="vehiclePlate">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="garage">Garagem</label>
                    <select id="garage" name="garage">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="branch">Filial</label>
                    <select id="branch" name="branch">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="costCenter">Centro de Custo</label>
                    <select id="costCenter" name="costCenter">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div class="filters-actions">
                <button class="btn btn-primary" onclick="applyFilters()">Aplicar Filtros</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Limpar Filtros</button>
            </div>
        </div>

        <!-- Métricas principais -->
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Score de Manutenção</span>
                    <svg class="metric-icon" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <div class="metric-value" id="maintenanceScore">-</div>
                <div class="metric-change" id="maintenanceScoreChange">-</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Total de Serviços</span>
                    <svg class="metric-icon" viewBox="0 0 24 24">
                        <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                    </svg>
                </div>
                <div class="metric-value" id="totalServices">-</div>
                <div class="metric-change" id="totalServicesChange">-</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">% Preventivas vs Corretivas</span>
                    <svg class="metric-icon" viewBox="0 0 24 24">
                        <path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/>
                    </svg>
                </div>
                <div class="metric-value" id="preventiveRatio">-</div>
                <div class="metric-change" id="preventiveRatioChange">-</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Serviços Pendentes</span>
                    <svg class="metric-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="metric-value" id="pendingServices">-</div>
                <div class="metric-change" id="pendingServicesChange">-</div>
            </div>
        </div>

        <!-- Alertas de Preventiva -->
        <div class="alerts-section">
            <div class="section-title">
                <svg viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h3>Alertas de Preventiva por Quilometragem</h3>
            </div>
            <div class="table-wrapper">
                <table id="alertsTable">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Modelo</th>
                            <th>Km Atual</th>
                            <th>Última Preventiva</th>
                            <th>Próxima Preventiva</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="charts">
            <div class="chart-card">
                <h3 class="chart-title">Score de Manutenção por Mês</h3>
                <div class="chart-container">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Serviços Executados por Mês</h3>
                <div class="chart-container">
                    <canvas id="servicesChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Corretivas por Grupo de Serviço</h3>
                <div class="chart-container">
                    <canvas id="correctiveChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Preventivas por Tipo de Serviço</h3>
                <div class="chart-container">
                    <canvas id="preventiveChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Serviços por Origem</h3>
                <div class="chart-container">
                    <canvas id="originChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Pendências por Prioridade</h3>
                <div class="chart-container">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="tables-section">
            <div class="section-title">
                <svg viewBox="0 0 24 24">
                    <path d="M3 3v18h18V3H3zm16 16H5V5h14v14zm-10-7h2V9h-2v3zm0 4h2v-3h-2v3zm4-4h2V9h-2v3zm0 4h2v-3h-2v3z"/>
                </svg>
                <h3>Tabelas Detalhadas</h3>
            </div>
            
            <div class="table-tabs">
                <button class="table-tab active" onclick="showTable('corrective')">Corretivas Pendentes</button>
                <button class="table-tab" onclick="showTable('preventive')">Preventivas Pendentes</button>
                <button class="table-tab" onclick="showTable('executed')">Serviços Executados</button>
            </div>
            
            <!-- Corretivas Pendentes -->
            <div id="correctiveTable" class="table-content active">
                <div class="table-header">
                    <h4>Corretivas Pendentes</h4>
                    <div class="table-actions">
                        <button class="btn-export" onclick="exportToExcel('corrective')">Excel</button>
                        <button class="btn-export" onclick="exportToPDF('corrective')">PDF</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="correctivePendingTable">
                        <thead>
                            <tr>
                                <th>OS</th>
                                <th>Placa</th>
                                <th>Tipo de Ativo</th>
                                <th>Grupo de Serviço</th>
                                <th>Origem</th>
                                <th>Data Abertura</th>
                                <th>Previsão</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados serão preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Preventivas Pendentes -->
            <div id="preventiveTable" class="table-content">
                <div class="table-header">
                    <h4>Preventivas Pendentes</h4>
                    <div class="table-actions">
                        <button class="btn-export" onclick="exportToExcel('preventive')">Excel</button>
                        <button class="btn-export" onclick="exportToPDF('preventive')">PDF</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="preventivePendingTable">
                        <thead>
                            <tr>
                                <th>OS</th>
                                <th>Placa</th>
                                <th>Plano</th>
                                <th>Grupo de Serviço</th>
                                <th>Km Atual</th>
                                <th>Limite Km</th>
                                <th>Previsão</th>
                                <th>Próxima Preventiva</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados serão preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Serviços Executados -->
            <div id="executedTable" class="table-content">
                <div class="table-header">
                    <h4>Serviços Executados</h4>
                    <div class="table-actions">
                        <button class="btn-export" onclick="exportToExcel('executed')">Excel</button>
                        <button class="btn-export" onclick="exportToPDF('executed')">PDF</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="executedServicesTable">
                        <thead>
                            <tr>
                                <th>OS</th>
                                <th>Tipo</th>
                                <th>Placa</th>
                                <th>Grupo de Serviço</th>
                                <th>Data Início</th>
                                <th>Data Conclusão</th>
                                <th>Responsável</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dados serão preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let checklistData = [];
        let vehiclesData = [];
        let filteredData = [];
        let charts = {};

        // Função para obter o enterpriseId da URL
        function getEnterpriseId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('enterpriseId') || 'sA9EmrE3ymtnBqJKcYn7';
        }

        // Dados mockados para fallback
        const mockChecklistData = [
            {
                osNumber: "OS001",
                osType: "Preventiva",
                vehiclePlate: "ABC-1234",
                assetTypePreventive: "Caminhão",
                serviceGroup: "Motor",
                IssueSource: "Inspeção",
                osOpenDate: "2024-01-15",
                estimatedCompletionDate: "2024-01-20",
                actualStartDate: "2024-01-16",
                actualCompletionDate: "2024-01-19",
                assignedTo: "João Silva",
                openOS: false,
                priority: "Alta",
                planName: "Plano A",
                ItemsPreventive: [{ serviceItem: "Troca de óleo" }]
            },
            {
                osNumber: "OS002",
                osType: "Corretiva",
                vehiclePlate: "DEF-5678",
                assetTypePreventive: "Van",
                serviceGroup: "Freios",
                IssueSource: "Motorista",
                osOpenDate: "2024-01-20",
                estimatedCompletionDate: "2024-01-25",
                actualStartDate: null,
                actualCompletionDate: null,
                assignedTo: "Maria Santos",
                openOS: true,
                priority: "Crítica",
                planName: null,
                ItemsPreventive: []
            },
            {
                osNumber: "OS003",
                osType: "Preventiva",
                vehiclePlate: "GHI-9012",
                assetTypePreventive: "Caminhão",
                serviceGroup: "Transmissão",
                IssueSource: "Programada",
                osOpenDate: "2024-02-01",
                estimatedCompletionDate: "2024-02-05",
                actualStartDate: "2024-02-02",
                actualCompletionDate: "2024-02-04",
                assignedTo: "Carlos Lima",
                openOS: false,
                priority: "Normal",
                planName: "Plano B",
                ItemsPreventive: [{ serviceItem: "Revisão geral" }]
            },
            {
                osNumber: "OS004",
                osType: "Corretiva",
                vehiclePlate: "JKL-3456",
                assetTypePreventive: "Van",
                serviceGroup: "Elétrica",
                IssueSource: "Motorista",
                osOpenDate: "2024-02-10",
                estimatedCompletionDate: "2024-02-15",
                actualStartDate: null,
                actualCompletionDate: null,
                assignedTo: "Ana Costa",
                openOS: true,
                priority: "Alta",
                planName: null,
                ItemsPreventive: []
            }
        ];

        const mockVehiclesData = [
            {
                vehiclePlate: "ABC-1234",
                vehicleModel: "Mercedes Sprinter",
                currentMileage: 45000,
                lastPreventiveMaintenanceMileage: 40000,
                maximumMileageAllowance: 10000,
                garage: "Garagem Central",
                branch: "Filial SP",
                costCenter: "CC001"
            },
            {
                vehiclePlate: "DEF-5678",
                vehicleModel: "Iveco Daily",
                currentMileage: 32000,
                lastPreventiveMaintenanceMileage: 25000,
                maximumMileageAllowance: 10000,
                garage: "Garagem Norte",
                branch: "Filial RJ",
                costCenter: "CC002"
            },
            {
                vehiclePlate: "GHI-9012",
                vehicleModel: "Ford Transit",
                currentMileage: 28000,
                lastPreventiveMaintenanceMileage: 20000,
                maximumMileageAllowance: 15000,
                garage: "Garagem Sul",
                branch: "Filial MG",
                costCenter: "CC003"
            },
            {
                vehiclePlate: "JKL-3456",
                vehicleModel: "Fiat Ducato",
                currentMileage: 52000,
                lastPreventiveMaintenanceMileage: 45000,
                maximumMileageAllowance: 10000,
                garage: "Garagem Oeste",
                branch: "Filial RS",
                costCenter: "CC004"
            }
        ];

        // Função para carregar dados das APIs
        async function loadData() {
            const enterpriseId = getEnterpriseId();
            console.log('Carregando dados para enterpriseId:', enterpriseId);

            try {
                // Carregar dados do checklist
                console.log('Carregando dados do checklist...');
                try {
                    const checklistResponse = await Promise.race([
                        fetch(`https://firebase-bi-api.onrender.com/checklist?enterpriseId=${enterpriseId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                    ]);

                    if (checklistResponse.ok) {
                        const checklistResult = await checklistResponse.json();
                        checklistData = checklistResult.data || [];
                        console.log('Dados do checklist carregados:', checklistData.length, 'registros');
                    } else {
                        console.warn('Erro ao carregar checklist, usando dados mockados');
                        checklistData = mockChecklistData;
                    }
                } catch (checklistError) {
                    console.warn('Erro na API de checklist, usando dados mockados:', checklistError);
                    checklistData = mockChecklistData;
                }

                // Carregar dados dos veículos
                console.log('Carregando dados dos veículos...');
                try {
                    const vehiclesResponse = await Promise.race([
                        fetch(`https://firebase-bi-api.onrender.com/vehicles?enterpriseId=${enterpriseId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))
                    ]);

                    if (vehiclesResponse.ok) {
                        const vehiclesResult = await vehiclesResponse.json();
                        vehiclesData = vehiclesResult.data || [];
                        console.log('Dados dos veículos carregados:', vehiclesData.length, 'registros');
                    } else {
                        console.warn('Erro ao carregar veículos, usando dados mockados');
                        vehiclesData = mockVehiclesData;
                    }
                } catch (vehiclesError) {
                    console.warn('API de veículos não disponível, usando dados mockados:', vehiclesError);
                    vehiclesData = mockVehiclesData;
                }

                // Filtrar apenas dados de manutenção
                checklistData = checklistData.filter(item => 
                    item.osType === 'Preventiva' || item.osType === 'Corretiva'
                );

                console.log('Dados de manutenção filtrados:', checklistData.length, 'registros');

                // Processar dados
                processData();
                populateFilters();
                updateMetrics();
                updateAlerts();
                createCharts();
                updateTables();

            } catch (error) {
                console.error('Erro geral ao carregar dados:', error);
                // Usar dados mockados em caso de erro
                checklistData = mockChecklistData;
                vehiclesData = mockVehiclesData;
                
                processData();
                populateFilters();
                updateMetrics();
                updateAlerts();
                createCharts();
                updateTables();
            } finally {
                // Remover overlay de carregamento
                setTimeout(() => {
                    const overlay = document.getElementById('loadingOverlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                }, 1000);
            }
        }

        // Função para processar dados
        function processData() {
            filteredData = [...checklistData];
            
            // Adicionar campos calculados
            filteredData.forEach(item => {
                const vehicle = vehiclesData.find(v => v.vehiclePlate === item.vehiclePlate);
                if (vehicle) {
                    item.currentMileage = vehicle.currentMileage;
                    item.lastPreventiveMaintenanceMileage = vehicle.lastPreventiveMaintenanceMileage;
                    item.maximumMileageAllowance = vehicle.maximumMileageAllowance;
                    item.nextPreventiveKm = (vehicle.lastPreventiveMaintenanceMileage || 0) + (vehicle.maximumMileageAllowance || 10000);
                    item.garage = vehicle.garage;
                    item.branch = vehicle.branch;
                    item.costCenter = vehicle.costCenter;
                    item.vehicleModel = vehicle.vehicleModel;
                }
            });
        }

        // Função para popular filtros
        function populateFilters() {
            const assetTypes = [...new Set(filteredData.map(item => item.assetTypePreventive).filter(Boolean))];
            const plates = [...new Set(filteredData.map(item => item.vehiclePlate).filter(Boolean))];
            const garages = [...new Set(filteredData.map(item => item.garage).filter(Boolean))];
            const branches = [...new Set(filteredData.map(item => item.branch).filter(Boolean))];
            const costCenters = [...new Set(filteredData.map(item => item.costCenter).filter(Boolean))];

            populateSelect('assetType', assetTypes);
            populateSelect('vehiclePlate', plates);
            populateSelect('garage', garages);
            populateSelect('branch', branches);
            populateSelect('costCenter', costCenters);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            
            // Limpar opções existentes (exceto a primeira)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Adicionar novas opções
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restaurar valor selecionado se ainda existir
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Função para atualizar métricas
        function updateMetrics() {
            const totalServices = filteredData.length;
            const preventiveServices = filteredData.filter(item => item.osType === 'Preventiva').length;
            const correctiveServices = filteredData.filter(item => item.osType === 'Corretiva').length;
            const pendingServices = filteredData.filter(item => item.openOS === true).length;
            
            // Calcular score de manutenção
            const completedServices = filteredData.filter(item => item.actualCompletionDate).length;
            const onTimeServices = filteredData.filter(item => 
                item.actualCompletionDate && 
                new Date(item.actualCompletionDate) <= new Date(item.estimatedCompletionDate)
            ).length;
            
            const executionRate = totalServices > 0 ? (completedServices / totalServices) * 100 : 0;
            const onTimeRate = completedServices > 0 ? (onTimeServices / completedServices) * 100 : 0;
            const pendingRate = totalServices > 0 ? (pendingServices / totalServices) * 100 : 0;
            
            const maintenanceScore = Math.round((executionRate * 0.4) + (onTimeRate * 0.4) + ((100 - pendingRate) * 0.2));
            
            const preventiveRatio = totalServices > 0 ? Math.round((preventiveServices / totalServices) * 100) : 0;
            
            // Atualizar elementos
            const scoreElement = document.getElementById('maintenanceScore');
            const totalElement = document.getElementById('totalServices');
            const ratioElement = document.getElementById('preventiveRatio');
            const pendingElement = document.getElementById('pendingServices');
            
            if (scoreElement) scoreElement.textContent = maintenanceScore + '/100';
            if (totalElement) totalElement.textContent = totalServices.toLocaleString();
            if (ratioElement) ratioElement.textContent = preventiveRatio + '% / ' + (100 - preventiveRatio) + '%';
            if (pendingElement) pendingElement.textContent = pendingServices.toLocaleString();
            
            // Atualizar mudanças (simuladas)
            const scoreChangeElement = document.getElementById('maintenanceScoreChange');
            const totalChangeElement = document.getElementById('totalServicesChange');
            const ratioChangeElement = document.getElementById('preventiveRatioChange');
            const pendingChangeElement = document.getElementById('pendingServicesChange');
            
            if (scoreChangeElement) {
                scoreChangeElement.textContent = '+2.5% vs mês anterior';
                scoreChangeElement.className = 'metric-change positive';
            }
            
            if (totalChangeElement) {
                totalChangeElement.textContent = '+12 vs mês anterior';
                totalChangeElement.className = 'metric-change positive';
            }
            
            if (ratioChangeElement) {
                ratioChangeElement.textContent = '+5% preventivas';
                ratioChangeElement.className = 'metric-change positive';
            }
            
            if (pendingChangeElement) {
                pendingChangeElement.textContent = '-3 vs semana anterior';
                pendingChangeElement.className = 'metric-change positive';
            }
        }

        // Função para atualizar alertas
        function updateAlerts() {
            const alertsTableBody = document.querySelector('#alertsTable tbody');
            if (!alertsTableBody) return;
            
            alertsTableBody.innerHTML = '';
            
            vehiclesData.forEach(vehicle => {
                const currentMileage = vehicle.currentMileage || 0;
                const lastPreventive = vehicle.lastPreventiveMaintenanceMileage || 0;
                const maxMileage = vehicle.maximumMileageAllowance || 10000;
                const nextPreventive = lastPreventive + maxMileage;
                const margin = 500;
                
                let alertStatus = 'Normal';
                let statusClass = 'status-normal';
                
                if (currentMileage >= nextPreventive) {
                    alertStatus = 'Vencida';
                    statusClass = 'status-critical';
                } else if (currentMileage >= (nextPreventive - margin)) {
                    alertStatus = 'Alerta';
                    statusClass = 'status-alert';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle.vehiclePlate || '-'}</td>
                    <td>${vehicle.vehicleModel || '-'}</td>
                    <td>${currentMileage.toLocaleString()} km</td>
                    <td>${lastPreventive.toLocaleString()} km</td>
                    <td>${nextPreventive.toLocaleString()} km</td>
                    <td><span class="status-badge ${statusClass}">${alertStatus}</span></td>
                `;
                alertsTableBody.appendChild(row);
            });
        }

        // Função para criar gráficos
        function createCharts() {
            try {
                createScoreChart();
                createServicesChart();
                createCorrectiveChart();
                createPreventiveChart();
                createOriginChart();
                createPriorityChart();
            } catch (error) {
                console.error('Erro ao criar gráficos:', error);
            }
        }

        function createScoreChart() {
            const ctx = document.getElementById('scoreChart');
            if (!ctx) return;
            
            // Dados simulados para os últimos 6 meses
            const months = ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const scores = [78, 82, 85, 88, 86, 90];
            
            if (charts.scoreChart) {
                charts.scoreChart.destroy();
            }
            
            charts.scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Score de Manutenção',
                        data: scores,
                        borderColor: '#14d8b4',
                        backgroundColor: 'rgba(20, 216, 180, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function createServicesChart() {
            const ctx = document.getElementById('servicesChart');
            if (!ctx) return;
            
            // Dados simulados para os últimos 6 meses
            const months = ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const preventive = [15, 18, 22, 20, 25, 28];
            const corrective = [8, 12, 10, 15, 11, 9];
            
            if (charts.servicesChart) {
                charts.servicesChart.destroy();
            }
            
            charts.servicesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Preventiva',
                            data: preventive,
                            backgroundColor: '#14d8b4',
                            borderColor: '#14d8b4',
                            borderWidth: 1
                        },
                        {
                            label: 'Corretiva',
                            data: corrective,
                            backgroundColor: '#8a56e2',
                            borderColor: '#8a56e2',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createCorrectiveChart() {
            const ctx = document.getElementById('correctiveChart');
            if (!ctx) return;
            
            const correctiveData = filteredData.filter(item => item.osType === 'Corretiva');
            const serviceGroups = {};
            
            correctiveData.forEach(item => {
                const group = item.serviceGroup || 'Outros';
                serviceGroups[group] = (serviceGroups[group] || 0) + 1;
            });
            
            const labels = Object.keys(serviceGroups);
            const data = Object.values(serviceGroups);
            const colors = ['#14d8b4', '#8a56e2', '#f0b429', '#e74c3c', '#3498db'];
            
            if (charts.correctiveChart) {
                charts.correctiveChart.destroy();
            }
            
            charts.correctiveChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1a1e23',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createPreventiveChart() {
            const ctx = document.getElementById('preventiveChart');
            if (!ctx) return;
            
            const preventiveData = filteredData.filter(item => item.osType === 'Preventiva');
            const serviceItems = {};
            
            preventiveData.forEach(item => {
                if (item.ItemsPreventive && item.ItemsPreventive.length > 0) {
                    item.ItemsPreventive.forEach(preventiveItem => {
                        const serviceItem = preventiveItem.serviceItem || 'Outros';
                        serviceItems[serviceItem] = (serviceItems[serviceItem] || 0) + 1;
                    });
                } else {
                    serviceItems['Outros'] = (serviceItems['Outros'] || 0) + 1;
                }
            });
            
            const labels = Object.keys(serviceItems);
            const data = Object.values(serviceItems);
            const colors = ['#14d8b4', '#8a56e2', '#f0b429', '#e74c3c', '#3498db'];
            
            if (charts.preventiveChart) {
                charts.preventiveChart.destroy();
            }
            
            charts.preventiveChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1a1e23',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createOriginChart() {
            const ctx = document.getElementById('originChart');
            if (!ctx) return;
            
            const origins = {};
            filteredData.forEach(item => {
                const origin = item.IssueSource || 'Outros';
                origins[origin] = (origins[origin] || 0) + 1;
            });
            
            const labels = Object.keys(origins);
            const data = Object.values(origins);
            
            if (charts.originChart) {
                charts.originChart.destroy();
            }
            
            charts.originChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: data,
                        backgroundColor: '#14d8b4',
                        borderColor: '#14d8b4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function createPriorityChart() {
            const ctx = document.getElementById('priorityChart');
            if (!ctx) return;
            
            const pendingData = filteredData.filter(item => item.openOS === true);
            const priorities = {};
            
            pendingData.forEach(item => {
                const priority = item.priority || 'Normal';
                priorities[priority] = (priorities[priority] || 0) + 1;
            });
            
            const labels = Object.keys(priorities);
            const data = Object.values(priorities);
            
            if (charts.priorityChart) {
                charts.priorityChart.destroy();
            }
            
            charts.priorityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendências',
                        data: data,
                        backgroundColor: '#8a56e2',
                        borderColor: '#8a56e2',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Função para atualizar tabelas
        function updateTables() {
            updateCorrectivePendingTable();
            updatePreventivePendingTable();
            updateExecutedServicesTable();
        }

        function updateCorrectivePendingTable() {
            const tableBody = document.querySelector('#correctivePendingTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const correctivePending = filteredData.filter(item => 
                item.osType === 'Corretiva' && item.openOS === true
            );
            
            correctivePending.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.osNumber || '-'}</td>
                    <td>${item.vehiclePlate || '-'}</td>
                    <td>${item.assetTypePreventive || '-'}</td>
                    <td>${item.serviceGroup || '-'}</td>
                    <td>${item.IssueSource || '-'}</td>
                    <td>${formatDate(item.osOpenDate)}</td>
                    <td>${formatDate(item.estimatedCompletionDate)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updatePreventivePendingTable() {
            const tableBody = document.querySelector('#preventivePendingTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const preventivePending = filteredData.filter(item => 
                item.osType === 'Preventiva' && item.openOS === true
            );
            
            preventivePending.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.osNumber || '-'}</td>
                    <td>${item.vehiclePlate || '-'}</td>
                    <td>${item.planName || '-'}</td>
                    <td>${item.serviceGroup || '-'}</td>
                    <td>${(item.currentMileage || 0).toLocaleString()} km</td>
                    <td>${(item.maximumMileageAllowance || 0).toLocaleString()} km</td>
                    <td>${formatDate(item.estimatedCompletionDate)}</td>
                    <td>${(item.nextPreventiveKm || 0).toLocaleString()} km</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function updateExecutedServicesTable() {
            const tableBody = document.querySelector('#executedServicesTable tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const executedServices = filteredData.filter(item => 
                item.actualCompletionDate
            );
            
            executedServices.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.osNumber || '-'}</td>
                    <td>${item.osType || '-'}</td>
                    <td>${item.vehiclePlate || '-'}</td>
                    <td>${item.serviceGroup || '-'}</td>
                    <td>${formatDate(item.actualStartDate)}</td>
                    <td>${formatDate(item.actualCompletionDate)}</td>
                    <td>${item.assignedTo || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR');
            } catch (error) {
                return '-';
            }
        }

        // Função para aplicar filtros
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const serviceType = document.getElementById('serviceType').value;
            const assetType = document.getElementById('assetType').value;
            const vehiclePlate = document.getElementById('vehiclePlate').value;
            const garage = document.getElementById('garage').value;
            const branch = document.getElementById('branch').value;
            const costCenter = document.getElementById('costCenter').value;
            
            filteredData = checklistData.filter(item => {
                let matches = true;
                
                if (startDate && item.osOpenDate && new Date(item.osOpenDate) < new Date(startDate)) {
                    matches = false;
                }
                
                if (endDate && item.osOpenDate && new Date(item.osOpenDate) > new Date(endDate)) {
                    matches = false;
                }
                
                if (serviceType && item.osType !== serviceType) {
                    matches = false;
                }
                
                if (assetType && item.assetTypePreventive !== assetType) {
                    matches = false;
                }
                
                if (vehiclePlate && item.vehiclePlate !== vehiclePlate) {
                    matches = false;
                }
                
                if (garage && item.garage !== garage) {
                    matches = false;
                }
                
                if (branch && item.branch !== branch) {
                    matches = false;
                }
                
                if (costCenter && item.costCenter !== costCenter) {
                    matches = false;
                }
                
                return matches;
            });
            
            // Reprocessar dados com filtros aplicados
            updateMetrics();
            updateAlerts();
            createCharts();
            updateTables();
        }

        // Função para limpar filtros
        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('serviceType').value = '';
            document.getElementById('assetType').value = '';
            document.getElementById('vehiclePlate').value = '';
            document.getElementById('garage').value = '';
            document.getElementById('branch').value = '';
            document.getElementById('costCenter').value = '';
            
            filteredData = [...checklistData];
            
            updateMetrics();
            updateAlerts();
            createCharts();
            updateTables();
        }

        // Função para mostrar tabela
        function showTable(tableType) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.table-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Ocultar todas as tabelas
            document.querySelectorAll('.table-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar aba e tabela selecionadas
            event.target.classList.add('active');
            
            if (tableType === 'corrective') {
                document.getElementById('correctiveTable').classList.add('active');
            } else if (tableType === 'preventive') {
                document.getElementById('preventiveTable').classList.add('active');
            } else if (tableType === 'executed') {
                document.getElementById('executedTable').classList.add('active');
            }
        }

        // Funções de exportação
        function exportToExcel(tableType) {
            if (typeof XLSX === 'undefined') {
                alert('Biblioteca de exportação não carregada');
                return;
            }
            
            let data = [];
            let filename = '';
            
            if (tableType === 'corrective') {
                data = filteredData.filter(item => item.osType === 'Corretiva' && item.openOS === true);
                filename = 'corretivas_pendentes.xlsx';
            } else if (tableType === 'preventive') {
                data = filteredData.filter(item => item.osType === 'Preventiva' && item.openOS === true);
                filename = 'preventivas_pendentes.xlsx';
            } else if (tableType === 'executed') {
                data = filteredData.filter(item => item.actualCompletionDate);
                filename = 'servicos_executados.xlsx';
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Dados');
                XLSX.writeFile(wb, filename);
            } catch (error) {
                console.error('Erro ao exportar Excel:', error);
                alert('Erro ao exportar arquivo Excel');
            }
        }

        function exportToPDF(tableType) {
            if (typeof window.jspdf === 'undefined') {
                alert('Biblioteca de exportação PDF não carregada');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let title = '';
                let data = [];
                
                if (tableType === 'corrective') {
                    title = 'Corretivas Pendentes';
                    data = filteredData.filter(item => item.osType === 'Corretiva' && item.openOS === true);
                } else if (tableType === 'preventive') {
                    title = 'Preventivas Pendentes';
                    data = filteredData.filter(item => item.osType === 'Preventiva' && item.openOS === true);
                } else if (tableType === 'executed') {
                    title = 'Serviços Executados';
                    data = filteredData.filter(item => item.actualCompletionDate);
                }
                
                doc.text(title, 20, 20);
                
                const tableData = data.map(item => [
                    item.osNumber || '-',
                    item.vehiclePlate || '-',
                    item.osType || '-',
                    item.serviceGroup || '-',
                    formatDate(item.osOpenDate),
                    formatDate(item.estimatedCompletionDate)
                ]);
                
                doc.autoTable({
                    head: [['OS', 'Placa', 'Tipo', 'Grupo', 'Abertura', 'Previsão']],
                    body: tableData,
                    startY: 30
                });
                
                doc.save(`${title.toLowerCase().replace(/\s+/g, '_')}.pdf`);
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                alert('Erro ao exportar arquivo PDF');
            }
        }

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, iniciando aplicação...');
            loadData();
        });

        // Tratamento de erros globais
        window.addEventListener('error', function(event) {
            console.error('Erro global capturado:', event.error);
        });
    </script>
</body>
</html>

