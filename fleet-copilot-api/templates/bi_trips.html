<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Trips - An√°lise de Viagens</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #14d8b4;           
            --primary-dark: #0fb8a0;      
            --background: #1a1e23;        
            --surface: #2a2e33;           
            --surface-light: #3a3e43;     
            --surface-lighter: #4a4e53;   
            --text: #ffffff;              
            --text-secondary: #a0a0a0;    
            --text-muted: #707070;        
            --border: #3a3e43;            
            --border-light: #4a4e53;      
            --success: #14d8b4;           
            --warning: #f0b429;           
            --error: #e74c3c;             
            --info: #3b82f6;              
            --chart-purple: #8a56e2;      
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title svg {
            width: 32px;
            height: 32px;
            color: var(--primary);
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Filtros */
        .filters {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(20, 216, 180, 0.05);
        }

        .filters-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filters-title svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        .filters-title h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface-light);
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(20, 216, 180, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(20, 216, 180, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(20, 216, 180, 0.4);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-lighter);
            border-color: var(--border-light);
        }

        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-button:hover {
            color: var(--text);
        }

        .dashboard-content {
            display: none;
        }

        .dashboard-content.active {
            display: block;
        }

        /* M√©tricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(20, 216, 180, 0.05);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(20, 216, 180, 0.1);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            opacity: 0.8;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .metric-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-icon {
            width: 24px;
            height: 24px;
            color: var(--primary);
            opacity: 0.8;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-value.good {
            color: var(--success);
        }

        .metric-value.warning {
            color: var(--warning);
        }

        .metric-value.danger {
            color: var(--error);
        }

        .metric-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 0 20px rgba(20, 216, 180, 0.05);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: var(--text);
            text-align: center;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .tables-section {
            margin-top: 30px;
        }

        .table-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(20, 216, 180, 0.05);
        }

        .table-header {
            padding: 20px;
            background: var(--surface-light);
            border-bottom: 1px solid var(--border);
        }

        .table-title {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .table-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--surface-light);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: var(--text);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-good {
            background: rgba(20, 216, 180, 0.2);
            color: var(--success);
        }

        .status-warning {
            background: rgba(240, 180, 41, 0.2);
            color: var(--warning);
        }

        .status-danger {
            background: rgba(231, 76, 60, 0.2);
            color: var(--error);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--chart-purple));
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            transform: translateY(-1px);
        }

        /* Insights */
        .insights {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(20, 216, 180, 0.05);
        }

        .insights-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .insights-title svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        .insights-title h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .insight-item {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
        }

        .insight-item p {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-tabs {
                flex-wrap: wrap;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                <h1>BI Trips - An√°lise de Viagens</h1>
            </div>
        </div>

        <div class="filters">
            <div class="filters-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"></polygon>
                </svg>
                <h3>Filtros</h3>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="driverFilter">Motorista</label>
                    <select id="driverFilter">
                        <option value="">Todos os motoristas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="vehicleFilter">Ve√≠culo</label>
                    <select id="vehicleFilter">
                        <option value="">Todos os ve√≠culos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="startDate">Data In√≠cio</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label for="endDate">Data Fim</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Aplicar Filtros
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    Limpar
                </button>
            </div>
        </div>

        <div class="dashboard-tabs">
            <button class="tab-button active" onclick="showDashboard('security')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                Seguran√ßa
            </button>
            <button class="tab-button" onclick="showDashboard('costs')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                Custos
            </button>
            <button class="tab-button" onclick="showDashboard('efficiency')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"></polygon>
                </svg>
                Efici√™ncia
            </button>
            <button class="tab-button" onclick="showDashboard('emissions')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"></path>
                    <path d="m15 9-6 6"></path>
                    <path d="m9 9 6 6"></path>
                </svg>
                Emiss√µes
            </button>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados das viagens...</p>
        </div>

        <!-- Dashboard de Seguran√ßa -->
        <div id="security-dashboard" class="dashboard-content active">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Score M√©dio de Seguran√ßa</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                    </div>
                    <div class="metric-value good" id="avgScore">--</div>
                    <div class="metric-label">Pontua√ß√£o geral</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Total de Eventos de Risco</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                            <path d="M12 9v4"></path>
                            <path d="m12 17 .01 0"></path>
                        </svg>
                    </div>
                    <div class="metric-value warning" id="totalEvents">--</div>
                    <div class="metric-label">Eventos registrados</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Total de Viagens</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6v6"></path>
                            <path d="M15 6v6"></path>
                            <path d="M2 12h19.6"></path>
                            <path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2L21 10"></path>
                            <path d="M5 18H2s-.5-1.7-.8-2.8C1.1 14.8 1 14.4 1 14s.1-.8.2-1.2L2 10"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalTrips">--</div>
                    <div class="metric-label">Viagens analisadas</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Uso de Celular</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="14" height="20" x="5" y="2" rx="2" ry="2"></rect>
                            <path d="M12 18h.01"></path>
                        </svg>
                    </div>
                    <div class="metric-value danger" id="phoneEvents">--</div>
                    <div class="metric-label">Eventos detectados</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Score de Seguran√ßa por Motorista</div>
                    <div class="chart-container">
                        <canvas id="driverScoreChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Distribui√ß√£o de Eventos de Risco</div>
                    <div class="chart-container">
                        <canvas id="eventsDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="insights">
                <div class="insights-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="m12 8 .01 0"></path>
                    </svg>
                    <h3>Insights de Seguran√ßa</h3>
                </div>
                <div id="securityInsights"></div>
            </div>
        </div>

        <!-- Dashboard de Custos -->
        <div id="costs-dashboard" class="dashboard-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Custo M√©dio por Km</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgCostPerKm">--</div>
                    <div class="metric-label">Reais por quil√¥metro</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Custo Total Combust√≠vel</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="22" x2="15" y2="22"></line>
                            <line x1="4" y1="9" x2="14" y2="9"></line>
                            <path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"></path>
                            <path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalFuelCost">--</div>
                    <div class="metric-label">Total gasto</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Custo Total Manuten√ß√£o</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalMaintenanceCost">--</div>
                    <div class="metric-label">Total gasto</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Economia M√©dia</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7 10v12"></path>
                            <path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"></path>
                        </svg>
                    </div>
                    <div class="metric-value good" id="avgSavings">--</div>
                    <div class="metric-label">Percentual economizado</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Evolu√ß√£o do Custo por Km</div>
                    <div class="chart-container">
                        <canvas id="costEvolutionChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Distribui√ß√£o de Custos</div>
                    <div class="chart-container">
                        <canvas id="costDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard de Efici√™ncia -->
        <div id="efficiency-dashboard" class="dashboard-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Tempo M√©dio de Viagem</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgTripTime">--</div>
                    <div class="metric-label">Minutos por viagem</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Tempo M√©dio Ocioso</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                    </div>
                    <div class="metric-value warning" id="avgIdleTime">--</div>
                    <div class="metric-label">Minutos parado</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Dist√¢ncia M√©dia</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10 2v20"></path>
                            <path d="M14 2v20"></path>
                            <path d="M4 7h16"></path>
                            <path d="M4 17h16"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgDistance">--</div>
                    <div class="metric-label">Quil√¥metros</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Horas M√©dias de Condu√ß√£o</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 6v6"></path>
                            <path d="M15 6v6"></path>
                            <path d="M2 12h19.6"></path>
                            <path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2L21 10"></path>
                            <path d="M5 18H2s-.5-1.7-.8-2.8C1.1 14.8 1 14.4 1 14s.1-.8.2-1.2L2 10"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgDrivingHours">--</div>
                    <div class="metric-label">Horas cont√≠nuas</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Tempo de Viagem vs Tempo Ocioso</div>
                    <div class="chart-container">
                        <canvas id="timeComparisonChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Ranking de Efici√™ncia por Motorista</div>
                    <div class="chart-container">
                        <canvas id="efficiencyRankingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard de Emiss√µes -->
        <div id="emissions-dashboard" class="dashboard-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Total CO‚ÇÇ Estimado</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"></path>
                            <path d="m15 9-6 6"></path>
                            <path d="m9 9 6 6"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="totalCO2">--</div>
                    <div class="metric-label">Quilogramas</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Consumo M√©dio</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="22" x2="15" y2="22"></line>
                            <line x1="4" y1="9" x2="14" y2="9"></line>
                            <path d="M14 22V4a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v18"></path>
                            <path d="M14 13h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="avgFuelConsumption">--</div>
                    <div class="metric-label">L/100km</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">CO‚ÇÇ por Km</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"></path>
                            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                        </svg>
                    </div>
                    <div class="metric-value" id="co2PerKm">--</div>
                    <div class="metric-label">kg/km</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">Score Ecol√≥gico</div>
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 15.047m5.908 1.042-.347 1.97"></path>
                        </svg>
                    </div>
                    <div class="metric-value good" id="ecoScore">--</div>
                    <div class="metric-label">Pontua√ß√£o sustent√°vel</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Evolu√ß√£o das Emiss√µes de CO‚ÇÇ</div>
                    <div class="chart-container">
                        <canvas id="co2EvolutionChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Consumo de Combust√≠vel por Motorista</div>
                    <div class="chart-container">
                        <canvas id="fuelConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="tables-section">
            <div class="export-buttons">
                <button class="export-btn" onclick="exportToExcel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                    </svg>
                    Exportar Excel
                </button>
                <button class="export-btn" onclick="exportToPDF()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                    </svg>
                    Exportar PDF
                </button>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Ranking de Motoristas por Seguran√ßa</div>
                    <div class="table-subtitle">Ordenado por score de seguran√ßa (maior para menor)</div>
                </div>
                <div class="table-container">
                    <table id="driversTable">
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Motorista</th>
                                <th>Score Seguran√ßa</th>
                                <th>Total Viagens</th>
                                <th>Eventos de Risco</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <div class="table-header">
                    <div class="table-title">Detalhes das Viagens</div>
                    <div class="table-subtitle">√öltimas viagens realizadas</div>
                </div>
                <div class="table-container">
                    <table id="tripsTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Motorista</th>
                                <th>Ve√≠culo</th>
                                <th>Origem ‚Üí Destino</th>
                                <th>Dist√¢ncia (km)</th>
                                <th>Score</th>
                                <th>Custo Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sistema de DE-PARA autom√°tico para nomes dos motoristas
        let usersMapping = {};
        let mappingLoaded = false;
        
        async function loadUsersMapping() {
            if (mappingLoaded) return usersMapping;
            
            try {
                console.log('[DE-PARA] Carregando mapeamento de usu√°rios...');
                const response = await fetch(`/api/users-mapping?enterpriseId=${getEnterpriseId()}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    usersMapping = data.mapping || {};
                    mappingLoaded = true;
                    console.log(`[DE-PARA] Mapeamento carregado: ${Object.keys(usersMapping).length} usu√°rios`);
                } else {
                    console.warn('[DE-PARA] Erro ao carregar mapeamento:', data.message);
                }
            } catch (error) {
                console.error('[DE-PARA] Erro ao buscar mapeamento:', error);
            }
            
            return usersMapping;
        }
        
        function getDriverName(userString) {
            if (!userString) return 'N/A';
            
            // Usar nome real se dispon√≠vel
            if (usersMapping[userString]) {
                return usersMapping[userString];
            }
            
            // Fallback para ID truncado
            return `Motorista ${userString.substring(0, 8)}...`;
        }
        
        function getEnterpriseId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('enterpriseId') || 'qzDVZ1jB6IC60baxtsDU';
        }
    
        // Vari√°veis globais
        let tripsData = [];
        let filteredData = [];
        let charts = {};

        // Configura√ß√£o da API
        const API_BASE_URL = 'https://firebase-bi-api.onrender.com';

        // Fun√ß√£o para obter par√¢metro da URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Fun√ß√£o para carregar dados da API
        async function loadTripsData() {
            // Carregar mapeamento de usu√°rios primeiro
            await loadUsersMapping();
            try {
                const enterpriseId = getUrlParameter('enterpriseId') || 'qzDVZ1jB6IC60baxtsDU';
                console.log('üöõ Carregando dados de trips para:', enterpriseId);

                const response = await fetch(`${API_BASE_URL}/trips?enterpriseId=${enterpriseId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä Resposta da API:', result);

                // Verificar se h√° dados na resposta
                if (result.data && Array.isArray(result.data) && result.data.length > 0) {
                    tripsData = result.data;
                    filteredData = [...tripsData];
                    
                    console.log(`‚úÖ ${tripsData.length} viagens carregadas com sucesso!`);
                    console.log('üìã Primeira viagem:', tripsData[0]);
                    
                    // Ocultar loading
                    document.getElementById('loading').style.display = 'none';
                    
                    // Inicializar interface
                    initializeFilters();
                    updateDashboard();
                    
                } else {
                    throw new Error(`Nenhuma viagem encontrada para o enterpriseId: ${enterpriseId}`);
                }

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: var(--error); text-align: center;">
                        <h3>‚ùå Erro ao carregar dados</h3>
                        <p><strong>Detalhes:</strong> ${error.message}</p>
                        <p><strong>API:</strong> ${API_BASE_URL}/trips</p>
                        <p><strong>EnterpriseId:</strong> ${getUrlParameter('enterpriseId') || 'qzDVZ1jB6IC60baxtsDU'}</p>
                        <button onclick="loadTripsData()" class="btn btn-primary" style="margin-top: 15px;">
                            üîÑ Tentar Novamente
                        </button>
                        <button onclick="testApiConnection()" class="btn btn-secondary" style="margin-top: 15px;">
                            üîç Testar Conex√£o API
                        </button>
                    </div>
                `;
            }
        }

        // Fun√ß√£o para testar conex√£o com a API
        async function testApiConnection() {
            try {
                console.log('üîç Testando conex√£o com a API...');
                const response = await fetch(`${API_BASE_URL}/trips?enterpriseId=qzDVZ1jB6IC60baxtsDU`);
                const result = await response.json();
                
                console.log('üîó Teste de conex√£o:', {
                    status: response.status,
                    ok: response.ok,
                    data: result
                });
                
                alert(`Teste de conex√£o:\nStatus: ${response.status}\nDados: ${result.count || 0} registros encontrados`);
                
            } catch (error) {
                console.error('‚ùå Erro no teste de conex√£o:', error);
                alert(`Erro no teste de conex√£o: ${error.message}`);
            }
        }

        // Fun√ß√£o para inicializar filtros
        function initializeFilters() {
            if (!tripsData || tripsData.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum dado dispon√≠vel para inicializar filtros');
                return;
            }

            // Extrair valores √∫nicos para filtros
            const drivers = [...new Set(tripsData.map(trip => {
                const userString = trip.UserString || trip.userString;
                return userString ? getDriverName(userString) : null;
            }).filter(Boolean))];
            const vehicles = [...new Set(tripsData.map(trip => trip.vehiclePlate || trip.VehiclePlate).filter(Boolean))];

            console.log('üë• Motoristas encontrados:', drivers);
            console.log('üöó Ve√≠culos encontrados:', vehicles);

            // Preencher filtros
            populateSelect('driverFilter', drivers);
            populateSelect('vehicleFilter', vehicles);

            // Configurar datas padr√£o (√∫ltimos 30 dias)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // Fun√ß√£o para preencher select
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            // Limpar op√ß√µes existentes (exceto a primeira)
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Fun√ß√£o para aplicar filtros
        function applyFilters() {
            const driverFilter = document.getElementById('driverFilter').value;
            const vehicleFilter = document.getElementById('vehicleFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = tripsData.filter(trip => {
                // Filtro por motorista
                const driverField = trip.UserString || trip.userString;
                if (driverFilter && driverField !== driverFilter) return false;
                
                // Filtro por ve√≠culo
                const vehicleField = trip.vehiclePlate || trip.VehiclePlate;
                if (vehicleFilter && vehicleField !== vehicleFilter) return false;
                
                // Filtro por data
                if (startDate || endDate) {
                    const tripDate = new Date(trip.TripStartTimestamp || trip.startTimestamp);
                    if (startDate && tripDate < new Date(startDate)) return false;
                    if (endDate && tripDate > new Date(endDate + 'T23:59:59')) return false;
                }
                
                return true;
            });

            console.log(`üîç Filtros aplicados: ${filteredData.length} de ${tripsData.length} viagens`);
            updateDashboard();
        }

        // Fun√ß√£o para limpar filtros
        function clearFilters() {
            document.getElementById('driverFilter').value = '';
            document.getElementById('vehicleFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            filteredData = [...tripsData];
            updateDashboard();
        }

        // Fun√ß√£o para mostrar dashboard
        function showDashboard(dashboardName) {
            // Atualizar bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Mostrar dashboard
            document.querySelectorAll('.dashboard-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${dashboardName}-dashboard`).classList.add('active');

            // Atualizar gr√°ficos espec√≠ficos
            setTimeout(() => updateCharts(dashboardName), 100);
        }

        // Fun√ß√£o para atualizar dashboard
        function updateDashboard() {
            if (!filteredData || filteredData.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum dado filtrado dispon√≠vel para atualizar dashboard');
                return;
            }

            updateMetrics();
            updateCharts('security');
            updateTables();
            updateInsights();
        }

        // Fun√ß√£o para atualizar m√©tricas
        function updateMetrics() {
            if (filteredData.length === 0) return;

            // M√©tricas de Seguran√ßa
            const avgScore = filteredData.reduce((sum, trip) => sum + (trip.score || trip.Score || 0), 0) / filteredData.length;
            const totalEvents = filteredData.reduce((sum, trip) => sum + (trip.totalEvents || trip.Events || 0), 0);
            const phoneEvents = filteredData.reduce((sum, trip) => sum + (trip.AmountOfSmartphoneUsageEvents || trip.phoneEvents || 0), 0);

            document.getElementById('avgScore').textContent = avgScore.toFixed(1);
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('totalTrips').textContent = filteredData.length;
            document.getElementById('phoneEvents').textContent = phoneEvents;

            // M√©tricas de Custos
            const avgCostPerKm = filteredData.reduce((sum, trip) => sum + (trip.totalCostPerKm || 0), 0) / filteredData.length;
            const totalFuelCost = filteredData.reduce((sum, trip) => sum + (trip.fuelCost || 0), 0);
            const totalMaintenanceCost = filteredData.reduce((sum, trip) => sum + (trip.maintenanceCost || 0), 0);
            const avgSavings = filteredData.reduce((sum, trip) => sum + (trip.totalCostPerKmSavingPercentage || 0), 0) / filteredData.length;

            document.getElementById('avgCostPerKm').textContent = `R$ ${avgCostPerKm.toFixed(2)}`;
            document.getElementById('totalFuelCost').textContent = `R$ ${totalFuelCost.toFixed(2)}`;
            document.getElementById('totalMaintenanceCost').textContent = `R$ ${totalMaintenanceCost.toFixed(2)}`;
            document.getElementById('avgSavings').textContent = `${avgSavings.toFixed(1)}%`;

            // M√©tricas de Efici√™ncia
            const avgTripTime = filteredData.reduce((sum, trip) => sum + (trip.TripTime || 0), 0) / filteredData.length;
            const avgIdleTime = filteredData.reduce((sum, trip) => sum + (trip.TotalIdlingTime || trip.idleTime || 0), 0) / filteredData.length;
            const avgDistance = filteredData.reduce((sum, trip) => sum + (trip.TripDistance || trip.distance || 0), 0) / filteredData.length;
            const avgDrivingHours = filteredData.reduce((sum, trip) => sum + (trip.uninterruptedDrivingHours || 0), 0) / filteredData.length;

            document.getElementById('avgTripTime').textContent = (avgTripTime * 60).toFixed(0); // Converter para minutos
            document.getElementById('avgIdleTime').textContent = (avgIdleTime * 60).toFixed(0); // Converter para minutos
            document.getElementById('avgDistance').textContent = avgDistance.toFixed(1);
            document.getElementById('avgDrivingHours').textContent = avgDrivingHours.toFixed(1);

            // M√©tricas de Emiss√µes
            const totalCO2 = filteredData.reduce((sum, trip) => sum + (trip.Co2Estimation || 0), 0);
            const avgFuelConsumption = filteredData.reduce((sum, trip) => sum + (trip.totalFuelConsumption || 0), 0) / filteredData.length;
            const totalDistance = filteredData.reduce((sum, trip) => sum + (trip.TripDistance || trip.distance || 0), 0);
            const co2PerKm = totalDistance > 0 ? totalCO2 / totalDistance : 0;
            const ecoScore = Math.max(0, 100 - (avgFuelConsumption * 10));

            document.getElementById('totalCO2').textContent = totalCO2.toFixed(1);
            document.getElementById('avgFuelConsumption').textContent = avgDistance > 0 ? (avgFuelConsumption * 100 / avgDistance).toFixed(1) : '0.0';
            document.getElementById('co2PerKm').textContent = co2PerKm.toFixed(3);
            document.getElementById('ecoScore').textContent = ecoScore.toFixed(0);

            console.log('üìä M√©tricas atualizadas com sucesso');
        }

        // Fun√ß√£o para atualizar gr√°ficos
        function updateCharts(dashboardName) {
            if (filteredData.length === 0) return;

            switch (dashboardName) {
                case 'security':
                    updateSecurityCharts();
                    break;
                case 'costs':
                    updateCostsCharts();
                    break;
                case 'efficiency':
                    updateEfficiencyCharts();
                    break;
                case 'emissions':
                    updateEmissionsCharts();
                    break;
            }
        }

        // Gr√°ficos de Seguran√ßa
        function updateSecurityCharts() {
            // Score por motorista
            const driverScores = {};
            filteredData.forEach(trip => {
                const driver = getDriverName(trip.UserString || trip.userString);
                if (!driverScores[driver]) {
                    driverScores[driver] = { total: 0, count: 0 };
                }
                driverScores[driver].total += trip.score || trip.Score || 0;
                driverScores[driver].count++;
            });

            const driverLabels = Object.keys(driverScores);
            const driverData = driverLabels.map(driver => 
                driverScores[driver].total / driverScores[driver].count
            );

            updateChart('driverScoreChart', {
                type: 'bar',
                data: {
                    labels: driverLabels,
                    datasets: [{
                        label: 'Score de Seguran√ßa',
                        data: driverData,
                        backgroundColor: 'rgba(20, 216, 180, 0.8)',
                        borderColor: '#14d8b4',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });

            // Distribui√ß√£o de eventos
            const eventTypes = ['accEvents', 'brakeEvents', 'AmountOfSpeedOverLimitEvents', 'AmountOfSmartphoneUsageEvents', 'AmountOfSwervingEvents'];
            const eventLabels = ['Acelera√ß√£o', 'Frenagem', 'Velocidade', 'Celular', 'Zigue-zague'];
            const eventData = eventTypes.map(type => 
                filteredData.reduce((sum, trip) => sum + (trip[type] || 0), 0)
            );

            updateChart('eventsDistributionChart', {
                type: 'doughnut',
                data: {
                    labels: eventLabels,
                    datasets: [{
                        data: eventData,
                        backgroundColor: [
                            '#e74c3c',
                            '#f0b429',
                            '#e67e22',
                            '#8a56e2',
                            '#34495e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#a0a0a0' }
                        }
                    }
                }
            });
        }

        // Gr√°ficos de Custos
        function updateCostsCharts() {
            // Evolu√ß√£o do custo por km
            const costData = filteredData.map(trip => ({
                x: new Date(trip.TripStartTimestamp || trip.startTimestamp),
                y: trip.totalCostPerKm || 0
            })).sort((a, b) => a.x - b.x);

            updateChart('costEvolutionChart', {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Custo por Km (R$)',
                        data: costData,
                        borderColor: '#14d8b4',
                        backgroundColor: 'rgba(20, 216, 180, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#a0a0a0' } }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });

            // Distribui√ß√£o de custos
            const avgFuel = filteredData.reduce((sum, trip) => sum + (trip.fuelCost || 0), 0) / filteredData.length;
            const avgMaintenance = filteredData.reduce((sum, trip) => sum + (trip.maintenanceCost || 0), 0) / filteredData.length;
            const avgTires = filteredData.reduce((sum, trip) => sum + (trip.tiresCost || 0), 0) / filteredData.length;
            const avgInsurance = filteredData.reduce((sum, trip) => sum + (trip.insuranceCost || 0), 0) / filteredData.length;

            updateChart('costDistributionChart', {
                type: 'pie',
                data: {
                    labels: ['Combust√≠vel', 'Manuten√ß√£o', 'Pneus', 'Seguro'],
                    datasets: [{
                        data: [avgFuel, avgMaintenance, avgTires, avgInsurance],
                        backgroundColor: [
                            '#14d8b4',
                            '#8a56e2',
                            '#f0b429',
                            '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#a0a0a0' }
                        }
                    }
                }
            });
        }

        // Gr√°ficos de Efici√™ncia
        function updateEfficiencyCharts() {
            // Tempo de viagem vs tempo ocioso
            const timeData = filteredData.map(trip => ({
                driver: trip.UserString || trip.userString || 'N/A',
                tripTime: (trip.TripTime || 0) * 60, // Converter para minutos
                idleTime: (trip.TotalIdlingTime || trip.idleTime || 0) * 60 // Converter para minutos
            }));

            const drivers = [...new Set(timeData.map(d => d.driver))];
            const tripTimes = drivers.map(driver => {
                const driverTrips = timeData.filter(d => d.driver === driver);
                return driverTrips.reduce((sum, trip) => sum + trip.tripTime, 0) / driverTrips.length;
            });
            const idleTimes = drivers.map(driver => {
                const driverTrips = timeData.filter(d => d.driver === driver);
                return driverTrips.reduce((sum, trip) => sum + trip.idleTime, 0) / driverTrips.length;
            });

            updateChart('timeComparisonChart', {
                type: 'bar',
                data: {
                    labels: drivers,
                    datasets: [
                        {
                            label: 'Tempo de Viagem (min)',
                            data: tripTimes,
                            backgroundColor: 'rgba(20, 216, 180, 0.8)'
                        },
                        {
                            label: 'Tempo Ocioso (min)',
                            data: idleTimes,
                            backgroundColor: 'rgba(240, 180, 41, 0.8)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#a0a0a0' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });

            // Ranking de efici√™ncia
            const efficiencyData = drivers.map(driver => {
                const driverTrips = filteredData.filter(trip => (trip.UserString || trip.userString) === driver);
                const avgDistance = driverTrips.reduce((sum, trip) => sum + (trip.TripDistance || trip.distance || 0), 0) / driverTrips.length;
                const avgTime = driverTrips.reduce((sum, trip) => sum + (trip.TripTime || 0), 0) / driverTrips.length;
                return { driver, efficiency: avgTime > 0 ? avgDistance / avgTime : 0 }; // km/h
            }).sort((a, b) => b.efficiency - a.efficiency);

            updateChart('efficiencyRankingChart', {
                type: 'bar',
                data: {
                    labels: efficiencyData.map(d => d.driver),
                    datasets: [{
                        label: 'Efici√™ncia (km/h)',
                        data: efficiencyData.map(d => d.efficiency),
                        backgroundColor: 'rgba(138, 86, 226, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                            beginAtZero: true,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });
        }

        // Gr√°ficos de Emiss√µes
        function updateEmissionsCharts() {
            // Evolu√ß√£o das emiss√µes
            const co2Data = filteredData.map(trip => ({
                x: new Date(trip.TripStartTimestamp || trip.startTimestamp),
                y: trip.Co2Estimation || 0
            })).sort((a, b) => a.x - b.x);

            updateChart('co2EvolutionChart', {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'CO‚ÇÇ Estimado (kg)',
                        data: co2Data,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#a0a0a0' } }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'day' },
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });

            // Consumo por motorista
            const fuelByDriver = {};
            filteredData.forEach(trip => {
                const driver = getDriverName(trip.UserString || trip.userString);
                if (!fuelByDriver[driver]) {
                    fuelByDriver[driver] = { total: 0, count: 0 };
                }
                fuelByDriver[driver].total += trip.totalFuelConsumption || 0;
                fuelByDriver[driver].count++;
            });

            const fuelLabels = Object.keys(fuelByDriver);
            const fuelData = fuelLabels.map(driver => 
                fuelByDriver[driver].total / fuelByDriver[driver].count
            );

            updateChart('fuelConsumptionChart', {
                type: 'bar',
                data: {
                    labels: fuelLabels,
                    datasets: [{
                        label: 'Consumo M√©dio (L)',
                        data: fuelData,
                        backgroundColor: 'rgba(52, 152, 219, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        },
                        x: {
                            grid: { color: '#3a3e43' },
                            ticks: { color: '#a0a0a0' }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o auxiliar para atualizar gr√°ficos
        function updateChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            // Destruir gr√°fico existente
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            // Criar novo gr√°fico
            charts[canvasId] = new Chart(ctx, config);
        }

        // Fun√ß√£o para atualizar tabelas
        function updateTables() {
            updateDriversTable();
            updateTripsTable();
        }

        // Tabela de motoristas
        function updateDriversTable() {
            const driverStats = {};
            
            filteredData.forEach(trip => {
                const driver = getDriverName(trip.UserString || trip.userString);
                if (!driverStats[driver]) {
                    driverStats[driver] = {
                        name: driver,
                        totalTrips: 0,
                        totalScore: 0,
                        totalEvents: 0
                    };
                }
                
                driverStats[driver].totalTrips++;
                driverStats[driver].totalScore += trip.score || trip.Score || 0;
                driverStats[driver].totalEvents += trip.totalEvents || trip.Events || 0;
            });

            const driversArray = Object.values(driverStats).map(driver => ({
                ...driver,
                avgScore: driver.totalScore / driver.totalTrips
            })).sort((a, b) => b.avgScore - a.avgScore);

            const tbody = document.querySelector('#driversTable tbody');
            tbody.innerHTML = '';

            driversArray.forEach((driver, index) => {
                const row = tbody.insertRow();
                const status = driver.avgScore >= 80 ? 'good' : driver.avgScore >= 60 ? 'warning' : 'danger';
                const statusText = driver.avgScore >= 80 ? 'Excelente' : driver.avgScore >= 60 ? 'Bom' : 'Aten√ß√£o';
                
                row.innerHTML = `
                    <td>${index + 1}¬∫</td>
                    <td>${driver.name}</td>
                    <td>${driver.avgScore.toFixed(1)}</td>
                    <td>${driver.totalTrips}</td>
                    <td>${driver.totalEvents}</td>
                    <td><span class="status-badge status-${status}">${statusText}</span></td>
                `;
            });
        }

        // Tabela de viagens
        function updateTripsTable() {
            const tbody = document.querySelector('#tripsTable tbody');
            tbody.innerHTML = '';

            const sortedTrips = [...filteredData].sort((a, b) => 
                new Date(b.TripStartTimestamp || b.startTimestamp) - new Date(a.TripStartTimestamp || a.startTimestamp)
            ).slice(0, 20); // √öltimas 20 viagens

            sortedTrips.forEach(trip => {
                const row = tbody.insertRow();
                const date = new Date(trip.TripStartTimestamp || trip.startTimestamp).toLocaleDateString('pt-BR');
                const route = `${trip.StartAddress || trip.startAddress || 'N/A'} ‚Üí ${trip.FinalAddress || trip.finalAddress || 'N/A'}`;
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${getDriverName(trip.UserString || trip.userString)}</td>
                    <td>${trip.vehiclePlate || trip.VehiclePlate || 'N/A'}</td>
                    <td title="${route}">${route.length > 50 ? route.substring(0, 50) + '...' : route}</td>
                    <td>${(trip.TripDistance || trip.distance || 0).toFixed(1)}</td>
                    <td>${trip.score || trip.Score || 0}</td>
                    <td>R$ ${(trip.totalCost || 0).toFixed(2)}</td>
                `;
            });
        }

        // Fun√ß√£o para atualizar insights
        function updateInsights() {
            const insights = [];
            
            if (filteredData.length === 0) return;

            const avgScore = filteredData.reduce((sum, trip) => sum + (trip.score || trip.Score || 0), 0) / filteredData.length;
            const totalEvents = filteredData.reduce((sum, trip) => sum + (trip.totalEvents || trip.Events || 0), 0);
            const avgCost = filteredData.reduce((sum, trip) => sum + (trip.totalCostPerKm || 0), 0) / filteredData.length;

            if (avgScore >= 85) {
                insights.push('Excelente performance de seguran√ßa da frota com score m√©dio acima de 85 pontos.');
            } else if (avgScore < 70) {
                insights.push('Aten√ß√£o: Score m√©dio de seguran√ßa abaixo de 70 pontos. Recomenda-se treinamento adicional.');
            }

            if (totalEvents > filteredData.length * 2) {
                insights.push('Alto n√∫mero de eventos de risco detectados. Considere implementar programa de condu√ß√£o defensiva.');
            }

            if (avgCost > 2.0) {
                insights.push('Custo por km acima da m√©dia. Analise oportunidades de otimiza√ß√£o de rotas e manuten√ß√£o.');
            }

            const insightsContainer = document.getElementById('securityInsights');
            if (insightsContainer) {
                insightsContainer.innerHTML = insights.map(insight => 
                    `<div class="insight-item"><p>${insight}</p></div>`
                ).join('');
            }
        }

        // Fun√ß√µes de exporta√ß√£o
        function exportToExcel() {
            console.log('üìä Exportando para Excel...');
            alert('Funcionalidade de exporta√ß√£o Excel ser√° implementada em breve!');
        }

        function exportToPDF() {
            console.log('üìÑ Exportando para PDF...');
            alert('Funcionalidade de exporta√ß√£o PDF ser√° implementada em breve!');
        }

        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando BI Trips...');
            loadTripsData();
        });
    </script>
</body>
</html>

