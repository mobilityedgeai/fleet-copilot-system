<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorecard Preditivo de Risco</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --background: #1a1e23;
            --surface: #2c3e50;
            --surface-light: #34495e;
            --primary: #14d8b4;
            --secondary: #8a56e2;
            --accent: #f39c12;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #27ae60;
            --text-primary: #ffffff;
            --text-secondary: #bdc3c7;
            --border: #34495e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .header h1 {
            color: var(--primary);
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 400;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--background);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .filters {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .filters-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(20, 216, 180, 0.2);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--background);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-change {
            font-size: 0.8rem;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .positive { 
            background: rgba(39, 174, 96, 0.2); 
            color: var(--success); 
        }
        .negative { 
            background: rgba(231, 76, 60, 0.2); 
            color: var(--danger); 
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .chart-title {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .additional-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .insights-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
        }

        .insight-title {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .insight-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .insight-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .table-container {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--surface-light);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        tr:hover {
            background: rgba(20, 216, 180, 0.05);
        }

        .risk-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-low { background: rgba(39, 174, 96, 0.2); color: var(--success); }
        .risk-medium { background: rgba(241, 196, 15, 0.2); color: var(--warning); }
        .risk-high { background: rgba(231, 76, 60, 0.2); color: var(--danger); }

        .pagination {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-controls select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .pagination-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--surface-light);
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: var(--background);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            color: var(--background);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .additional-charts {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .insights-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Scorecard Preditivo de Risco</h1>
                <div class="header-subtitle">Análise Avançada de Segurança e Prevenção de Acidentes</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    Exportar Excel
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    Atualizar
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filters-header">
                <span>Filtros</span>
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Período</label>
                    <select id="periodFilter">
                        <option value="30">Últimos 30 dias</option>
                        <option value="60">Últimos 60 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="180">Últimos 6 meses</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Nível de Risco</label>
                    <select id="riskFilter">
                        <option value="">Todos</option>
                        <option value="low">Baixo</option>
                        <option value="medium">Médio</option>
                        <option value="high">Alto</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Buscar Motorista</label>
                    <input type="text" id="driverSearch" placeholder="Nome do motorista...">
                </div>
                <div class="filter-group">
                    <label>Score Mínimo</label>
                    <input type="number" id="minScore" placeholder="0" min="0" max="100">
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <p>Carregando dados do scorecard preditivo...</p>
        </div>

        <!-- Error State (apenas para erros críticos) -->
        <div id="errorState" class="error" style="display: none;">
            <p><strong>Erro:</strong> Não foi possível carregar dados das APIs. Verifique a conectividade.</p>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid" id="metricsGrid" style="display: none;">
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--danger);">R</div>
                <div class="metric-value" style="color: var(--danger);" id="fleetRiskScore">0.0</div>
                <div class="metric-label">Score de Risco da Frota</div>
                <div class="metric-change" id="fleetRiskChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--warning);">M</div>
                <div class="metric-value" style="color: var(--warning);" id="totalDrivers">0</div>
                <div class="metric-label">Total de Motoristas</div>
                <div class="metric-change" id="driversChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--primary);">V</div>
                <div class="metric-value" style="color: var(--primary);" id="totalTrips">0</div>
                <div class="metric-label">Total de Viagens</div>
                <div class="metric-change" id="tripsChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background: var(--success);">D</div>
                <div class="metric-value" style="color: var(--success);" id="totalDistance">0.0</div>
                <div class="metric-label">Distância Total (km)</div>
                <div class="metric-change" id="distanceChange">--</div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section" id="insightsSection" style="display: none;">
            <div class="insight-card">
                <div class="insight-title">Motoristas Alto Risco</div>
                <div class="insight-value" style="color: var(--danger);" id="highRiskDrivers">0</div>
                <div class="insight-description">Motoristas que precisam de atenção imediata</div>
            </div>
            <div class="insight-card">
                <div class="insight-title">Tendência Mensal</div>
                <div class="insight-value" style="color: var(--warning);" id="monthlyTrend">+2.3%</div>
                <div class="insight-description">Variação do risco médio no último mês</div>
            </div>
            <div class="insight-card">
                <div class="insight-title">Eficiência da Frota</div>
                <div class="insight-value" style="color: var(--success);" id="fleetEfficiency">87%</div>
                <div class="insight-description">Percentual de motoristas com risco baixo/médio</div>
            </div>
            <div class="insight-card">
                <div class="insight-title">Eventos Críticos</div>
                <div class="insight-value" style="color: var(--accent);" id="criticalEvents">0</div>
                <div class="insight-description">Eventos de alto risco detectados hoje</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section" id="chartsSection" style="display: none;">
            <!-- Risk Distribution Pie Chart -->
            <div class="chart-container">
                <div class="chart-title">Distribuição de Risco da Frota</div>
                <div class="chart-wrapper">
                    <canvas id="riskDistributionChart"></canvas>
                </div>
            </div>

            <!-- Top Risk Drivers Bar Chart -->
            <div class="chart-container">
                <div class="chart-title">Top 10 Motoristas por Risco</div>
                <div class="chart-wrapper">
                    <canvas id="riskBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Charts -->
        <div class="additional-charts" id="additionalCharts" style="display: none;">
            <!-- Risk vs Distance Scatter -->
            <div class="chart-container">
                <div class="chart-title">Correlação: Risco vs Distância Percorrida</div>
                <div class="chart-wrapper">
                    <canvas id="riskDistanceScatter"></canvas>
                </div>
            </div>

            <!-- Risk Evolution Line Chart -->
            <div class="chart-container">
                <div class="chart-title">Evolução do Risco nos Últimos 6 Meses</div>
                <div class="chart-wrapper">
                    <canvas id="riskEvolutionChart"></canvas>
                </div>
            </div>

            <!-- Risk by Trip Frequency -->
            <div class="chart-container">
                <div class="chart-title">Risco por Frequência de Viagens</div>
                <div class="chart-wrapper">
                    <canvas id="riskFrequencyChart"></canvas>
                </div>
            </div>

            <!-- Performance Benchmark -->
            <div class="chart-container">
                <div class="chart-title">Benchmark de Performance vs Mercado</div>
                <div class="chart-wrapper">
                    <canvas id="benchmarkChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container" id="tableContainer" style="display: none;">
            <div class="table-header">
                <div class="table-title">Detalhamento por Motorista</div>
            </div>
            <div class="table-wrapper">
                <table id="driversTable">
                    <thead>
                        <tr>
                            <th>Motorista</th>
                            <th>Score Preditivo</th>
                            <th>Nível de Risco</th>
                            <th>Total de Viagens</th>
                            <th>Distância (km)</th>
                            <th>Última Viagem</th>
                            <th>Tendência</th>
                            <th>Eventos/Viagem</th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody">
                        <!-- Dados serão inseridos via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">
                    Mostrando 0-0 de 0 registros
                </div>
                <div class="pagination-controls">
                    <select id="recordsPerPage" onchange="changeRecordsPerPage()">
                        <option value="50">50 por página</option>
                        <option value="100" selected>100 por página</option>
                        <option value="200">200 por página</option>
                        <option value="500">500 por página</option>
                    </select>
                    <div class="pagination-buttons" id="paginationButtons">
                        <!-- Botões serão inseridos via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração de produção
        const PRODUCTION_MODE = true;
        
        // Função para logs condicionais (apenas em desenvolvimento)
        function debugLog(...args) {
            if (!PRODUCTION_MODE) {
                console.log(...args);
            }
        }

        // Variáveis globais
        let tripsData = [];
        let usersData = [];
        let usersMap = new Map();
        let processedData = [];
        let filteredData = [];
        let currentPage = 1;
        let recordsPerPage = 100;
        let charts = {};
        let currentEnterpriseId = '';

        // URLs das APIs
        const API_BASE = 'https://firebase-bi-api.onrender.com';

        // Obter enterpriseId da URL
        function getEnterpriseIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const enterpriseId = urlParams.get('enterpriseId') || 'qzDVZ1jB6IC60baxtsDU';
            debugLog('Enterprise ID obtido da URL:', enterpriseId);
            return enterpriseId;
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            currentEnterpriseId = getEnterpriseIdFromUrl();
            
            debugLog('Inicializando Scorecard Preditivo de Risco para Enterprise ID:', currentEnterpriseId);
            loadData();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('periodFilter').addEventListener('change', applyFilters);
            document.getElementById('riskFilter').addEventListener('change', applyFilters);
            document.getElementById('driverSearch').addEventListener('input', applyFilters);
            document.getElementById('minScore').addEventListener('input', applyFilters);
        }

        // Carregar dados das APIs com filtro por enterpriseId
        async function loadData() {
            try {
                debugLog('Carregando dados das APIs para Enterprise ID:', currentEnterpriseId);
                
                // Carregar dados das APIs com timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                debugLog('Carregando API trips...');
                const tripsResponse = await fetch(`${API_BASE}/trips?enterpriseId=${currentEnterpriseId}`, { 
                    signal: controller.signal 
                });

                if (!tripsResponse.ok) {
                    throw new Error(`Erro na API trips: ${tripsResponse.status}`);
                }

                const tripsResult = await tripsResponse.json();
                debugLog('API trips carregada:', tripsResult.count || 0, 'registros');
                
                tripsData = tripsResult.data || [];

                // Carregar users - tentar com enterpriseId primeiro, depois sem filtro
                debugLog('Carregando API users...');
                try {
                    const usersResponse = await fetch(`${API_BASE}/users?enterpriseId=${currentEnterpriseId}`, { 
                        signal: controller.signal 
                    });

                    if (usersResponse.ok) {
                        const usersResult = await usersResponse.json();
                        usersData = usersResult.data || [];
                        
                        // Se não retornou dados com enterpriseId, tentar sem filtro
                        if (usersData.length === 0) {
                            debugLog('Nenhum usuário encontrado com enterpriseId, tentando buscar todos...');
                            const allUsersResponse = await fetch(`${API_BASE}/users`, { 
                                signal: controller.signal 
                            });
                            
                            if (allUsersResponse.ok) {
                                const allUsersResult = await allUsersResponse.json();
                                usersData = allUsersResult.data || [];
                                debugLog('Carregados todos os usuários:', usersData.length);
                            }
                        }
                        
                        if (usersData.length > 0) {
                            debugLog('API users carregada com sucesso:', usersData.length, 'usuários');
                            createUsersMap();
                        } else {
                            debugLog('API users não retornou dados');
                        }
                    } else {
                        throw new Error(`Erro na API users: ${usersResponse.status}`);
                    }
                } catch (usersError) {
                    debugLog('Erro na API users (continuando sem ela):', usersError);
                }

                clearTimeout(timeoutId);

                // Se temos dados de trips, consideramos sucesso
                if (tripsData.length > 0) {
                    debugLog('Dados reais carregados com sucesso para Enterprise ID:', currentEnterpriseId);
                    
                    // Processar dados reais
                    processRealData();
                } else {
                    throw new Error(`Nenhuma viagem encontrada para Enterprise ID: ${currentEnterpriseId}`);
                }
                
            } catch (error) {
                debugLog('Erro ao carregar APIs:', error);
                
                document.getElementById('errorState').style.display = 'block';
                document.getElementById('errorState').innerHTML = `
                    <p><strong>Erro:</strong> ${error.message}</p>
                    <p>Enterprise ID: ${currentEnterpriseId}</p>
                `;
                
                // Não usar fallback - mostrar erro real
                processedData = [];
                
            } finally {
                // Renderizar interface sempre
                renderInterface();
            }
        }

        // Criar mapa de usuários para DE-PARA
        function createUsersMap() {
            debugLog('Criando mapa de usuários para DE-PARA...');
            
            usersMap.clear();
            let mappingsCreated = 0;
            
            usersData.forEach(user => {
                // Tentar diferentes campos de ID
                const userId = user._doc_id || user.id || user.userId;
                const userName = user.display_name || user.displayName || user.name;
                
                if (userId && userName && userName !== 'N/A') {
                    usersMap.set(userId, userName);
                    mappingsCreated++;
                }
            });
            
            debugLog(`${mappingsCreated} mapeamentos de usuários criados`);
        }

        // Função para obter nome do motorista
        function getDriverName(userString) {
            if (!userString) return 'Motorista não identificado';
            
            // Se temos mapeamento de usuários, usar
            if (usersMap.size > 0) {
                const driverName = usersMap.get(userString);
                if (driverName && driverName !== 'N/A') {
                    return driverName;
                }
            }
            
            // Fallback: usar ID truncado mais legível
            if (userString.length > 12) {
                return `Motorista ${userString.substring(0, 8)}...`;
            }
            
            return `Motorista ${userString}`;
        }

        // Processar dados reais das APIs
        function processRealData() {
            debugLog('Processando dados reais das APIs...');
            
            if (!tripsData || tripsData.length === 0) {
                debugLog('Nenhum dado de viagens disponível');
                processedData = [];
                return;
            }

            // Agrupar viagens por motorista
            const driverStats = {};
            
            tripsData.forEach(trip => {
                const driverId = trip.UserString || trip.user || trip.userId || trip.driver;
                if (!driverId) return;
                
                if (!driverStats[driverId]) {
                    driverStats[driverId] = {
                        driverId: driverId,
                        driverName: getDriverName(driverId),
                        totalTrips: 0,
                        totalDistance: 0,
                        totalDuration: 0,
                        riskEvents: 0,
                        lastTrip: null,
                        scores: [],
                        totalScore: 0,
                        speedEvents: 0,
                        brakeEvents: 0,
                        accEvents: 0
                    };
                }
                
                const stats = driverStats[driverId];
                stats.totalTrips++;
                
                // Processar distância (em metros, converter para km)
                if (trip.TripDistance) {
                    stats.totalDistance += parseFloat(trip.TripDistance) || 0;
                }
                
                // Processar duração (em horas)
                if (trip.TripTime) {
                    stats.totalDuration += parseFloat(trip.TripTime) || 0;
                }
                
                // Processar eventos de risco
                const speedEvents = parseInt(trip.AmountOfSpeedOverLimitEvents) || 0;
                const brakeEvents = parseInt(trip.AmountOfFrequentBrakingEvents) || 0;
                const accEvents = parseInt(trip.AmountOfFrequentAccelerationEvents) || 0;
                const totalEvents = parseInt(trip.totalEvents) || (speedEvents + brakeEvents + accEvents);
                
                stats.riskEvents += totalEvents;
                stats.speedEvents += speedEvents;
                stats.brakeEvents += brakeEvents;
                stats.accEvents += accEvents;
                
                // Processar score (usar DriverBehaviorScore ou score)
                const tripScore = parseFloat(trip.DriverBehaviorScore) || parseFloat(trip.score) || 0;
                if (tripScore > 0) {
                    stats.scores.push(tripScore);
                    stats.totalScore += tripScore;
                }
                
                // Última viagem
                const tripDate = trip.TimestampDate || trip.TripEndTimestampDate || trip.date;
                if (tripDate && (!stats.lastTrip || new Date(tripDate) > new Date(stats.lastTrip))) {
                    stats.lastTrip = tripDate;
                }
            });

            // Calcular scores preditivos baseados em dados reais
            processedData = Object.values(driverStats).map(driver => {
                const avgScore = driver.scores.length > 0 ? (driver.totalScore / driver.scores.length) : 50;
                const riskScore = calculateRealRiskScore(driver, avgScore);
                const riskLevel = getRiskLevel(riskScore);
                const eventsPerTrip = driver.totalTrips > 0 ? (driver.riskEvents / driver.totalTrips) : 0;
                
                return {
                    ...driver,
                    riskScore: parseFloat(riskScore.toFixed(2)),
                    riskLevel: riskLevel,
                    avgDistance: driver.totalTrips > 0 ? (driver.totalDistance / driver.totalTrips) : 0,
                    eventsPerTrip: parseFloat(eventsPerTrip.toFixed(2)),
                    avgScore: parseFloat(avgScore.toFixed(2)),
                    riskTrend: riskScore > avgScore ? 'up' : 'down'
                };
            });

            // Ordenar por score de risco (maior risco primeiro)
            processedData.sort((a, b) => b.riskScore - a.riskScore);
            
            debugLog(`${processedData.length} motoristas processados com dados reais para Enterprise ID: ${currentEnterpriseId}`);
        }

        // Calcular score de risco baseado em dados reais
        function calculateRealRiskScore(driver, avgScore) {
            let riskScore = 0;
            
            // Fator 1: Score médio invertido (peso 40%)
            // Score alto = risco baixo, então invertemos
            const scoreRisk = Math.max(0, 100 - avgScore);
            riskScore += (scoreRisk * 0.4);
            
            // Fator 2: Eventos de risco por viagem (peso 30%)
            const eventsPerTrip = driver.totalTrips > 0 ? driver.riskEvents / driver.totalTrips : 0;
            const eventsRisk = Math.min(eventsPerTrip * 10, 100); // Normalizar
            riskScore += (eventsRisk * 0.3);
            
            // Fator 3: Eventos de velocidade (peso 20%)
            const speedEventsPerTrip = driver.totalTrips > 0 ? driver.speedEvents / driver.totalTrips : 0;
            const speedRisk = Math.min(speedEventsPerTrip * 15, 100);
            riskScore += (speedRisk * 0.2);
            
            // Fator 4: Frequência de viagens (peso 10%)
            // Muitas viagens podem indicar maior exposição ao risco
            const tripFrequency = Math.min(driver.totalTrips / 50, 1);
            riskScore += (tripFrequency * 10);
            
            return Math.min(riskScore, 100);
        }

        // Determinar nível de risco
        function getRiskLevel(score) {
            if (score >= 70) return 'high';
            if (score >= 40) return 'medium';
            return 'low';
        }

        // Aplicar filtros
        function applyFilters() {
            const periodFilter = document.getElementById('periodFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const driverSearch = document.getElementById('driverSearch').value.toLowerCase();
            const minScore = parseFloat(document.getElementById('minScore').value) || 0;

            filteredData = processedData.filter(driver => {
                // Filtro de período (baseado na última viagem)
                if (periodFilter && driver.lastTrip) {
                    const tripDate = new Date(driver.lastTrip);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - parseInt(periodFilter));
                    if (tripDate < cutoffDate) return false;
                }

                // Filtro de nível de risco
                if (riskFilter && driver.riskLevel !== riskFilter) return false;

                // Filtro de busca por nome
                if (driverSearch && !driver.driverName.toLowerCase().includes(driverSearch)) return false;

                // Filtro de score mínimo
                if (driver.riskScore < minScore) return false;

                return true;
            });

            currentPage = 1;
            renderTable();
            updateMetrics();
            updateInsights();
            updateCharts();
        }

        // Renderizar interface completa
        function renderInterface() {
            document.getElementById('loadingState').style.display = 'none';
            
            if (processedData.length > 0) {
                document.getElementById('metricsGrid').style.display = 'grid';
                document.getElementById('insightsSection').style.display = 'grid';
                document.getElementById('chartsSection').style.display = 'grid';
                document.getElementById('additionalCharts').style.display = 'grid';
                document.getElementById('tableContainer').style.display = 'block';

                // Aplicar filtros iniciais
                applyFilters();
                
                updateMetrics();
                updateInsights();
                createCharts();
                renderTable();
            } else {
                // Mostrar mensagem de erro se não há dados
                document.getElementById('errorState').style.display = 'block';
            }
        }

        // Atualizar métricas
        function updateMetrics() {
            const totalDrivers = filteredData.length;
            const totalTrips = filteredData.reduce((sum, driver) => sum + driver.totalTrips, 0);
            const totalDistance = filteredData.reduce((sum, driver) => sum + driver.totalDistance, 0);
            const avgRiskScore = totalDrivers > 0 ? filteredData.reduce((sum, driver) => sum + driver.riskScore, 0) / totalDrivers : 0;

            document.getElementById('fleetRiskScore').textContent = avgRiskScore.toFixed(1);
            document.getElementById('totalDrivers').textContent = totalDrivers;
            document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
            document.getElementById('totalDistance').textContent = (totalDistance / 1000).toFixed(1);

            // Simular mudanças (em uma implementação real, comparar com período anterior)
            document.getElementById('fleetRiskChange').textContent = '+2.3%';
            document.getElementById('fleetRiskChange').className = 'metric-change negative';
            
            document.getElementById('driversChange').textContent = '+5';
            document.getElementById('driversChange').className = 'metric-change positive';
            
            document.getElementById('tripsChange').textContent = '+12%';
            document.getElementById('tripsChange').className = 'metric-change positive';
            
            document.getElementById('distanceChange').textContent = '+8.5%';
            document.getElementById('distanceChange').className = 'metric-change positive';
        }

        // Atualizar insights
        function updateInsights() {
            const highRiskDrivers = filteredData.filter(d => d.riskLevel === 'high').length;
            const lowMediumRiskDrivers = filteredData.filter(d => d.riskLevel !== 'high').length;
            const fleetEfficiency = filteredData.length > 0 ? ((lowMediumRiskDrivers / filteredData.length) * 100) : 0;
            const criticalEvents = Math.floor(Math.random() * 5); // Simulado

            document.getElementById('highRiskDrivers').textContent = highRiskDrivers;
            document.getElementById('fleetEfficiency').textContent = fleetEfficiency.toFixed(0) + '%';
            document.getElementById('criticalEvents').textContent = criticalEvents;
        }

        // Criar gráficos
        function createCharts() {
            createRiskDistributionChart();
            createRiskBarChart();
            createRiskDistanceScatter();
            createRiskEvolutionChart();
            createRiskFrequencyChart();
            createBenchmarkChart();
        }

        // Distribuição de risco da frota (Pie Chart)
        function createRiskDistributionChart() {
            const ctx = document.getElementById('riskDistributionChart').getContext('2d');
            
            if (charts.riskDistribution) {
                charts.riskDistribution.destroy();
            }
            
            const lowRisk = filteredData.filter(d => d.riskLevel === 'low').length;
            const mediumRisk = filteredData.filter(d => d.riskLevel === 'medium').length;
            const highRisk = filteredData.filter(d => d.riskLevel === 'high').length;
            
            charts.riskDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Baixo Risco', 'Médio Risco', 'Alto Risco'],
                    datasets: [{
                        data: [lowRisk, mediumRisk, highRisk],
                        backgroundColor: ['#27ae60', '#f1c40f', '#e74c3c'],
                        borderWidth: 3,
                        borderColor: '#1a1e23'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#bdc3c7',
                                padding: 20,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Top 10 motoristas por risco (Bar Chart)
        function createRiskBarChart() {
            const ctx = document.getElementById('riskBarChart').getContext('2d');
            
            if (charts.riskBar) {
                charts.riskBar.destroy();
            }
            
            const top10 = filteredData.slice(0, 10);
            
            charts.riskBar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(driver => driver.driverName.length > 20 ? 
                        driver.driverName.substring(0, 20) + '...' : driver.driverName),
                    datasets: [{
                        label: 'Score de Risco',
                        data: top10.map(driver => driver.riskScore),
                        backgroundColor: top10.map(driver => 
                            driver.riskLevel === 'high' ? '#e74c3c' :
                            driver.riskLevel === 'medium' ? '#f1c40f' : '#27ae60'
                        ),
                        borderColor: '#34495e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return top10[index] ? top10[index].driverName : 'N/A';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        },
                        y: {
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                }
            });
        }

        // Correlação Risco vs Distância (Scatter Plot)
        function createRiskDistanceScatter() {
            const ctx = document.getElementById('riskDistanceScatter').getContext('2d');
            
            if (charts.riskDistanceScatter) {
                charts.riskDistanceScatter.destroy();
            }
            
            const scatterData = filteredData.map(driver => ({
                x: driver.totalDistance / 1000, // km
                y: driver.riskScore,
                backgroundColor: driver.riskLevel === 'high' ? '#e74c3c' :
                               driver.riskLevel === 'medium' ? '#f1c40f' : '#27ae60'
            }));
            
            charts.riskDistanceScatter = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Motoristas',
                        data: scatterData,
                        backgroundColor: scatterData.map(point => point.backgroundColor),
                        borderColor: '#34495e',
                        borderWidth: 1,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return filteredData[index] ? filteredData[index].driverName : 'N/A';
                                },
                                label: function(context) {
                                    return [
                                        `Distância: ${context.parsed.x.toFixed(1)} km`,
                                        `Score de Risco: ${context.parsed.y.toFixed(1)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distância Total (km)',
                                color: '#bdc3c7'
                            },
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Score de Risco',
                                color: '#bdc3c7'
                            },
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                }
            });
        }

        // Evolução do risco nos últimos 6 meses (Line Chart)
        function createRiskEvolutionChart() {
            const ctx = document.getElementById('riskEvolutionChart').getContext('2d');
            
            if (charts.riskEvolution) {
                charts.riskEvolution.destroy();
            }
            
            // Dados simulados para os últimos 6 meses
            const months = [];
            const riskScores = [];
            const targetLine = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                months.push(date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }));
                
                // Simular tendência de melhoria
                const baseScore = 55 - (i * 2); // Melhoria gradual
                const variation = (Math.random() - 0.5) * 10;
                riskScores.push(Math.max(30, Math.min(80, baseScore + variation)));
                targetLine.push(45); // Meta de risco
            }
            
            charts.riskEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Score Médio de Risco',
                            data: riskScores,
                            borderColor: '#14d8b4',
                            backgroundColor: 'rgba(20, 216, 180, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Meta de Risco',
                            data: targetLine,
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#bdc3c7' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                }
            });
        }

        // Risco por frequência de viagens (Bar Chart)
        function createRiskFrequencyChart() {
            const ctx = document.getElementById('riskFrequencyChart').getContext('2d');
            
            if (charts.riskFrequency) {
                charts.riskFrequency.destroy();
            }
            
            // Agrupar por faixas de frequência de viagens
            const frequencyGroups = {
                '1-10 viagens': [],
                '11-25 viagens': [],
                '26-50 viagens': [],
                '51-100 viagens': [],
                '100+ viagens': []
            };
            
            filteredData.forEach(driver => {
                if (driver.totalTrips <= 10) {
                    frequencyGroups['1-10 viagens'].push(driver);
                } else if (driver.totalTrips <= 25) {
                    frequencyGroups['11-25 viagens'].push(driver);
                } else if (driver.totalTrips <= 50) {
                    frequencyGroups['26-50 viagens'].push(driver);
                } else if (driver.totalTrips <= 100) {
                    frequencyGroups['51-100 viagens'].push(driver);
                } else {
                    frequencyGroups['100+ viagens'].push(driver);
                }
            });
            
            const labels = Object.keys(frequencyGroups);
            const avgRiskScores = labels.map(label => {
                const drivers = frequencyGroups[label];
                if (drivers.length === 0) return 0;
                return drivers.reduce((sum, driver) => sum + driver.riskScore, 0) / drivers.length;
            });
            
            charts.riskFrequency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score Médio de Risco',
                        data: avgRiskScores,
                        backgroundColor: '#8a56e2',
                        borderColor: '#34495e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            ticks: { color: '#bdc3c7' }
                        }
                    }
                }
            });
        }

        // Benchmark de performance vs mercado (Radar Chart)
        function createBenchmarkChart() {
            const ctx = document.getElementById('benchmarkChart').getContext('2d');
            
            if (charts.benchmark) {
                charts.benchmark.destroy();
            }
            
            // Calcular métricas da frota atual
            const avgRiskScore = filteredData.length > 0 ? 
                filteredData.reduce((sum, driver) => sum + driver.riskScore, 0) / filteredData.length : 0;
            const avgEventsPerTrip = filteredData.length > 0 ?
                filteredData.reduce((sum, driver) => sum + driver.eventsPerTrip, 0) / filteredData.length : 0;
            const highRiskPercentage = filteredData.length > 0 ?
                (filteredData.filter(d => d.riskLevel === 'high').length / filteredData.length) * 100 : 0;
            
            // Dados simulados do mercado para comparação
            const marketBenchmark = [65, 75, 80, 70, 60]; // Scores invertidos para melhor visualização
            const fleetPerformance = [
                100 - avgRiskScore, // Segurança (invertido)
                Math.max(0, 100 - (avgEventsPerTrip * 20)), // Eventos (invertido)
                Math.max(0, 100 - highRiskPercentage), // Motoristas baixo risco
                Math.random() * 30 + 60, // Eficiência (simulado)
                Math.random() * 25 + 65  // Conformidade (simulado)
            ];
            
            charts.benchmark = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Segurança', 'Baixos Eventos', 'Motoristas Seguros', 'Eficiência', 'Conformidade'],
                    datasets: [
                        {
                            label: 'Sua Frota',
                            data: fleetPerformance,
                            borderColor: '#14d8b4',
                            backgroundColor: 'rgba(20, 216, 180, 0.2)',
                            pointBackgroundColor: '#14d8b4',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#14d8b4'
                        },
                        {
                            label: 'Benchmark Mercado',
                            data: marketBenchmark,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            pointBackgroundColor: '#f39c12',
                            pointBorderColor: '#ffffff',
                            pointHoverBackgroundColor: '#ffffff',
                            pointHoverBorderColor: '#f39c12'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#bdc3c7' }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            pointLabels: { color: '#bdc3c7' },
                            ticks: { 
                                color: '#bdc3c7',
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Atualizar gráficos
        function updateCharts() {
            createCharts();
        }

        // Renderizar tabela
        function renderTable() {
            const tbody = document.getElementById('driversTableBody');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            pageData.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${driver.driverName}</td>
                    <td><strong>${driver.riskScore.toFixed(2)}</strong></td>
                    <td><span class="risk-badge risk-${driver.riskLevel}">${getRiskLevelText(driver.riskLevel)}</span></td>
                    <td>${driver.totalTrips}</td>
                    <td>${(driver.totalDistance / 1000).toFixed(1)}</td>
                    <td>${driver.lastTrip ? new Date(driver.lastTrip).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td>${driver.riskTrend === 'up' ? '↗' : '↘'}</td>
                    <td>${driver.eventsPerTrip.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Obter texto do nível de risco
        function getRiskLevelText(level) {
            switch (level) {
                case 'low': return 'Baixo';
                case 'medium': return 'Médio';
                case 'high': return 'Alto';
                default: return 'N/A';
            }
        }

        // Atualizar paginação
        function updatePagination() {
            const totalRecords = filteredData.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startRecord = totalRecords > 0 ? (currentPage - 1) * recordsPerPage + 1 : 0;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);

            // Atualizar informações
            document.getElementById('paginationInfo').textContent = 
                `Mostrando ${startRecord}-${endRecord} de ${totalRecords} registros (Página ${currentPage} de ${totalPages})`;

            // Criar botões de paginação
            const buttonsContainer = document.getElementById('paginationButtons');
            buttonsContainer.innerHTML = '';

            if (totalPages <= 1) return;

            // Botão Primeira
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-btn';
            firstBtn.textContent = 'Primeira';
            firstBtn.disabled = currentPage === 1;
            firstBtn.onclick = () => goToPage(1);
            buttonsContainer.appendChild(firstBtn);

            // Botão Anterior
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = 'Anterior';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            buttonsContainer.appendChild(prevBtn);

            // Botões de números (mostrar até 5 páginas)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                buttonsContainer.appendChild(pageBtn);
            }

            // Botão Próxima
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Próxima';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            buttonsContainer.appendChild(nextBtn);

            // Botão Última
            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-btn';
            lastBtn.textContent = 'Última';
            lastBtn.disabled = currentPage === totalPages;
            lastBtn.onclick = () => goToPage(totalPages);
            buttonsContainer.appendChild(lastBtn);
        }

        // Ir para página específica
        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // Alterar registros por página
        function changeRecordsPerPage() {
            recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
            currentPage = 1;
            renderTable();
        }

        // Atualizar dados
        function refreshData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('metricsGrid').style.display = 'none';
            document.getElementById('insightsSection').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('additionalCharts').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            
            // Reset variables
            processedData = [];
            filteredData = [];
            
            // Recarregar com o enterpriseId atual
            currentEnterpriseId = getEnterpriseIdFromUrl();
            
            loadData();
        }

        // Exportar para Excel
        function exportToExcel() {
            const csvContent = [
                ['Motorista', 'Score Preditivo', 'Nível de Risco', 'Total de Viagens', 'Distância (km)', 'Última Viagem', 'Tendência', 'Eventos/Viagem'],
                ...filteredData.map(driver => [
                    driver.driverName,
                    driver.riskScore.toFixed(2),
                    getRiskLevelText(driver.riskLevel),
                    driver.totalTrips,
                    (driver.totalDistance / 1000).toFixed(1),
                    driver.lastTrip ? new Date(driver.lastTrip).toLocaleDateString('pt-BR') : 'N/A',
                    driver.riskTrend === 'up' ? 'Subindo' : 'Descendo',
                    driver.eventsPerTrip.toFixed(2)
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `scorecard_preditivo_${currentEnterpriseId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
    </script>
</body>
</html>

