<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorecard Preditivo de Acidentes</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --background: #1a1e23;
            --surface: #2a2e33;
            --surface-light: #3a3e43;
            --primary: #14d8b4;
            --secondary: #8a56e2;
            --accent: #f39c12;
            --danger: #e67e22;
            --warning: #f1c40f;
            --success: #27ae60;
            --text-primary: #ffffff;
            --text-secondary: #bdc3c7;
            --border: #3a3e43;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--background);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
            font-weight: bold;
            color: var(--background);
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .filters-section {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface-light);
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(20, 216, 180, 0.1);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--surface);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .table-container {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1600px;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            white-space: nowrap;
        }

        th {
            background: var(--surface-light);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .group-header {
            background: var(--primary);
            color: var(--background);
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            text-transform: uppercase;
        }

        .subgroup-header {
            background: var(--secondary);
            color: var(--text-primary);
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }

        td {
            color: var(--text-secondary);
        }

        tr:hover {
            background: rgba(20, 216, 180, 0.05);
        }

        .risk-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-low {
            background: rgba(20, 216, 180, 0.2);
            color: #14d8b4;
        }

        .risk-medium {
            background: rgba(138, 86, 226, 0.2);
            color: #8a56e2;
        }

        .risk-high {
            background: rgba(230, 126, 34, 0.2);
            color: #e67e22;
        }

        .incident-count {
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
        }

        .incident-count.high {
            color: var(--danger);
        }

        .incident-count.medium {
            color: var(--warning);
        }

        .incident-count.low {
            color: var(--success);
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .pagination-controls select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text-primary);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: var(--background);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            color: var(--background);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .pagination {
                flex-direction: column;
                gap: 15px;
            }

            .table-wrapper {
                font-size: 11px;
            }

            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Scorecard Preditivo de Acidentes</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshData()">Atualizar</button>
                <button class="btn btn-primary" onclick="exportToExcel()">Exportar Excel</button>
            </div>
        </div>

        <div id="loadingState" class="loading">
            Carregando dados do scorecard preditivo de acidentes...
        </div>

        <div id="errorState" class="error" style="display: none;">
            <p><strong>Erro:</strong> Não foi possível carregar os dados. Verifique a conectividade e tente novamente.</p>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Métricas Principais -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">R</div>
                    <div class="metric-value" id="avgRiskScore">0</div>
                    <div class="metric-label">Risco Médio da Frota</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">M</div>
                    <div class="metric-value" id="totalDrivers">0</div>
                    <div class="metric-label">Motoristas Monitorados</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">V</div>
                    <div class="metric-value" id="totalTrips">0</div>
                    <div class="metric-label">Viagens Analisadas</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">D</div>
                    <div class="metric-value" id="totalDistance">0</div>
                    <div class="metric-label">Distância Total (km)</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="periodFilter">Período</label>
                        <select id="periodFilter" onchange="applyFilters()">
                            <option value="all">Todos os períodos</option>
                            <option value="7">Últimos 7 dias</option>
                            <option value="30" selected>Últimos 30 dias</option>
                            <option value="90">Últimos 90 dias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="riskFilter">Nível de Risco</label>
                        <select id="riskFilter" onchange="applyFilters()">
                            <option value="all">Todos os níveis</option>
                            <option value="high">Alto Risco</option>
                            <option value="medium">Médio Risco</option>
                            <option value="low">Baixo Risco</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="nameFilter">Nome do Motorista</label>
                        <input type="text" id="nameFilter" placeholder="Buscar motorista..." onkeyup="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label for="scoreFilter">Score Mínimo</label>
                        <input type="number" id="scoreFilter" placeholder="0-100" min="0" max="100" onchange="applyFilters()">
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Distribuição de Risco da Frota</div>
                    <div class="chart-wrapper">
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Top 10 Motoristas por Risco de Acidentes</div>
                    <div class="chart-wrapper">
                        <canvas id="topDriversChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Correlação Risco vs Distância</div>
                    <div class="chart-wrapper">
                        <canvas id="riskDistanceChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Evolução do Risco de Acidentes</div>
                    <div class="chart-wrapper">
                        <canvas id="riskEvolutionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Risco por Frequência de Viagens</div>
                    <div class="chart-wrapper">
                        <canvas id="riskFrequencyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Incidentes por Categoria</div>
                    <div class="chart-wrapper">
                        <canvas id="incidentCategoriesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela Detalhada -->
            <div class="table-container" id="tableContainer" style="display: none;">
                <div class="table-header">
                    <div class="table-title">Detalhamento por Motorista - Análise Completa de Incidentes</div>
                </div>
                <div class="table-wrapper">
                    <table id="driversTable">
                        <thead>
                            <tr>
                                <!-- Informações Básicas -->
                                <th rowspan="3">Motorista</th>
                                <th rowspan="3">Score Geral</th>
                                <th rowspan="3">Score ML</th>
                                <th rowspan="3">Score Preditivo de Acidentes</th>
                                <th rowspan="3">Nível de Risco</th>
                                <th rowspan="3">Total Viagens</th>
                                <th rowspan="3">Distância (km)</th>
                                <th rowspan="3">Última Viagem</th>
                                
                                <!-- Grupos de Incidentes -->
                                <th colspan="4" class="group-header">Movimento do Veículo</th>
                                <th colspan="9" class="group-header">Direção Agressiva</th>
                                <th colspan="3" class="group-header">Distrações / Fadiga</th>
                                <th colspan="3" class="group-header">Condições Técnicas</th>
                                <th rowspan="3">Total Eventos</th>
                            </tr>
                            <tr>
                                <!-- Movimento do Veículo -->
                                <th>Em Movimento</th>
                                <th>Parado</th>
                                <th>Marcha Lenta</th>
                                <th>Acc Events</th>
                                
                                <!-- Direção Agressiva - Subgrupos -->
                                <th colspan="2" class="subgroup-header">Aceleração</th>
                                <th colspan="4" class="subgroup-header">Frenagem</th>
                                <th colspan="3" class="subgroup-header">Curvas</th>
                                
                                <!-- Distrações / Fadiga -->
                                <th>Smartphone</th>
                                <th>Mov. Telefone</th>
                                <th>Fadiga</th>
                                
                                <!-- Condições Técnicas -->
                                <th>Alta Temp.</th>
                                <th>Bateria Baixa</th>
                                <th>Inércia</th>
                            </tr>
                            <tr>
                                <!-- Movimento do Veículo -->
                                <th>Mov</th>
                                <th>Stop</th>
                                <th>Idle</th>
                                <th>Acc</th>
                                
                                <!-- Direção Agressiva - Aceleração -->
                                <th>Freq</th>
                                <th>Alta</th>
                                
                                <!-- Direção Agressiva - Frenagem -->
                                <th>Freq</th>
                                <th>Alta</th>
                                <th>Paradas</th>
                                <th>Pós-Curva</th>
                                
                                <!-- Direção Agressiva - Curvas -->
                                <th>Curvas</th>
                                <th>Pré-Curva</th>
                                <th>Desvios</th>
                                
                                <!-- Distrações / Fadiga -->
                                <th>Uso</th>
                                <th>Mov</th>
                                <th>Fadiga</th>
                                
                                <!-- Condições Técnicas -->
                                <th>Temp</th>
                                <th>Bat</th>
                                <th>Inert</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <div class="pagination-info" id="paginationInfo">
                        Mostrando 0-0 de 0 registros
                    </div>
                    <div class="pagination-controls">
                        <select id="recordsPerPage" onchange="changeRecordsPerPage()">
                            <option value="25">25 por página</option>
                            <option value="50" selected>50 por página</option>
                            <option value="100">100 por página</option>
                            <option value="200">200 por página</option>
                        </select>
                        <div class="pagination-buttons" id="paginationButtons">
                            <!-- Botões serão inseridos via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurações globais
        const PRODUCTION_MODE = true;
        const API_BASE = 'https://firebase-bi-api.onrender.com';
        
        // Variáveis globais
        let allDriversData = [];
        let filteredData = [];
        let usersMap = new Map();
        let currentPage = 1;
        let recordsPerPage = 50;
        let charts = {};

        // Função para logs condicionais (apenas em desenvolvimento)
        function debugLog(...args) {
            if (!PRODUCTION_MODE) {
                console.log(...args);
            }
        }

        // Capturar enterpriseId dinamicamente da URL
        function getEnterpriseIdFromUrl() {
            try {
                // Método 1: URL atual (window.location)
                const currentUrl = new URL(window.location.href);
                let enterpriseId = currentUrl.searchParams.get('enterpriseId');
                
                if (enterpriseId) {
                    debugLog('Enterprise ID capturado da URL:', enterpriseId);
                    return enterpriseId;
                }
                
                // Método 2: Hash parameters
                const hash = window.location.hash;
                if (hash.includes('enterpriseId=')) {
                    const hashParams = new URLSearchParams(hash.substring(1));
                    enterpriseId = hashParams.get('enterpriseId');
                    if (enterpriseId) {
                        debugLog('Enterprise ID capturado do hash:', enterpriseId);
                        return enterpriseId;
                    }
                }
                
                // Método 3: Pathname
                const pathParts = window.location.pathname.split('/');
                const enterpriseIndex = pathParts.indexOf('enterprise');
                if (enterpriseIndex !== -1 && pathParts[enterpriseIndex + 1]) {
                    enterpriseId = pathParts[enterpriseIndex + 1];
                    debugLog('Enterprise ID capturado do pathname:', enterpriseId);
                    return enterpriseId;
                }
                
                // Método 4: Variável global
                if (window.currentEnterpriseId) {
                    debugLog('Enterprise ID capturado de variável global:', window.currentEnterpriseId);
                    return window.currentEnterpriseId;
                }
                
                // Método 5: Storage
                enterpriseId = sessionStorage.getItem('enterpriseId') || localStorage.getItem('enterpriseId');
                if (enterpriseId) {
                    debugLog('Enterprise ID capturado do storage:', enterpriseId);
                    return enterpriseId;
                }
                
                // Fallback padrão
                debugLog('Usando enterprise ID padrão');
                return 'qzDVZ1jB6IC60baxtsDU';
                
            } catch (error) {
                debugLog('Erro ao capturar enterprise ID:', error);
                return 'qzDVZ1jB6IC60baxtsDU';
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Iniciando scorecard preditivo de acidentes...');
            loadData();
        });

        // Carregar dados das APIs
        async function loadData() {
            try {
                const currentEnterpriseId = getEnterpriseIdFromUrl();
                debugLog('Carregando dados para enterprise:', currentEnterpriseId);
                
                // Carregar dados das APIs com timeout
                const [tripsData, usersData] = await Promise.all([
                    fetchWithTimeout(`${API_BASE}/trips?enterpriseId=${currentEnterpriseId}`, 15000),
                    fetchWithTimeout(`${API_BASE}/users?enterpriseId=${currentEnterpriseId}`, 15000).catch(() => null)
                ]);

                debugLog('Dados trips carregados:', tripsData?.data?.length || 0, 'registros');
                debugLog('Dados users carregados:', usersData?.data?.length || 0, 'registros');

                // Processar dados de usuários para mapeamento
                if (usersData && usersData.data && usersData.data.length > 0) {
                    usersData.data.forEach(user => {
                        if (user.id && user.name && user.name !== 'N/A') {
                            usersMap.set(user.id, user.name);
                        }
                    });
                    debugLog('Mapeamento de usuários criado:', usersMap.size, 'entradas');
                }

                // Processar dados de viagens
                if (tripsData && tripsData.data && tripsData.data.length > 0) {
                    processTripsData(tripsData.data);
                    
                    // Mostrar conteúdo principal
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('tableContainer').style.display = 'block';
                    
                    // Atualizar interface
                    updateMetrics();
                    createCharts();
                    applyFilters();
                    
                } else {
                    throw new Error('Nenhum dado de viagens disponível');
                }

            } catch (error) {
                debugLog('Erro ao carregar dados:', error);
                showError('Erro ao carregar dados das APIs. Verifique a conectividade.');
            }
        }

        // Fetch com timeout
        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        // Processar dados de viagens
        function processTripsData(trips) {
            debugLog('Processando', trips.length, 'viagens...');
            
            const driversMap = new Map();

            trips.forEach(trip => {
                const userString = trip.UserString;
                if (!userString) return;

                if (!driversMap.has(userString)) {
                    driversMap.set(userString, {
                        userString: userString,
                        driverName: getDriverName(userString),
                        trips: [],
                        totalDistance: 0,
                        totalScore: 0,
                        totalScoreML: 0,
                        
                        // 1. Movimento do Veículo
                        vehicleInMotion: 0,
                        vehicleStopped: 0,
                        idling: 0,
                        accEvents: 0,
                        
                        // 2. Direção Agressiva - Aceleração
                        frequentAcceleration: 0,
                        highAcceleration: 0,
                        
                        // 2. Direção Agressiva - Frenagem
                        frequentBraking: 0,
                        highDeceleration: 0,
                        frequentStops: 0,
                        decAfterCurve: 0,
                        
                        // 2. Direção Agressiva - Curvas
                        cornering: 0,
                        accBeforeCurve: 0,
                        swerving: 0,
                        
                        // 3. Distrações / Fadiga
                        smartphoneUsage: 0,
                        phoneMovement: 0,
                        driverFatigue: 0,
                        
                        // 4. Condições Técnicas
                        highTemperature: 0,
                        lowBattery: 0,
                        inertiaEvents: 0,
                        
                        // Total
                        totalEvents: 0
                    });
                }

                const driver = driversMap.get(userString);
                driver.trips.push(trip);
                driver.totalDistance += trip.TripDistance || 0;
                
                // Somar scores
                driver.totalScore += trip.score || 0;
                driver.totalScoreML += trip.scoreML || 0;
                
                // 1. Movimento do Veículo
                driver.vehicleInMotion += trip.AmountOfVehicleInMotionEvents || 0;
                driver.vehicleStopped += trip.AmountOfVehicleStoppedEvents || 0;
                driver.idling += trip.AmountOfIdlingEvents || 0;
                driver.accEvents += trip.accEvents || 0;
                
                // 2. Direção Agressiva - Aceleração
                driver.frequentAcceleration += trip.AmountOfFrequentAccelerationEvents || 0;
                driver.highAcceleration += trip.AmountOfHighAccEvents || 0;
                
                // 2. Direção Agressiva - Frenagem
                driver.frequentBraking += trip.AmountOfFrequentBrakingEvents || 0;
                driver.highDeceleration += trip.AmountOfHighDecEvents || 0;
                driver.frequentStops += trip.AmountOfFrequentStopEvents || 0;
                driver.decAfterCurve += trip.AmountOfDecAfterCurveEvents || 0;
                
                // 2. Direção Agressiva - Curvas
                driver.cornering += trip.AmountOfCorneringEvents || 0;
                driver.accBeforeCurve += trip.AmountOfAccBeforeCurveEvents || 0;
                driver.swerving += trip.AmountOfSwervingEvents || 0;
                
                // 3. Distrações / Fadiga
                driver.smartphoneUsage += trip.AmountOfSmartphoneUsageEvents || 0;
                driver.phoneMovement += trip.amountOfPhoneMovementEvents || 0;
                driver.driverFatigue += trip.AmountOfDriverFatigueEvents || 0;
                
                // 4. Condições Técnicas
                driver.highTemperature += trip.AmountOfHighTemperatureEvents || 0;
                driver.lowBattery += trip.AmountOfLowBatteryEvents || 0;
                driver.inertiaEvents += trip.inertiaEvents || 0;
                
                // Total de eventos
                driver.totalEvents += trip.totalEvents || 0;
            });

            // Converter para array e calcular métricas
            allDriversData = Array.from(driversMap.values()).map(driver => {
                const tripCount = driver.trips.length;
                const avgScore = tripCount > 0 ? driver.totalScore / tripCount : 0;
                const avgScoreML = tripCount > 0 ? driver.totalScoreML / tripCount : 0;
                
                // Calcular score preditivo de acidentes baseado em eventos de risco
                const riskScore = calculateAccidentRiskScore(driver);
                
                // Determinar nível de risco
                let riskLevel = 'low';
                if (riskScore >= 70) riskLevel = 'high';
                else if (riskScore >= 40) riskLevel = 'medium';

                // Última viagem
                const lastTrip = driver.trips.reduce((latest, trip) => {
                    const tripDate = new Date(trip.TimestampDate || trip.TimeStamp);
                    const latestDate = new Date(latest.TimestampDate || latest.TimeStamp);
                    return tripDate > latestDate ? trip : latest;
                }, driver.trips[0]);

                return {
                    driverName: driver.driverName,
                    userString: driver.userString,
                    totalTrips: tripCount,
                    totalDistance: driver.totalDistance,
                    avgScore: avgScore,
                    avgScoreML: avgScoreML,
                    riskScore: riskScore,
                    riskLevel: riskLevel,
                    lastTrip: lastTrip ? (lastTrip.TimestampDate || lastTrip.TimeStamp) : null,
                    
                    // Todos os campos de incidentes
                    vehicleInMotion: driver.vehicleInMotion,
                    vehicleStopped: driver.vehicleStopped,
                    idling: driver.idling,
                    accEvents: driver.accEvents,
                    frequentAcceleration: driver.frequentAcceleration,
                    highAcceleration: driver.highAcceleration,
                    frequentBraking: driver.frequentBraking,
                    highDeceleration: driver.highDeceleration,
                    frequentStops: driver.frequentStops,
                    decAfterCurve: driver.decAfterCurve,
                    cornering: driver.cornering,
                    accBeforeCurve: driver.accBeforeCurve,
                    swerving: driver.swerving,
                    smartphoneUsage: driver.smartphoneUsage,
                    phoneMovement: driver.phoneMovement,
                    driverFatigue: driver.driverFatigue,
                    highTemperature: driver.highTemperature,
                    lowBattery: driver.lowBattery,
                    inertiaEvents: driver.inertiaEvents,
                    totalEvents: driver.totalEvents
                };
            });

            debugLog('Processados', allDriversData.length, 'motoristas');
        }

        // Calcular score preditivo de acidentes
        function calculateAccidentRiskScore(driver) {
            const tripCount = driver.trips.length;
            if (tripCount === 0) return 0;

            // Fatores de risco para acidentes (pesos ajustados)
            const smartphoneRisk = (driver.smartphoneUsage / tripCount) * 25; // 25% do peso
            const fatigueRisk = (driver.driverFatigue / tripCount) * 20; // 20% do peso
            const swervingRisk = (driver.swerving / tripCount) * 20; // 20% do peso
            const brakingRisk = (driver.frequentBraking / tripCount) * 15; // 15% do peso
            const accelerationRisk = (driver.frequentAcceleration / tripCount) * 10; // 10% do peso
            const phoneMovementRisk = (driver.phoneMovement / tripCount) * 10; // 10% do peso

            const totalRisk = smartphoneRisk + fatigueRisk + swervingRisk + brakingRisk + accelerationRisk + phoneMovementRisk;
            
            // Normalizar para 0-100 (limitando a 100)
            return Math.min(100, totalRisk);
        }

        // Obter nome do motorista
        function getDriverName(userString) {
            if (usersMap.size > 0) {
                const driverName = usersMap.get(userString);
                if (driverName && driverName !== 'N/A') {
                    return driverName;
                }
            }
            return `Motorista ${userString.substring(0, 8)}...`;
        }

        // Atualizar métricas
        function updateMetrics() {
            const totalDrivers = allDriversData.length;
            const totalTrips = allDriversData.reduce((sum, driver) => sum + driver.totalTrips, 0);
            const totalDistance = allDriversData.reduce((sum, driver) => sum + driver.totalDistance, 0);
            const avgRiskScore = totalDrivers > 0 ? 
                allDriversData.reduce((sum, driver) => sum + driver.riskScore, 0) / totalDrivers : 0;

            document.getElementById('totalDrivers').textContent = totalDrivers;
            document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
            document.getElementById('totalDistance').textContent = (totalDistance / 1000).toFixed(0);
            document.getElementById('avgRiskScore').textContent = avgRiskScore.toFixed(1);
        }

        // Criar gráficos
        function createCharts() {
            createRiskDistributionChart();
            createTopDriversChart();
            createRiskDistanceChart();
            createRiskEvolutionChart();
            createRiskFrequencyChart();
            createIncidentCategoriesChart();
        }

        // Gráfico de distribuição de risco
        function createRiskDistributionChart() {
            const ctx = document.getElementById('riskDistributionChart').getContext('2d');
            
            const riskCounts = {
                low: allDriversData.filter(d => d.riskLevel === 'low').length,
                medium: allDriversData.filter(d => d.riskLevel === 'medium').length,
                high: allDriversData.filter(d => d.riskLevel === 'high').length
            };

            if (charts.riskDistribution) {
                charts.riskDistribution.destroy();
            }

            charts.riskDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Baixo Risco', 'Médio Risco', 'Alto Risco'],
                    datasets: [{
                        data: [riskCounts.low, riskCounts.medium, riskCounts.high],
                        backgroundColor: [
                            'rgba(20, 216, 180, 0.8)',
                            'rgba(138, 86, 226, 0.8)',
                            'rgba(230, 126, 34, 0.8)'
                        ],
                        borderWidth: 0,
                        hoverBorderWidth: 0,
                        cutout: '65%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#bdc3c7',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    },
                    animation: {
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // Gráfico top 10 motoristas
        function createTopDriversChart() {
            const ctx = document.getElementById('topDriversChart').getContext('2d');
            
            const top10 = allDriversData
                .sort((a, b) => b.riskScore - a.riskScore)
                .slice(0, 10);

            if (charts.topDrivers) {
                charts.topDrivers.destroy();
            }

            charts.topDrivers = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.driverName.length > 15 ? d.driverName.substring(0, 15) + '...' : d.driverName),
                    datasets: [{
                        label: 'Score de Risco de Acidentes',
                        data: top10.map(d => d.riskScore),
                        backgroundColor: top10.map(driver => 
                            driver.riskLevel === 'high' ? 'rgba(230, 126, 34, 0.8)' :
                            driver.riskLevel === 'medium' ? 'rgba(138, 86, 226, 0.8)' : 'rgba(20, 216, 180, 0.8)'
                        ),
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#bdc3c7',
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Gráfico correlação risco vs distância
        function createRiskDistanceChart() {
            const ctx = document.getElementById('riskDistanceChart').getContext('2d');

            if (charts.riskDistance) {
                charts.riskDistance.destroy();
            }

            charts.riskDistance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Motoristas',
                        data: allDriversData.map(d => ({
                            x: d.totalDistance / 1000,
                            y: d.riskScore
                        })),
                        backgroundColor: 'rgba(20, 216, 180, 0.6)',
                        borderColor: 'rgba(20, 216, 180, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distância Total (km)',
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Score de Risco de Acidentes',
                                color: '#bdc3c7'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico evolução do risco
        function createRiskEvolutionChart() {
            const ctx = document.getElementById('riskEvolutionChart').getContext('2d');

            // Dados simulados para evolução (últimos 6 meses)
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
            const avgRisk = allDriversData.length > 0 ? 
                allDriversData.reduce((sum, d) => sum + d.riskScore, 0) / allDriversData.length : 0;
            
            const evolutionData = months.map(() => avgRisk + (Math.random() - 0.5) * 20);

            if (charts.riskEvolution) {
                charts.riskEvolution.destroy();
            }

            charts.riskEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Risco Médio de Acidentes',
                        data: evolutionData,
                        borderColor: 'rgba(20, 216, 180, 1)',
                        backgroundColor: 'rgba(20, 216, 180, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico risco por frequência
        function createRiskFrequencyChart() {
            const ctx = document.getElementById('riskFrequencyChart').getContext('2d');

            // Agrupar por faixas de viagens
            const frequencyGroups = {
                '1-10': allDriversData.filter(d => d.totalTrips >= 1 && d.totalTrips <= 10),
                '11-25': allDriversData.filter(d => d.totalTrips >= 11 && d.totalTrips <= 25),
                '26-50': allDriversData.filter(d => d.totalTrips >= 26 && d.totalTrips <= 50),
                '50+': allDriversData.filter(d => d.totalTrips > 50)
            };

            const avgRiskByFrequency = Object.keys(frequencyGroups).map(key => {
                const group = frequencyGroups[key];
                return group.length > 0 ? 
                    group.reduce((sum, d) => sum + d.riskScore, 0) / group.length : 0;
            });

            if (charts.riskFrequency) {
                charts.riskFrequency.destroy();
            }

            charts.riskFrequency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1-10 viagens', '11-25 viagens', '26-50 viagens', '50+ viagens'],
                    datasets: [{
                        label: 'Risco Médio de Acidentes',
                        data: avgRiskByFrequency,
                        backgroundColor: 'rgba(138, 86, 226, 0.8)',
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico categorias de incidentes
        function createIncidentCategoriesChart() {
            const ctx = document.getElementById('incidentCategoriesChart').getContext('2d');

            // Somar incidentes por categoria
            const categoryTotals = {
                'Movimento Veículo': allDriversData.reduce((sum, d) => sum + d.vehicleInMotion + d.vehicleStopped + d.idling + d.accEvents, 0),
                'Direção Agressiva': allDriversData.reduce((sum, d) => sum + d.frequentAcceleration + d.highAcceleration + d.frequentBraking + d.highDeceleration + d.frequentStops + d.decAfterCurve + d.cornering + d.accBeforeCurve + d.swerving, 0),
                'Distrações/Fadiga': allDriversData.reduce((sum, d) => sum + d.smartphoneUsage + d.phoneMovement + d.driverFatigue, 0),
                'Condições Técnicas': allDriversData.reduce((sum, d) => sum + d.highTemperature + d.lowBattery + d.inertiaEvents, 0)
            };

            if (charts.incidentCategories) {
                charts.incidentCategories.destroy();
            }

            charts.incidentCategories = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        label: 'Total de Incidentes',
                        data: Object.values(categoryTotals),
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(230, 126, 34, 0.8)',
                            'rgba(231, 76, 60, 0.8)',
                            'rgba(155, 89, 182, 0.8)'
                        ],
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#bdc3c7'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#bdc3c7',
                                maxRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // Aplicar filtros
        function applyFilters() {
            const periodFilter = document.getElementById('periodFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
            const scoreFilter = parseFloat(document.getElementById('scoreFilter').value) || 0;

            filteredData = allDriversData.filter(driver => {
                // Filtro de período (simplificado)
                let periodMatch = true;
                if (periodFilter !== 'all' && driver.lastTrip) {
                    const tripDate = new Date(driver.lastTrip);
                    const daysAgo = parseInt(periodFilter);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                    periodMatch = tripDate >= cutoffDate;
                }

                // Filtro de risco
                const riskMatch = riskFilter === 'all' || driver.riskLevel === riskFilter;

                // Filtro de nome
                const nameMatch = nameFilter === '' || driver.driverName.toLowerCase().includes(nameFilter);

                // Filtro de score
                const scoreMatch = driver.riskScore >= scoreFilter;

                return periodMatch && riskMatch && nameMatch && scoreMatch;
            });

            currentPage = 1;
            renderTable();
        }

        // Renderizar tabela
        function renderTable() {
            const tbody = document.getElementById('driversTableBody');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = Math.min(startIndex + recordsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);

            tbody.innerHTML = '';

            pageData.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${driver.driverName}</strong></td>
                    <td>${driver.avgScore.toFixed(1)}</td>
                    <td>${driver.avgScoreML.toFixed(1)}</td>
                    <td><strong>${driver.riskScore.toFixed(2)}</strong></td>
                    <td><span class="risk-badge risk-${driver.riskLevel}">${getRiskLevelText(driver.riskLevel)}</span></td>
                    <td>${driver.totalTrips}</td>
                    <td>${(driver.totalDistance / 1000).toFixed(1)}</td>
                    <td>${driver.lastTrip ? new Date(driver.lastTrip).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    
                    <!-- Movimento do Veículo -->
                    <td><span class="incident-count ${getIncidentClass(driver.vehicleInMotion)}">${driver.vehicleInMotion}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.vehicleStopped)}">${driver.vehicleStopped}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.idling)}">${driver.idling}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.accEvents)}">${driver.accEvents}</span></td>
                    
                    <!-- Direção Agressiva - Aceleração -->
                    <td><span class="incident-count ${getIncidentClass(driver.frequentAcceleration)}">${driver.frequentAcceleration}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.highAcceleration)}">${driver.highAcceleration}</span></td>
                    
                    <!-- Direção Agressiva - Frenagem -->
                    <td><span class="incident-count ${getIncidentClass(driver.frequentBraking)}">${driver.frequentBraking}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.highDeceleration)}">${driver.highDeceleration}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.frequentStops)}">${driver.frequentStops}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.decAfterCurve)}">${driver.decAfterCurve}</span></td>
                    
                    <!-- Direção Agressiva - Curvas -->
                    <td><span class="incident-count ${getIncidentClass(driver.cornering)}">${driver.cornering}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.accBeforeCurve)}">${driver.accBeforeCurve}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.swerving)}">${driver.swerving}</span></td>
                    
                    <!-- Distrações / Fadiga -->
                    <td><span class="incident-count ${getIncidentClass(driver.smartphoneUsage)}">${driver.smartphoneUsage}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.phoneMovement)}">${driver.phoneMovement}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.driverFatigue)}">${driver.driverFatigue}</span></td>
                    
                    <!-- Condições Técnicas -->
                    <td><span class="incident-count ${getIncidentClass(driver.highTemperature)}">${driver.highTemperature}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.lowBattery)}">${driver.lowBattery}</span></td>
                    <td><span class="incident-count ${getIncidentClass(driver.inertiaEvents)}">${driver.inertiaEvents}</span></td>
                    
                    <!-- Total -->
                    <td><span class="incident-count ${getIncidentClass(driver.totalEvents)}">${driver.totalEvents}</span></td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        // Obter classe CSS para incidentes
        function getIncidentClass(count) {
            if (count >= 10) return 'high';
            if (count >= 5) return 'medium';
            return 'low';
        }

        // Obter texto do nível de risco
        function getRiskLevelText(level) {
            switch (level) {
                case 'low': return 'Baixo';
                case 'medium': return 'Médio';
                case 'high': return 'Alto';
                default: return 'N/A';
            }
        }

        // Atualizar paginação
        function updatePagination() {
            const totalRecords = filteredData.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);

            document.getElementById('paginationInfo').textContent = 
                `Mostrando ${startRecord}-${endRecord} de ${totalRecords} registros`;

            const buttonsContainer = document.getElementById('paginationButtons');
            buttonsContainer.innerHTML = '';

            // Botão anterior
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '‹ Anterior';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            };
            buttonsContainer.appendChild(prevBtn);

            // Botões de página
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderTable();
                };
                buttonsContainer.appendChild(pageBtn);
            }

            // Botão próximo
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Próximo ›';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            };
            buttonsContainer.appendChild(nextBtn);
        }

        // Alterar registros por página
        function changeRecordsPerPage() {
            recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
            currentPage = 1;
            renderTable();
        }

        // Atualizar dados
        function refreshData() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            loadData();
        }

        // Exportar para Excel
        function exportToExcel() {
            const csvContent = generateCSV();
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `scorecard_preditivo_acidentes_completo_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Gerar CSV
        function generateCSV() {
            const headers = [
                'Motorista',
                'Score Geral',
                'Score ML',
                'Score Preditivo de Acidentes',
                'Nível de Risco',
                'Total Viagens',
                'Distância (km)',
                'Última Viagem',
                // Movimento do Veículo
                'Veículo em Movimento',
                'Veículo Parado',
                'Marcha Lenta',
                'Eventos Aceleração',
                // Direção Agressiva - Aceleração
                'Acelerações Frequentes',
                'Acelerações Altas',
                // Direção Agressiva - Frenagem
                'Frenagens Frequentes',
                'Desacelerações Altas',
                'Paradas Frequentes',
                'Desaceleração Pós-Curva',
                // Direção Agressiva - Curvas
                'Eventos de Curva',
                'Aceleração Pré-Curva',
                'Desvios',
                // Distrações / Fadiga
                'Uso Smartphone',
                'Movimento Telefone',
                'Fadiga',
                // Condições Técnicas
                'Alta Temperatura',
                'Bateria Baixa',
                'Eventos Inércia',
                // Total
                'Total Eventos'
            ];

            const rows = filteredData.map(driver => [
                driver.driverName,
                driver.avgScore.toFixed(1),
                driver.avgScoreML.toFixed(1),
                driver.riskScore.toFixed(2),
                getRiskLevelText(driver.riskLevel),
                driver.totalTrips,
                (driver.totalDistance / 1000).toFixed(1),
                driver.lastTrip ? new Date(driver.lastTrip).toLocaleDateString('pt-BR') : 'N/A',
                driver.vehicleInMotion,
                driver.vehicleStopped,
                driver.idling,
                driver.accEvents,
                driver.frequentAcceleration,
                driver.highAcceleration,
                driver.frequentBraking,
                driver.highDeceleration,
                driver.frequentStops,
                driver.decAfterCurve,
                driver.cornering,
                driver.accBeforeCurve,
                driver.swerving,
                driver.smartphoneUsage,
                driver.phoneMovement,
                driver.driverFatigue,
                driver.highTemperature,
                driver.lowBattery,
                driver.inertiaEvents,
                driver.totalEvents
            ]);

            return [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        // Mostrar erro
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').innerHTML = `
                <p><strong>Erro:</strong> ${message}</p>
            `;
        }
    </script>
</body>
</html>

