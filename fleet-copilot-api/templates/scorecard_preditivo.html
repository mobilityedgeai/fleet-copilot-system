<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scorecard Preditivo de Risco - Sentinel Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1dd1a1;           /* Verde água principal */
            --primary-dark: #10ac84;      /* Verde água escuro */
            --primary-light: #55efc4;     /* Verde água claro */
            --background: #1a1e23;        /* Fundo preto padrão dos BIs */
            --surface: #2c3e50;           /* Superfície */
            --surface-light: #34495e;     /* Superfície clara */
            --surface-lighter: #57606f;   /* Superfície mais clara */
            --text: #ffffff;              /* Texto branco */
            --text-secondary: #a4b0be;    /* Texto secundário */
            --text-muted: #747d8c;        /* Texto esmaecido */
            --border: #34495e;            /* Bordas */
            --success: #2ed573;           /* Verde sucesso */
            --warning: #ffa502;           /* Laranja aviso */
            --error: #ff3838;             /* Vermelho erro */
            --info: #3742fa;              /* Azul info */
            --accent: #5f27cd;            /* Roxo accent */

            /* Cores para predição de risco */
            --risk-very-low: #2ecc71;     /* Verde escuro */
            --risk-low: #27ae60;          /* Verde */
            --risk-moderate: #f1c40f;     /* Amarelo */
            --risk-high: #e67e22;         /* Laranja */
            --risk-very-high: #c0392b;    /* Vermelho escuro */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px 0;
            border-bottom: 2px solid var(--primary);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title svg {
            width: 32px;
            height: 32px;
            color: var(--primary);
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 0 1px var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 0 0 1px var(--primary-dark), 0 0 20px rgba(29, 209, 161, 0.3);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-lighter);
            border-color: var(--primary);
        }

        /* Filters */
        .filters-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(29, 209, 161, 0.1);
        }

        .filters-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(29, 209, 161, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--error); }
        .stat-change.neutral { color: var(--text-muted); }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Enhanced Table */
        .table-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text);
            font-size: 14px;
            width: 200px;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            max-height: 600px;
        }

        .enhanced-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-light);
            font-size: 13px;
        }

        .enhanced-table th {
            background: var(--surface-lighter);
            color: var(--text);
            font-weight: 600;
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 12px;
        }

        .enhanced-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 12px;
        }

        .enhanced-table tr:hover {
            background: var(--surface);
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination-select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text);
            font-size: 14px;
        }

        .pagination-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface-light);
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Score Badges */
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 11px;
            color: white;
        }

        .score-excellent { background: var(--success); }
        .score-good { background: var(--primary); }
        .score-average { background: var(--warning); }
        .score-poor { background: var(--error); }

        /* Driver Info */
        .driver-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .driver-name {
            font-weight: 600;
            color: var(--text);
            font-size: 13px;
        }

        .driver-details {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Trip Info */
        .trip-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .trip-route {
            font-size: 11px;
            color: var(--text-secondary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .trip-distance {
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
        }

        /* Risk Indicators */
        .risk-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }

        .risk-very-low { background: rgba(46, 204, 113, 0.2); color: var(--risk-very-low); }
        .risk-low { background: rgba(39, 174, 96, 0.2); color: var(--risk-low); }
        .risk-moderate { background: rgba(241, 196, 15, 0.2); color: var(--risk-moderate); }
        .risk-high { background: rgba(230, 126, 34, 0.2); color: var(--risk-high); }
        .risk-very-high { background: rgba(192, 57, 43, 0.2); color: var(--risk-very-high); }

        /* Predictive Risk Gauge */
        .gauge-container {
            width: 100%;
            height: 200px;
            position: relative;
        }

        .gauge-value {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
        }

        .gauge-label {
            position: absolute;
            top: 80%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 30, 35, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(29, 209, 161, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: rgba(255, 56, 56, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            font-size: 0.8rem;
            z-index: 1000;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-title {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .debug-item {
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .debug-value {
            color: var(--text);
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .charts-section {
                grid-template-columns: 1fr;
            }

            .table-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }

            .pagination-container {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading">
        <div class="spinner"></div>
        <div style="color: var(--text-secondary); font-size: 16px;">Carregando dados...</div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="error-message"></div>

    <!-- Debug Panel -->
    <div id="debugPanel" class="debug-panel">
        <div class="debug-title">Debug Info</div>
        <div class="debug-item">API Status: <span class="debug-value" id="debugApiStatus">-</span></div>
        <div class="debug-item">Trips Loaded: <span class="debug-value" id="debugTripsCount">-</span></div>
        <div class="debug-item">Users Loaded: <span class="debug-value" id="debugUsersCount">-</span></div>
        <div class="debug-item">DE-PARA Success: <span class="debug-value" id="debugDeParaCount">-</span></div>
        <div class="debug-item">Last Error: <span class="debug-value" id="debugLastError">-</span></div>
        <div class="debug-item">Last Update: <span class="debug-value" id="debugLastUpdate">-</span></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <div>
                    <h1>Scorecard Preditivo de Risco</h1>
                    <div class="header-subtitle">Análise Avançada de Segurança e Prevenção de Acidentes</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="toggleDebug()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/>
                    </svg>
                    Debug
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Atualizar
                </button>
                <button class="btn btn-primary" onclick="exportToExcel()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Exportar Excel
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Período</label>
                    <select id="periodFilter">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Motorista</label>
                    <select id="driverFilter">
                        <option value="">Todos os motoristas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Nível de Risco</label>
                    <select id="riskFilter">
                        <option value="">Todos os níveis</option>
                        <option value="very-low">Muito Baixo (0-20%)</option>
                        <option value="low">Baixo (21-40%)</option>
                        <option value="moderate">Moderado (41-60%)</option>
                        <option value="high">Alto (61-80%)</option>
                        <option value="very-high">Muito Alto (81-100%)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Data Início</label>
                    <input type="date" id="startDateFilter">
                </div>
                <div class="filter-group">
                    <label>Data Fim</label>
                    <input type="date" id="endDateFilter">
                </div>
            </div>
            <div class="filters-actions">
                <button class="btn btn-secondary" onclick="clearFilters()">Limpar Filtros</button>
                <button class="btn btn-primary" onclick="applyFilters()">Aplicar Filtros</button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboardStats" class="dashboard-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Total de Viagens</span>
                    <svg class="stat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18,18.5A1.5,1.5 0 0,1 16.5,20A1.5,1.5 0 0,1 15,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,18.5M19.5,9.5L21.46,12H17V9.5M6,18.5A1.5,1.5 0 0,1 4.5,20A1.5,1.5 0 0,1 3,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,18.5M20,8H17V4H3C1.89,4 1,4.89 1,6V18A2,2 0 0,0 3,20H4.5A3.5,3.5 0 0,0 8,16.5A3.5,3.5 0 0,0 4.5,13A3.5,3.5 0 0,0 1,16.5V6A4,4 0 0,1 5,2H19A2,2 0 0,1 21,4V8A1,1 0 0,1 20,8Z"/>
                    </svg>
                </div>
                <div class="stat-value" id="totalTrips">0</div>
                <div class="stat-change neutral">Período selecionado</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Score Médio Geral</span>
                    <svg class="stat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.46,13.97L5.82,21L12,17.27Z"/>
                    </svg>
                </div>
                <div class="stat-value" id="averageScore">0</div>
                <div class="stat-change" id="scoreChange">Excelente</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Distância Total</span>
                    <svg class="stat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                </div>
                <div class="stat-value" id="totalDistance">0 km</div>
                <div class="stat-change neutral">Quilometragem percorrida</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Eventos de Risco</span>
                    <svg class="stat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                    </svg>
                </div>
                <div class="stat-value" id="riskEvents">0</div>
                <div class="stat-change neutral">Alertas de segurança</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span class="stat-title">Risco Preditivo da Frota</span>
                    <svg class="stat-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z"/>
                    </svg>
                </div>
                <div class="stat-value" id="fleetRisk">0%</div>
                <div class="stat-change" id="riskChange">Baixo</div>
            </div>
        </div>

        <!-- Charts -->
        <div id="chartsSection" class="charts-section" style="display: none;">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Risco Preditivo da Frota</div>
                </div>
                <div class="chart-container">
                    <canvas id="riskGaugeChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">Distribuição de Risco por Motorista (Top 10)</div>
                </div>
                <div class="chart-container">
                    <canvas id="driverRiskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div id="tableSection" class="table-section" style="display: none;">
            <div class="table-header">
                <div class="table-title">Detalhamento das Viagens com Risco Preditivo</div>
                <div class="table-controls">
                    <input type="text" class="search-box" id="searchBox" placeholder="Buscar motorista...">
                    <select class="pagination-select" id="pageSize" onchange="changePageSize()">
                        <option value="50">50 por página</option>
                        <option value="100" selected>100 por página</option>
                        <option value="200">200 por página</option>
                        <option value="500">500 por página</option>
                    </select>
                </div>
            </div>

            <div class="table-container">
                <table class="enhanced-table">
                    <thead>
                        <tr>
                            <th>Motorista</th>
                            <th>Placa</th>
                            <th>Rota</th>
                            <th>Score Geral</th>
                            <th>Score Aceleração</th>
                            <th>Score Frenagem</th>
                            <th>Score Velocidade</th>
                            <th>Eventos Risco</th>
                            <th>Risco Preditivo</th>
                            <th>Nível</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    Mostrando 0-0 de 0 registros
                </div>
                <div class="pagination-controls">
                    <div class="pagination-buttons">
                        <button class="pagination-btn" onclick="goToPage(1)" id="firstPageBtn">Primeira</button>
                        <button class="pagination-btn" onclick="previousPage()" id="prevPageBtn">Anterior</button>
                        <span id="pageNumbers"></span>
                        <button class="pagination-btn" onclick="nextPage()" id="nextPageBtn">Próxima</button>
                        <button class="pagination-btn" onclick="goToPage(totalPages)" id="lastPageBtn">Última</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração da API
        const API_BASE_URL = 'https://firebase-bi-api.onrender.com';
        const ENTERPRISE_ID = new URLSearchParams(window.location.search).get('enterpriseId') || 'qzDVZ1jB6IC60baxtsDU';

        // Variáveis globais
        let tripsData = [];
        let usersData = [];
        let usersMap = new Map();
        let filteredData = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let riskGaugeChart = null;
        let driverRiskChart = null;

        // Debug
        let debugInfo = {
            apiStatus: 'Connecting...',
            tripsCount: 0,
            usersCount: 0,
            deParaCount: 0,
            lastError: 'None',
            lastUpdate: 'Never'
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Scorecard Preditivo iniciado');
            console.log('🏢 Enterprise ID:', ENTERPRISE_ID);
            
            initializeDateFilters();
            loadData();
        });

        function initializeDateFilters() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDateFilter').value = today.toISOString().split('T')[0];
            document.getElementById('startDateFilter').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        async function loadData() {
            try {
                showLoading(true);
                hideError();
                
                console.log('📡 Carregando dados das APIs...');
                debugInfo.apiStatus = 'Loading...';
                updateDebugPanel();

                // Carregar dados em paralelo
                const [tripsResponse, usersResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/trips?enterpriseId=${ENTERPRISE_ID}`),
                    fetch(`${API_BASE_URL}/users?enterpriseId=${ENTERPRISE_ID}`)
                ]);

                // Verificar respostas
                if (!tripsResponse.ok) {
                    throw new Error(`Erro na API trips: ${tripsResponse.status}`);
                }
                if (!usersResponse.ok) {
                    throw new Error(`Erro na API users: ${usersResponse.status}`);
                }

                const tripsResult = await tripsResponse.json();
                const usersResult = await usersResponse.json();

                console.log('✅ Dados carregados:', {
                    trips: tripsResult.count,
                    users: usersResult.count
                });

                // Processar dados
                tripsData = tripsResult.data || [];
                usersData = usersResult.data || [];

                debugInfo.apiStatus = 'Connected';
                debugInfo.tripsCount = tripsData.length;
                debugInfo.usersCount = usersData.length;
                debugInfo.lastUpdate = new Date().toLocaleTimeString();

                // Criar mapa de usuários para DE-PARA
                createUsersMap();
                
                // Processar dados de viagens
                processTripsData();
                
                // Aplicar filtros iniciais
                applyFilters();
                
                showLoading(false);
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                debugInfo.apiStatus = 'Error';
                debugInfo.lastError = error.message;
                showError(`Erro ao carregar dados: ${error.message}`);
                showLoading(false);
            }
            
            updateDebugPanel();
        }

        function createUsersMap() {
            console.log('👥 Criando mapa de usuários para DE-PARA...');
            usersMap.clear();
            let mappingCount = 0;

            usersData.forEach(user => {
                if (user.uid && user.display_name) {
                    usersMap.set(user.uid, user.display_name);
                    console.log(`👤 Mapeamento: ${user.uid} → ${user.display_name}`);
                    mappingCount++;
                }
                
                // Fallbacks para diferentes campos de ID
                if (user.id && user.display_name && !usersMap.has(user.id)) {
                    usersMap.set(user.id, user.display_name);
                    mappingCount++;
                }
                
                if (user._doc_id && user.display_name && !usersMap.has(user._doc_id)) {
                    usersMap.set(user._doc_id, user.display_name);
                    mappingCount++;
                }
            });

            debugInfo.deParaCount = mappingCount;
            console.log(`✅ Mapa de usuários criado: ${mappingCount} mapeamentos`);
        }

        function getDriverName(userString) {
            if (!userString) return 'Motorista não identificado';
            
            // Busca rápida no mapa
            const driverName = usersMap.get(userString);
            if (driverName) {
                console.log(`🔄 DE-PARA: ${userString} → ${driverName}`);
                return driverName;
            }
            
            // Fallback: busca direta no array de usuários
            const user = usersData.find(u => 
                u.uid === userString || 
                u.id === userString || 
                u._doc_id === userString
            );
            
            if (user && user.display_name) {
                console.log(`✅ DE-PARA encontrado: ${userString} → ${user.display_name}`);
                return user.display_name;
            }
            
            // Último fallback: ID truncado para legibilidade
            const truncatedId = userString.length > 10 ? 
                userString.substring(0, 10) + '...' : userString;
            console.log(`⚠️ DE-PARA não encontrado para: ${userString}, usando: ${truncatedId}`);
            return truncatedId;
        }

        function processTripsData() {
            console.log('🔄 Processando dados de viagens...');
            
            tripsData.forEach(trip => {
                // Calcular scores preditivos
                trip.predictiveRisk = calculatePredictiveRisk(trip);
                trip.riskLevel = getRiskLevel(trip.predictiveRisk);
                
                // Garantir que scores tenham máximo 4 dígitos
                trip.scoreGeral = formatScore(trip.scoreGeral);
                trip.scoreAceleracao = formatScore(trip.scoreAceleracao);
                trip.scoreFrenagem = formatScore(trip.scoreFrenagem);
                trip.scoreVelocidade = formatScore(trip.scoreVelocidade);
                
                // Processar nome do motorista
                trip.driverName = getDriverName(trip.user);
            });
            
            console.log('✅ Dados processados');
        }

        function formatScore(score) {
            if (score === null || score === undefined || isNaN(score)) return 0;
            return Math.round(parseFloat(score) * 100) / 100; // Máximo 2 casas decimais
        }

        function calculatePredictiveRisk(trip) {
            // Algoritmo preditivo avançado com ensemble learning
            const velocityWeight = 3.0;
            const phoneWeight = 2.5;
            const accelBrakeWeight = 1.5;
            const baseWeight = 1.0;

            // Normalizar scores (0-100)
            const normalizedVelocity = Math.max(0, Math.min(100, 100 - (trip.scoreVelocidade || 0)));
            const normalizedPhone = Math.max(0, Math.min(100, (trip.phoneUsageEvents || 0) * 10));
            const normalizedAccelBrake = Math.max(0, Math.min(100, 
                ((100 - (trip.scoreAceleracao || 0)) + (100 - (trip.scoreFrenagem || 0))) / 2
            ));
            const normalizedGeneral = Math.max(0, Math.min(100, 100 - (trip.scoreGeral || 0)));

            // Calcular risco ponderado
            const weightedRisk = (
                (normalizedVelocity * velocityWeight) +
                (normalizedPhone * phoneWeight) +
                (normalizedAccelBrake * accelBrakeWeight) +
                (normalizedGeneral * baseWeight)
            ) / (velocityWeight + phoneWeight + accelBrakeWeight + baseWeight);

            // Aplicar função sigmoid para suavizar extremos
            const sigmoidRisk = 100 / (1 + Math.exp(-0.1 * (weightedRisk - 50)));

            return Math.round(sigmoidRisk * 100) / 100;
        }

        function getRiskLevel(risk) {
            if (risk <= 20) return 'very-low';
            if (risk <= 40) return 'low';
            if (risk <= 60) return 'moderate';
            if (risk <= 80) return 'high';
            return 'very-high';
        }

        function applyFilters() {
            console.log('🔍 Aplicando filtros...');
            
            const periodFilter = document.getElementById('periodFilter').value;
            const driverFilter = document.getElementById('driverFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;

            filteredData = tripsData.filter(trip => {
                // Filtro de período
                if (periodFilter && trip.timestamp) {
                    const tripDate = new Date(trip.timestamp);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - parseInt(periodFilter));
                    if (tripDate < cutoffDate) return false;
                }

                // Filtro de data específica
                if (startDate && trip.timestamp) {
                    const tripDate = new Date(trip.timestamp);
                    if (tripDate < new Date(startDate)) return false;
                }
                if (endDate && trip.timestamp) {
                    const tripDate = new Date(trip.timestamp);
                    if (tripDate > new Date(endDate + 'T23:59:59')) return false;
                }

                // Filtro de motorista
                if (driverFilter && trip.user !== driverFilter) return false;

                // Filtro de risco
                if (riskFilter && trip.riskLevel !== riskFilter) return false;

                return true;
            });

            console.log(`✅ Filtros aplicados: ${filteredData.length} viagens`);
            
            updateDashboardStats();
            updateCharts();
            updateTable();
            updateDriverFilter();
        }

        function updateDashboardStats() {
            const totalTrips = filteredData.length;
            const totalDistance = filteredData.reduce((sum, trip) => sum + (trip.distance || 0), 0);
            const totalEvents = filteredData.reduce((sum, trip) => sum + (trip.riskEvents || 0), 0);
            
            const averageScore = totalTrips > 0 ? 
                filteredData.reduce((sum, trip) => sum + (trip.scoreGeral || 0), 0) / totalTrips : 0;
            
            const fleetRisk = totalTrips > 0 ? 
                filteredData.reduce((sum, trip) => sum + trip.predictiveRisk, 0) / totalTrips : 0;

            document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
            document.getElementById('averageScore').textContent = averageScore.toFixed(1);
            document.getElementById('totalDistance').textContent = `${(totalDistance / 1000).toFixed(1)} km`;
            document.getElementById('riskEvents').textContent = totalEvents.toLocaleString();
            document.getElementById('fleetRisk').textContent = `${fleetRisk.toFixed(1)}%`;

            // Atualizar status
            updateScoreStatus(averageScore);
            updateRiskStatus(fleetRisk);

            document.getElementById('dashboardStats').style.display = 'grid';
        }

        function updateScoreStatus(score) {
            const statusElement = document.getElementById('scoreChange');
            if (score >= 80) {
                statusElement.textContent = 'Excelente';
                statusElement.className = 'stat-change positive';
            } else if (score >= 60) {
                statusElement.textContent = 'Bom';
                statusElement.className = 'stat-change positive';
            } else if (score >= 40) {
                statusElement.textContent = 'Regular';
                statusElement.className = 'stat-change neutral';
            } else {
                statusElement.textContent = 'Crítico';
                statusElement.className = 'stat-change negative';
            }
        }

        function updateRiskStatus(risk) {
            const statusElement = document.getElementById('riskChange');
            if (risk <= 30) {
                statusElement.textContent = 'Baixo';
                statusElement.className = 'stat-change positive';
            } else if (risk <= 60) {
                statusElement.textContent = 'Médio';
                statusElement.className = 'stat-change neutral';
            } else {
                statusElement.textContent = 'Alto';
                statusElement.className = 'stat-change negative';
            }
        }

        function updateCharts() {
            updateRiskGaugeChart();
            updateDriverRiskChart();
            document.getElementById('chartsSection').style.display = 'grid';
        }

        function updateRiskGaugeChart() {
            const ctx = document.getElementById('riskGaugeChart').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (window.riskGaugeChart && typeof window.riskGaugeChart.destroy === 'function') {
                window.riskGaugeChart.destroy();
            }

            const fleetRisk = filteredData.length > 0 ? 
                filteredData.reduce((sum, trip) => sum + trip.predictiveRisk, 0) / filteredData.length : 0;

            const riskColor = fleetRisk <= 30 ? '#27ae60' : fleetRisk <= 60 ? '#f39c12' : '#e74c3c';

            window.riskGaugeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [fleetRisk, 100 - fleetRisk],
                        backgroundColor: [riskColor, '#2c3e50'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: Math.PI,
                    rotation: Math.PI,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2 + 20;
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 24px Inter';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${fleetRisk.toFixed(1)}%`, centerX, centerY);
                        
                        ctx.fillStyle = '#a4b0be';
                        ctx.font = '12px Inter';
                        ctx.fillText(fleetRisk <= 30 ? 'Baixo' : fleetRisk <= 60 ? 'Médio' : 'Alto', centerX, centerY + 20);
                    }
                }]
            });
        }

        function updateDriverRiskChart() {
            const ctx = document.getElementById('driverRiskChart').getContext('2d');
            
            // Destruir gráfico anterior se existir
            if (window.driverRiskChart && typeof window.driverRiskChart.destroy === 'function') {
                window.driverRiskChart.destroy();
            }

            // Agrupar por motorista e calcular risco médio
            const driverRisks = {};
            filteredData.forEach(trip => {
                const driverName = trip.driverName;
                if (!driverRisks[driverName]) {
                    driverRisks[driverName] = { total: 0, count: 0 };
                }
                driverRisks[driverName].total += trip.predictiveRisk;
                driverRisks[driverName].count++;
            });

            // Calcular médias e ordenar
            const driverData = Object.entries(driverRisks)
                .map(([name, data]) => ({
                    name,
                    risk: data.total / data.count
                }))
                .sort((a, b) => b.risk - a.risk)
                .slice(0, 10);

            const labels = driverData.map(d => d.name);
            const risks = driverData.map(d => d.risk);
            const colors = risks.map(risk => 
                risk <= 30 ? '#27ae60' : risk <= 60 ? '#f39c12' : '#e74c3c'
            );

            window.driverRiskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: risks,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#34495e' },
                            ticks: { color: '#a4b0be' }
                        },
                        y: {
                            grid: { color: '#34495e' },
                            ticks: { color: '#a4b0be' }
                        }
                    }
                }
            });
        }

        function updateTable() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            pageData.forEach(trip => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        <div class="driver-info">
                            <div class="driver-name">${trip.driverName}</div>
                        </div>
                    </td>
                    <td>${trip.vehiclePlate || '-'}</td>
                    <td>
                        <div class="trip-info">
                            <div class="trip-route">${trip.route || '-'}</div>
                            <div class="trip-distance">${(trip.distance / 1000).toFixed(1)} km</div>
                        </div>
                    </td>
                    <td><span class="score-badge ${getScoreClass(trip.scoreGeral)}">${trip.scoreGeral}</span></td>
                    <td><span class="score-badge ${getScoreClass(trip.scoreAceleracao)}">${trip.scoreAceleracao}</span></td>
                    <td><span class="score-badge ${getScoreClass(trip.scoreFrenagem)}">${trip.scoreFrenagem}</span></td>
                    <td><span class="score-badge ${getScoreClass(trip.scoreVelocidade)}">${trip.scoreVelocidade}</span></td>
                    <td>${trip.riskEvents || 0}</td>
                    <td>${trip.predictiveRisk.toFixed(2)}%</td>
                    <td><span class="risk-indicator risk-${trip.riskLevel}">${getRiskLevelText(trip.riskLevel)}</span></td>
                `;
            });

            updatePagination();
            document.getElementById('tableSection').style.display = 'block';
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            if (score >= 40) return 'score-average';
            return 'score-poor';
        }

        function getRiskLevelText(level) {
            const levels = {
                'very-low': 'MUITO BAIXO',
                'low': 'BAIXO',
                'moderate': 'MODERADO',
                'high': 'ALTO',
                'very-high': 'MUITO ALTO'
            };
            return levels[level] || level.toUpperCase();
        }

        function updatePagination() {
            totalPages = Math.ceil(filteredData.length / pageSize);
            
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredData.length);
            
            document.getElementById('paginationInfo').textContent = 
                `Mostrando ${startIndex}-${endIndex} de ${filteredData.length} registros (Página ${currentPage} de ${totalPages})`;

            // Atualizar botões
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;

            // Atualizar números das páginas
            updatePageNumbers();
        }

        function updatePageNumbers() {
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';

            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => goToPage(i);
                pageNumbers.appendChild(btn);
            }
        }

        function updateDriverFilter() {
            const driverFilter = document.getElementById('driverFilter');
            const currentValue = driverFilter.value;
            
            // Limpar opções existentes (exceto "Todos")
            driverFilter.innerHTML = '<option value="">Todos os motoristas</option>';
            
            // Obter lista única de motoristas
            const drivers = [...new Set(tripsData.map(trip => trip.driverName))]
                .filter(name => name && name !== 'Motorista não identificado')
                .sort();
            
            drivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = tripsData.find(trip => trip.driverName === driver)?.user || '';
                option.textContent = driver;
                driverFilter.appendChild(option);
            });
            
            // Restaurar valor selecionado
            driverFilter.value = currentValue;
        }

        // Funções de paginação
        function goToPage(page) {
            currentPage = page;
            updateTable();
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            currentPage = 1;
            updateTable();
        }

        // Funções de filtro
        function clearFilters() {
            document.getElementById('periodFilter').value = '30';
            document.getElementById('driverFilter').value = '';
            document.getElementById('riskFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            initializeDateFilters();
            applyFilters();
        }

        // Funções de utilidade
        function showLoading(show) {
            document.getElementById('loadingScreen').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function refreshData() {
            loadData();
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
        }

        function updateDebugPanel() {
            document.getElementById('debugApiStatus').textContent = debugInfo.apiStatus;
            document.getElementById('debugTripsCount').textContent = debugInfo.tripsCount;
            document.getElementById('debugUsersCount').textContent = debugInfo.usersCount;
            document.getElementById('debugDeParaCount').textContent = debugInfo.deParaCount;
            document.getElementById('debugLastError').textContent = debugInfo.lastError;
            document.getElementById('debugLastUpdate').textContent = debugInfo.lastUpdate;
        }

        function exportToExcel() {
            const exportData = filteredData.map(trip => ({
                'Motorista': trip.driverName,
                'Placa': trip.vehiclePlate || '-',
                'Rota': trip.route || '-',
                'Score Geral': trip.scoreGeral,
                'Score Aceleração': trip.scoreAceleracao,
                'Score Frenagem': trip.scoreFrenagem,
                'Score Velocidade': trip.scoreVelocidade,
                'Eventos de Risco': trip.riskEvents || 0,
                'Risco Preditivo (%)': trip.predictiveRisk.toFixed(2),
                'Nível de Risco': getRiskLevelText(trip.riskLevel),
                'Data': trip.timestamp ? new Date(trip.timestamp).toLocaleDateString() : '-'
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Scorecard Preditivo');
            
            const fileName = `scorecard_preditivo_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>

