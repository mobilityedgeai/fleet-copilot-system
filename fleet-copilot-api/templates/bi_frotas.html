<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Frotas Agregadas/Spot - Fleet Copilot</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #14b8a6;
            --primary-dark: #0f766e;
            --background: #0a0a0a;
            --surface: #1a1a1a;
            --surface-light: #2a2a2a;
            --surface-lighter: #333333;
            --text: #ffffff;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #333333;
            --border-light: #444444;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header svg {
            width: 32px;
            height: 32px;
            color: var(--primary);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-button {
            padding: 12px 24px;
            background: var(--surface);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            background: var(--surface-light);
            color: var(--text);
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(20, 184, 166, 0.3);
        }

        .panel {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(20, 184, 166, 0.05);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(20, 184, 166, 0.1);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            opacity: 0.8;
        }

        .metric-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
            line-height: 1;
            margin-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--primary);
        }

        tr:hover {
            background: var(--surface-light);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(20, 184, 166, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1 1 auto;
                text-align: center;
                padding: 10px;
                font-size: 13px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            <h1>BI Frotas Agregadas/Spot</h1>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-button active" onclick="showPanel('performance')">Performance Operacional</button>
            <button class="tab-button" onclick="showPanel('timing')">Tempo e Roteirização</button>
            <button class="tab-button" onclick="showPanel('audit')">Auditoria de Entrega</button>
        </div>

        <!-- Painel 1: Performance Operacional -->
        <div id="panel-performance" class="panel active">
            <h2>Performance Operacional</h2>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">SLA de Entrega</div>
                    <div class="metric-value" id="slaEntrega">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Cumprimento de Rotas</div>
                    <div class="metric-value" id="cumprimentoRotas">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Custo por Entrega</div>
                    <div class="metric-value" id="custoEntrega">R$ 0,00</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Total de Entregas</div>
                    <div class="metric-value" id="totalEntregas">0</div>
                </div>
            </div>
            
            <h3>Eficiência por Transportadora</h3>
            <table id="carrierTable">
                <thead>
                    <tr>
                        <th>Transportadora</th>
                        <th>Total Entregas</th>
                        <th>SLA</th>
                        <th>Custo Médio</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>

        <!-- Painel 2: Tempo e Roteirização -->
        <div id="panel-timing" class="panel">
            <h2>Tempo e Roteirização</h2>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Tempo Médio nos CDs</div>
                    <div class="metric-value" id="tempoMedioCd">0min</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Tempo Médio de Viagem</div>
                    <div class="metric-value" id="tempoMedioViagem">0min</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Percentual de Atrasos</div>
                    <div class="metric-value" id="percentualAtrasos">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Desvios de Rota</div>
                    <div class="metric-value" id="desviosRota">0%</div>
                </div>
            </div>
            
            <h3>Tempos por Motorista</h3>
            <table id="driverTimeTable">
                <thead>
                    <tr>
                        <th>Motorista</th>
                        <th>Transportadora</th>
                        <th>Tempo CD</th>
                        <th>Tempo Viagem</th>
                        <th>% Atrasos</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>

        <!-- Painel 3: Auditoria de Entrega -->
        <div id="panel-audit" class="panel">
            <h2>Auditoria de Entrega</h2>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Entregas com POD</div>
                    <div class="metric-value" id="entregasComPod">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Falhas no Registro</div>
                    <div class="metric-value" id="falhasRegistro">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Divergências Geo</div>
                    <div class="metric-value" id="divergenciasGeo">0%</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Tentativas Frustradas</div>
                    <div class="metric-value" id="tentativasFrustradas">0%</div>
                </div>
            </div>
            
            <h3>Falhas por Motorista</h3>
            <table id="driverFailureTable">
                <thead>
                    <tr>
                        <th>Motorista</th>
                        <th>Transportadora</th>
                        <th>Total</th>
                        <th>% com POD</th>
                        <th>% Falhas</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Carregando dados...</p>
    </div>

    <script>
        // Dados mockados diretamente no HTML
        const MOCK_DATA = {
            data: [
                {
                    id: "ENT-000001",
                    transportadora: "LogExpress",
                    motorista: "Motorista 1 - LogExpress",
                    cidade: "São Paulo",
                    regiao: "Sudeste",
                    tipoEntrega: "Express",
                    rota: "Rota-001",
                    dataEntregaPlanejada: "2025-05-01T14:30:00.000Z",
                    entregaRealizada: true,
                    dataEntregaRealizada: "2025-05-01T14:45:00.000Z",
                    tempoCD: 45,
                    tempoViagem: 120,
                    tempoOcioso: 15,
                    atraso: 15,
                    desvioRota: false,
                    antecipada: false,
                    comPOD: true,
                    falhaRegistro: false,
                    divergenciaGeo: false,
                    tentativaFrustrada: false,
                    rejeicao: false,
                    motivoRejeicao: null,
                    tempoEvidencia: 10,
                    distanciaKm: 15,
                    custoKm: 3.5,
                    custo: 52.5
                },
                {
                    id: "ENT-000002",
                    transportadora: "FastTruck",
                    motorista: "Motorista 1 - FastTruck",
                    cidade: "Rio de Janeiro",
                    regiao: "Sudeste",
                    tipoEntrega: "Standard",
                    rota: "Rota-002",
                    dataEntregaPlanejada: "2025-05-02T10:00:00.000Z",
                    entregaRealizada: true,
                    dataEntregaRealizada: "2025-05-02T09:30:00.000Z",
                    tempoCD: 30,
                    tempoViagem: 90,
                    tempoOcioso: 0,
                    atraso: -30,
                    desvioRota: false,
                    antecipada: true,
                    comPOD: true,
                    falhaRegistro: false,
                    divergenciaGeo: false,
                    tentativaFrustrada: false,
                    rejeicao: false,
                    motivoRejeicao: null,
                    tempoEvidencia: 5,
                    distanciaKm: 12,
                    custoKm: 4.0,
                    custo: 48.0
                },
                {
                    id: "ENT-000003",
                    transportadora: "SpeedLog",
                    motorista: "Motorista 1 - SpeedLog",
                    cidade: "Belo Horizonte",
                    regiao: "Sudeste",
                    tipoEntrega: "Express",
                    rota: "Rota-003",
                    dataEntregaPlanejada: "2025-05-03T15:00:00.000Z",
                    entregaRealizada: true,
                    dataEntregaRealizada: "2025-05-03T16:30:00.000Z",
                    tempoCD: 60,
                    tempoViagem: 150,
                    tempoOcioso: 30,
                    atraso: 90,
                    desvioRota: true,
                    antecipada: false,
                    comPOD: false,
                    falhaRegistro: true,
                    divergenciaGeo: true,
                    tentativaFrustrada: false,
                    rejeicao: false,
                    motivoRejeicao: null,
                    tempoEvidencia: null,
                    distanciaKm: 20,
                    custoKm: 3.8,
                    custo: 76.0
                },
                {
                    id: "ENT-000004",
                    transportadora: "TransMaster",
                    motorista: "Motorista 1 - TransMaster",
                    cidade: "Curitiba",
                    regiao: "Sul",
                    tipoEntrega: "Next Day",
                    rota: "Rota-004",
                    dataEntregaPlanejada: "2025-05-04T11:00:00.000Z",
                    entregaRealizada: false,
                    dataEntregaRealizada: null,
                    tempoCD: null,
                    tempoViagem: null,
                    tempoOcioso: null,
                    atraso: null,
                    desvioRota: null,
                    antecipada: null,
                    comPOD: null,
                    falhaRegistro: null,
                    divergenciaGeo: null,
                    tentativaFrustrada: true,
                    rejeicao: null,
                    motivoRejeicao: "Cliente ausente",
                    tempoEvidencia: null,
                    distanciaKm: null,
                    custoKm: null,
                    custo: null
                },
                {
                    id: "ENT-000005",
                    transportadora: "LogExpress",
                    motorista: "Motorista 2 - LogExpress",
                    cidade: "São Paulo",
                    regiao: "Sudeste",
                    tipoEntrega: "Same Day",
                    rota: "Rota-001",
                    dataEntregaPlanejada: "2025-05-05T16:00:00.000Z",
                    entregaRealizada: true,
                    dataEntregaRealizada: "2025-05-05T16:10:00.000Z",
                    tempoCD: 40,
                    tempoViagem: 110,
                    tempoOcioso: 10,
                    atraso: 10,
                    desvioRota: false,
                    antecipada: false,
                    comPOD: true,
                    falhaRegistro: false,
                    divergenciaGeo: false,
                    tentativaFrustrada: false,
                    rejeicao: false,
                    motivoRejeicao: null,
                    tempoEvidencia: 8,
                    distanciaKm: 14,
                    custoKm: 3.5,
                    custo: 49.0
                }
            ]
        };

        // Variáveis globais
        let allData = [];
        let filteredData = [];
        let currentPanel = 'performance';

        // Função para mostrar um painel específico
        function showPanel(panelId) {
            // Ocultar todos os painéis
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Desativar todos os botões de abas
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Mostrar o painel selecionado
            document.getElementById('panel-' + panelId).classList.add('active');
            
            // Ativar o botão da aba selecionada
            document.querySelector(`.tab-button[onclick="showPanel('${panelId}')"]`).classList.add('active');
            
            // Atualizar o painel atual
            currentPanel = panelId;
            
            // Atualizar o painel selecionado
            updatePanel(panelId);
        }

        // Função para mostrar o overlay de carregamento
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // Função para ocultar o overlay de carregamento
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Função para carregar os dados
        function loadData() {
            showLoading();
            
            try {
                // Em produção, isso seria substituído pela chamada à API Firebase
                // const enterpriseId = getEnterpriseIdFromURL();
                // const apiUrl = `/api/frotas?enterpriseId=${enterpriseId}`;
                // const response = await fetch(apiUrl);
                // const result = await response.json();
                // allData = result.data;
                
                // Por enquanto, vamos carregar os dados mockados
                allData = MOCK_DATA.data;
                filteredData = allData;
                
                console.log(`✅ ${allData.length} registros carregados com sucesso`);
                
                // Atualizar todos os painéis
                updateAllPanels();
                
                hideLoading();
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                hideLoading();
                
                // Mostrar mensagem de erro
                alert('Erro ao carregar dados. Por favor, tente novamente.');
            }
        }

        // Função para atualizar todos os painéis
        function updateAllPanels() {
            updatePerformancePanel();
            updateTimingPanel();
            updateAuditPanel();
        }

        // Função para atualizar um painel específico
        function updatePanel(panelId) {
            switch (panelId) {
                case 'performance':
                    updatePerformancePanel();
                    break;
                case 'timing':
                    updateTimingPanel();
                    break;
                case 'audit':
                    updateAuditPanel();
                    break;
            }
        }

        // Função para atualizar o painel de Performance Operacional
        function updatePerformancePanel() {
            if (!filteredData || filteredData.length === 0) {
                console.warn('Sem dados para atualizar o painel de Performance Operacional');
                return;
            }
            
            // Calcular métricas
            const totalEntregas = filteredData.length;
            const entregasRealizadas = filteredData.filter(item => item.entregaRealizada).length;
            
            // SLA de Entrega (% no prazo)
            const entregasNoPrazo = filteredData.filter(item => 
                item.entregaRealizada && (!item.atraso || item.atraso <= 0)
            ).length;
            const slaEntrega = entregasRealizadas > 0 ? entregasNoPrazo / entregasRealizadas : 0;
            
            // Cumprimento de Rotas (% sem desvio)
            const rotasCumpridas = filteredData.filter(item => 
                item.entregaRealizada && !item.desvioRota
            ).length;
            const cumprimentoRotas = entregasRealizadas > 0 ? rotasCumpridas / entregasRealizadas : 0;
            
            // Custo por Entrega
            const custoTotal = filteredData.reduce((sum, item) => sum + (item.custo || 0), 0);
            const custoEntrega = entregasRealizadas > 0 ? custoTotal / entregasRealizadas : 0;
            
            // Atualizar os valores nos cards
            document.getElementById('slaEntrega').textContent = formatPercent(slaEntrega);
            document.getElementById('cumprimentoRotas').textContent = formatPercent(cumprimentoRotas);
            document.getElementById('custoEntrega').textContent = formatCurrency(custoEntrega);
            document.getElementById('totalEntregas').textContent = formatNumber(totalEntregas);
            
            // Preencher tabela de transportadoras
            updateCarrierTable();
        }
        
        // Função para atualizar a tabela de transportadoras
        function updateCarrierTable() {
            const tableBody = document.querySelector('#carrierTable tbody');
            tableBody.innerHTML = '';
            
            // Agrupar por transportadora
            const transportadoraData = {};
            
            filteredData.forEach(item => {
                if (!transportadoraData[item.transportadora]) {
                    transportadoraData[item.transportadora] = {
                        totalEntregas: 0,
                        entregasNoPrazo: 0,
                        custoTotal: 0,
                        entregasRealizadas: 0
                    };
                }
                
                const data = transportadoraData[item.transportadora];
                data.totalEntregas++;
                
                if (item.entregaRealizada) {
                    data.entregasRealizadas++;
                    
                    if (!item.atraso || item.atraso <= 0) {
                        data.entregasNoPrazo++;
                    }
                    
                    data.custoTotal += item.custo || 0;
                }
            });
            
            // Criar linhas da tabela
            Object.entries(transportadoraData).forEach(([transportadora, data]) => {
                const sla = data.entregasRealizadas > 0 ? data.entregasNoPrazo / data.entregasRealizadas : 0;
                const custoMedio = data.entregasRealizadas > 0 ? data.custoTotal / data.entregasRealizadas : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transportadora}</td>
                    <td>${formatNumber(data.totalEntregas)}</td>
                    <td>${formatPercent(sla)}</td>
                    <td>${formatCurrency(custoMedio)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Função para atualizar o painel de Tempo e Roteirização
        function updateTimingPanel() {
            if (!filteredData || filteredData.length === 0) {
                console.warn('Sem dados para atualizar o painel de Tempo e Roteirização');
                return;
            }
            
            // Filtrar apenas entregas realizadas
            const entregasRealizadas = filteredData.filter(item => item.entregaRealizada);
            
            if (entregasRealizadas.length === 0) {
                console.warn('Sem entregas realizadas para atualizar o painel de Tempo e Roteirização');
                return;
            }
            
            // Calcular métricas
            // Tempo Médio nos CDs
            const tempoTotalCD = entregasRealizadas.reduce((sum, item) => sum + (item.tempoCD || 0), 0);
            const tempoMedioCd = entregasRealizadas.length > 0 ? tempoTotalCD / entregasRealizadas.length : 0;
            
            // Tempo Médio de Viagem
            const tempoTotalViagem = entregasRealizadas.reduce((sum, item) => sum + (item.tempoViagem || 0), 0);
            const tempoMedioViagem = entregasRealizadas.length > 0 ? tempoTotalViagem / entregasRealizadas.length : 0;
            
            // Percentual de Atrasos
            const entregasAtrasadas = entregasRealizadas.filter(item => item.atraso && item.atraso > 0).length;
            const percentualAtrasos = entregasRealizadas.length > 0 ? entregasAtrasadas / entregasRealizadas.length : 0;
            
            // Desvios de Rota
            const entregasComDesvio = entregasRealizadas.filter(item => item.desvioRota).length;
            const desviosRota = entregasRealizadas.length > 0 ? entregasComDesvio / entregasRealizadas.length : 0;
            
            // Atualizar os valores nos cards
            document.getElementById('tempoMedioCd').textContent = formatTime(tempoMedioCd);
            document.getElementById('tempoMedioViagem').textContent = formatTime(tempoMedioViagem);
            document.getElementById('percentualAtrasos').textContent = formatPercent(percentualAtrasos);
            document.getElementById('desviosRota').textContent = formatPercent(desviosRota);
            
            // Preencher tabela de motoristas
            updateDriverTimeTable();
        }
        
        // Função para atualizar a tabela de tempos por motorista
        function updateDriverTimeTable() {
            const tableBody = document.querySelector('#driverTimeTable tbody');
            tableBody.innerHTML = '';
            
            // Agrupar por motorista
            const motoristaData = {};
            
            filteredData.forEach(item => {
                if (!item.entregaRealizada) return;
                
                if (!motoristaData[item.motorista]) {
                    motoristaData[item.motorista] = {
                        transportadora: item.transportadora,
                        totalEntregas: 0,
                        tempoTotalCD: 0,
                        tempoTotalViagem: 0,
                        entregasAtrasadas: 0
                    };
                }
                
                const data = motoristaData[item.motorista];
                data.totalEntregas++;
                data.tempoTotalCD += item.tempoCD || 0;
                data.tempoTotalViagem += item.tempoViagem || 0;
                
                if (item.atraso && item.atraso > 0) {
                    data.entregasAtrasadas++;
                }
            });
            
            // Criar linhas da tabela
            Object.entries(motoristaData).forEach(([motorista, data]) => {
                const tempoMedioCd = data.totalEntregas > 0 ? data.tempoTotalCD / data.totalEntregas : 0;
                const tempoMedioViagem = data.totalEntregas > 0 ? data.tempoTotalViagem / data.totalEntregas : 0;
                const percentualAtrasos = data.totalEntregas > 0 ? data.entregasAtrasadas / data.totalEntregas : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${motorista}</td>
                    <td>${data.transportadora}</td>
                    <td>${formatTime(tempoMedioCd)}</td>
                    <td>${formatTime(tempoMedioViagem)}</td>
                    <td>${formatPercent(percentualAtrasos)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Função para atualizar o painel de Auditoria de Entrega
        function updateAuditPanel() {
            if (!filteredData || filteredData.length === 0) {
                console.warn('Sem dados para atualizar o painel de Auditoria de Entrega');
                return;
            }
            
            // Filtrar apenas entregas realizadas
            const entregasRealizadas = filteredData.filter(item => item.entregaRealizada);
            
            if (entregasRealizadas.length === 0) {
                console.warn('Sem entregas realizadas para atualizar o painel de Auditoria de Entrega');
                return;
            }
            
            // Calcular métricas
            // Entregas com POD
            const entregasComPod = entregasRealizadas.filter(item => item.comPOD).length;
            const percentualComPod = entregasRealizadas.length > 0 ? entregasComPod / entregasRealizadas.length : 0;
            
            // Falhas no Registro
            const entregasComFalha = entregasRealizadas.filter(item => item.falhaRegistro).length;
            const percentualFalhas = entregasRealizadas.length > 0 ? entregasComFalha / entregasRealizadas.length : 0;
            
            // Divergências de Geo
            const entregasComDivergencia = entregasRealizadas.filter(item => item.divergenciaGeo).length;
            const percentualDivergencias = entregasRealizadas.length > 0 ? entregasComDivergencia / entregasRealizadas.length : 0;
            
            // Tentativas Frustradas
            const tentativasFrustradas = filteredData.filter(item => item.tentativaFrustrada).length;
            const percentualFrustradas = filteredData.length > 0 ? tentativasFrustradas / filteredData.length : 0;
            
            // Atualizar os valores nos cards
            document.getElementById('entregasComPod').textContent = formatPercent(percentualComPod);
            document.getElementById('falhasRegistro').textContent = formatPercent(percentualFalhas);
            document.getElementById('divergenciasGeo').textContent = formatPercent(percentualDivergencias);
            document.getElementById('tentativasFrustradas').textContent = formatPercent(percentualFrustradas);
            
            // Preencher tabela de falhas por motorista
            updateDriverFailureTable();
        }
        
        // Função para atualizar a tabela de falhas por motorista
        function updateDriverFailureTable() {
            const tableBody = document.querySelector('#driverFailureTable tbody');
            tableBody.innerHTML = '';
            
            // Agrupar por motorista
            const motoristaData = {};
            
            filteredData.forEach(item => {
                if (!motoristaData[item.motorista]) {
                    motoristaData[item.motorista] = {
                        transportadora: item.transportadora,
                        totalEntregas: 0,
                        entregasRealizadas: 0,
                        entregasComPod: 0,
                        entregasComFalha: 0
                    };
                }
                
                const data = motoristaData[item.motorista];
                data.totalEntregas++;
                
                if (item.entregaRealizada) {
                    data.entregasRealizadas++;
                    
                    if (item.comPOD) {
                        data.entregasComPod++;
                    }
                    
                    if (item.falhaRegistro) {
                        data.entregasComFalha++;
                    }
                }
            });
            
            // Criar linhas da tabela
            Object.entries(motoristaData).forEach(([motorista, data]) => {
                const percentualComPod = data.entregasRealizadas > 0 ? data.entregasComPod / data.entregasRealizadas : 0;
                const percentualFalhas = data.entregasRealizadas > 0 ? data.entregasComFalha / data.entregasRealizadas : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${motorista}</td>
                    <td>${data.transportadora}</td>
                    <td>${formatNumber(data.totalEntregas)}</td>
                    <td>${formatPercent(percentualComPod)}</td>
                    <td>${formatPercent(percentualFalhas)}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Função para obter o enterpriseId da URL
        function getEnterpriseIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const enterpriseId = urlParams.get('enterpriseId');
            return enterpriseId || 'qzDVZ1jB6IC60baxtsDU'; // ID padrão
        }

        // Função para formatar números
        function formatNumber(value, decimals = 0) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value || 0);
        }

        // Função para formatar valores monetários
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }

        // Função para formatar porcentagens
        function formatPercent(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value || 0);
        }

        // Função para formatar tempo em minutos para horas e minutos
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            
            if (hours > 0) {
                return `${hours}h ${mins}min`;
            } else {
                return `${mins}min`;
            }
        }

        // Inicializar quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar os dados mockados
            loadData();
        });
    </script>
</body>
</html>

